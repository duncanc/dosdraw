'use strict';(function(){function X(a){a-=179;return!Number.isInteger(a)||0>a||a>=na.length?0:na[a]}function S(a){return ra[a]||0}function ca(a,d,h,f,n,k,g){let [e,m]=a<h?[a,h]:[h,a],[w,u]=d<f?[d,f]:[f,d];a=g?32:0;g=g?16:0;if(w===u)if(e===m)k(e,w,S(15));else{k(e,w,S(X(n(e,w))&-33|8|a));for(g=e+1;g<m;g++)k(g,w,S(X(n(g,w))&-33|12|a));k(m,w,S(X(n(m,w))&-33|4|a))}else if(e===m){k(e,w,S(X(n(e,w))&-17|2|g));for(a=w+1;a<u;a++)k(e,a,S(X(n(e,a))&-17|3|g));k(e,u,S(X(n(e,u))&-17|1|g))}else{k(e,w,S(X(n(e,w))&
-49|10|a|g));for(d=e+1;d<m;d++)k(d,w,S(X(n(d,w))&-33|12|a));k(m,w,S(X(n(m,w))&-49|6|a|g));for(d=w+1;d<u;d++)k(e,d,S(X(n(e,d))&-17|3|g)),k(m,d,S(X(n(m,d))&-17|3|g));k(e,u,S(X(n(e,u))&-49|9|a|g));for(d=e+1;d<m;d++)k(d,u,S(X(n(d,u))&-33|12|a));k(m,u,S(X(n(m,u))&-49|5|g|a))}}function*ba(a,d,h,f){let n=Math.abs(h-a),k=Math.abs(f-d),g=a<h?1:-1,e=d<f?1:-1,m=n-k;for(;;){yield[a,d];if(a===h&&d===f)break;let w=2*m;w>-k&&(m-=k,a+=g);w<n&&(m+=n,d+=e)}}function*da(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);
if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(;a!==h+n;a+=n)yield[a,d];else for(;d!==f+k;d+=k)for(let g=a;g!==h+n;g+=n)yield[g,d]}function*oa(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(f=a;f!==h+n;f+=n)yield[f,d];else{for(let g=a;g!==h+n;g+=n)yield[g,d];for(d+=k;d!==f;d+=k)yield[a,d],yield[h,d];for(;a!==h+n;a+=n)yield[a,f]}}function sa(){return new Promise((a,d)=>{let h=document.createElement("input");
h.type="file";h.onchange=f=>{var n;(null===(n=h.files)||void 0===n?0:n.length)?a(h.files[0]):a(null)};h.click()})}function Q(a,d){let h=0;for(;a&d;){var f=Math.clz32(d);f=32-Math.clz32(~d<<f>>>f);f=d>>>f<<f;f&a&&(h|=f,a&=~f);d&=~f}return h}function ta(a,d,h,f,n,k,g){if(!(0>a||0>d||80<=a||25<=d)){var e=Math.floor(a%1*8),m=Math.floor(d%1*8);a=Math.floor(a);d=Math.floor(d);var {charCode:w,bgColor:u,fgColor:Z}=h(a,d);if(u===Z||32===w||255===w)w=0;var U=!!(n[w][m]&128>>>e),N=U?Z:u,E=[],K=U?0:255,F=U?0:
65535,O=Q(128>>>e,n[w][m]^K),M=Q(32768>>>m,k[w][e]^F);a:if(0!==d){var aa=O;for(let A=m-1;0<=A;A--)if(aa=Q(aa,n[w][A]^K),0===aa)break a;E.push({x:a,y:d-1,side:"bottom",mask:aa})}a:if(24!==d){for(m+=1;8>m;m++)if(O=Q(O,n[w][m]^K),0===O)break a;E.push({x:a,y:d+1,side:"top",mask:O})}a:if(0!==a){K=M;for(m=e-1;0<=m;m--)if(K=Q(K,k[w][m]^F),0===K)break a;E.push({x:a-1,y:d,side:"right",mask:K})}a:if(79!==a){for(e+=1;8>e;e++)if(M=Q(M,k[w][e]^F),0===M)break a;E.push({x:a+1,y:d,side:"left",mask:M})}U?f(a,d,w,
g,u):f(a,d,w,Z,g);for(a=new Set([`${a},${d}`]);0<E.length;){let {x:A,y:B,side:ea,mask:G}=E.pop(),{charCode:I,bgColor:V,fgColor:Y}=h(A,B);if(V!==N&&Y!==N||177===I||176===I&&V!==N||178===I&&Y!==N)a.add(`${A},${B}`);else{if(Y===V||32===I||255===I)I=0;d=V===N?255:0;U=V===N?65535:0;switch(ea){case "top":for(F=M=e=0;16>F;F++){G=Q(G,n[I][F]^d);if(0===G)break;G&128&&(e|=Q(1<<F,k[I][0]^U));G&1&&(M|=Q(1<<F,k[I][7]^U))}0<F&&(G&&24!==B&&!a.has(`${A},${B+1}`)&&E.push({x:A,y:B+1,side:"top",mask:G}),e&&0!==A&&!a.has(`${A-
1},${B}`)&&E.push({x:A-1,y:B,side:"right",mask:e}),M&&79!==A&&!a.has(`${A+1},${B}`)&&E.push({x:A+1,y:B,side:"left",mask:M}),V===N?f(A,B,I,Y,g):f(A,B,I,g,V),a.add(`${A},${B}`));break;case "bottom":M=e=0;for(F=15;0<=F;F--){G=Q(G,n[I][F]^d);if(0===G)break;G&128&&(e|=Q(1<<F,k[I][0]^U));G&1&&(M|=Q(1<<F,k[I][7]^U))}15>F&&(G&&0!==B&&!a.has(`${A},${B-1}`)&&E.push({x:A,y:B-1,side:"bottom",mask:G}),e&&0!==A&&!a.has(`${A-1},${B}`)&&E.push({x:A-1,y:B,side:"right",mask:e}),M&&79!==A&&!a.has(`${A+1},${B}`)&&E.push({x:A+
1,y:B,side:"left",mask:M}),V===N?f(A,B,I,Y,g):f(A,B,I,g,V),a.add(`${A},${B}`));break;case "left":for(F=M=e=0;8>F;F++){G=Q(G,k[I][F]^U);if(0===G)break;G&32768&&(M|=Q(128>>F,n[I][15]^d));G&1&&(e|=Q(128>>F,n[I][0]^d))}0<F&&(G&&79!==A&&!a.has(`${A+1},${B}`)&&E.push({x:A+1,y:B,side:"left",mask:G}),e&&0!==B&&!a.has(`${A},${B-1}`)&&E.push({x:A,y:B-1,side:"bottom",mask:e}),M&&24!==B&&!a.has(`${A},${B+1}`)&&E.push({x:A,y:B+1,side:"top",mask:M}),V===N?f(A,B,I,Y,g):f(A,B,I,g,V),a.add(`${A},${B}`));break;case "right":M=
e=0;for(F=7;0<=F;F--){G=Q(G,k[I][F]^U);if(0===G)break;G&32768&&(M|=Q(128>>F,n[I][15]^d));G&1&&(e|=Q(128>>F,n[I][0]^d))}7>F&&(G&&0!==A&&!a.has(`${A-1},${B}`)&&E.push({x:A-1,y:B,side:"right",mask:G}),e&&0!==B&&!a.has(`${A},${B-1}`)&&E.push({x:A,y:B-1,side:"bottom",mask:e}),M&&24!==B&&!a.has(`${A},${B+1}`)&&E.push({x:A,y:B+1,side:"top",mask:M}),V===N?f(A,B,I,Y,g):f(A,B,I,g,V),a.add(`${A},${B}`))}}}}}let pa=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var T;(function(a){a[a.Tile=255]="Tile";
a[a.ForegroundColor=3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(T||(T={}));var fa;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]=
"Yellow";a[a.White=15]="White"})(fa||(fa={}));let qa="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class ua{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,d,h,f){if(!Number.isInteger(a)||!Number.isInteger(d))throw new TypeError("x and y must be integers");
if(!Number.isInteger(h)||!Number.isInteger(d))throw new TypeError("width and height must be integers");if(0>a||0>d||0>h||0>f||80<a+h||25<d+f)throw new RangeError("edges exceed screen");let n=new Uint16Array(h*f);for(let k=0;k<f;k++)n.set(this.buffer.subarray(80*(d+k)+a,80*(d+k)+a+h),k*h);return{data:n,width:h,height:f}}putBrush(a,d,h){let f,n,k=a.data;if(0>d){f=-d;if(f>=a.width)return;d=0}else f=0;n=Math.min(80-d,d+a.width);if(0>h){k=k.subarray(h*a.width);if(0===k.length)return;h=0}for(let g=0;g<
a.height;g++)if(!(0>h+g)){if(25<=h+g)break;this.buffer.set(k.subarray((h+g)*a.width+f,(h+g)*a.width+n),80*h+d);for(let e=f;e<n;e++)this.updateCanvas(h+g,d+e)}}updateCanvas(a,d){let h=this.buffer[80*d+a];this.drawChar(this.ctx,a,d,h&255,h>>8&15,h>>12&15)}getCharInfo(a,d){a=this.buffer[80*d+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,d){return this.buffer[80*d+a]&255}putChar(a,d,h,f,n){this.buffer[80*d+a]=h|f<<8|n<<12;this.updateCanvas(a,d)}setChar(a,d,h,f,n,k=T.All){this.buffer[80*
d+a]=this.buffer[80*d+a]&~k|(h|f<<8|n<<12)&k;this.updateCanvas(a,d)}fill(a,d,h,f=T.All){a=(a|d<<8|h<<12)&f;for(d=0;d<this.buffer.length;d++)this.buffer[d]=this.buffer[d]&~f|a,this.updateCanvas(d%80,Math.floor(d/80))}putVHalf(a,d,h){var f=this.buffer[80*(d>>1)+a];let n=f>>>8&15,k=f>>>12&15,g=d&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 220:f=1===g?k:n;break;case 223:f=1===g?n:k}f===h?this.putChar(a,d>>1,219,h,k):0===g?this.putChar(a,d>>1,223,h,f):this.putChar(a,d>>1,220,
h,f)}putHHalf(a,d,h){var f=this.buffer[80*d+(a>>1)];let n=f>>>8&15,k=f>>>12&15,g=a&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 222:f=1===g?k:n;break;case 221:f=1===g?n:k}f===h?this.putChar(a>>1,d,219,h,k):0===g?this.putChar(a>>1,d,221,h,f):this.putChar(a>>1,d,222,h,f)}saveBlob(){if(pa)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!pa)for(var d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(d=0;80>d;d++)this.updateCanvas(d,a)}}let ra=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,
202,203,206]),na=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),va=fetch("./chardata.png"),wa=a=>{var d=document.createElement("canvas");d.width=a.width;d.height=a.height;d=d.getContext("2d");if(!d)throw Error("unable to create 2D canvas");d.drawImage(a,0,0);var h=a.width/9;a=new Uint8Array(4096);for(let f=0;256>f;f++){const {data:n}=d.getImageData(f%h*9,16*Math.floor(f/h),8,16);for(let k=0;16>k;k++)a[16*f+k]=n[32*
k+3]?128:0,a[16*f+k]|=n[4*(8*k+1)+3]?64:0,a[16*f+k]|=n[4*(8*k+2)+3]?32:0,a[16*f+k]|=n[4*(8*k+3)+3]?16:0,a[16*f+k]|=n[4*(8*k+4)+3]?8:0,a[16*f+k]|=n[4*(8*k+5)+3]?4:0,a[16*f+k]|=n[4*(8*k+5)+3]?2:0,a[16*f+k]|=n[4*(8*k+7)+3]?1:0}d=Array(256);for(h=0;256>h;h++)d[h]=a.subarray(16*h,16*(h+1));return d},xa=a=>{const d=new Uint16Array(2048);for(var h=0;256>h;h++)for(let f=0;8>f;f++)for(let n=0;16>n;n++)d[8*h+f]|=(a[h][n]>>>7-f&1)<<n;a=Array(256);for(h=0;256>h;h++)a[h]=d.subarray(8*h,8*(h+1));return a};fa=[0,
9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,d)=>32+d),8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,
9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160];let ya=new Map(fa.map((a,d)=>[String.fromCodePoint(a),d]));window.addEventListener("DOMContentLoaded",async function(){var a=await (await va).blob();let d=await createImageBitmap(a),h=d.width/9,f=(c,b,l,v,p,y)=>{c.save();c.globalCompositeOperation=
"source-over";c.fillStyle=qa[y];c.fillRect(8*b,16*l,8,16);c.globalCompositeOperation="destination-out";c.drawImage(d,v%h*9,16*Math.floor(v/h),8,16,8*b,16*l,8,16);c.globalCompositeOperation="destination-over";c.fillStyle=qa[p];c.fillRect(8*b,16*l,8,16);c.restore()},n=wa(d),k=xa(n),g=new ua(f),e=document.getElementById("editor"),m=e.getContext("2d");if(!m)throw Error("unable to create canvas context");let w=T.All;document.getElementById("tile").onchange=c=>{w=c.target.checked?w|T.Tile:w&~T.Tile};document.getElementById("fgcolor").onchange=
c=>{w=c.target.checked?w|T.ForegroundColor:w&~T.ForegroundColor};document.getElementById("bgcolor").onchange=c=>{w=c.target.checked?w|T.BackgroundColor:w&~T.BackgroundColor};let u=[7,0,0],Z=document.querySelector(".palette"),U=(c,b)=>{const l=b?"background-selected":"foreground-selected";var v=Z.querySelectorAll(`.${l}`);for(let p=0;p<v.length;p++)v[p].classList.remove(l);(v=Z.querySelector(`.color-cell[data-value='${c}']`))&&v.classList.add(l);u[b?2:0]=c};Z.onpointerdown=c=>{if("mouse"===c.pointerType&&
(0===c.button||2===c.button)){var b=0===c.button?"foreground-selected":"background-selected";for(let l=c.target;l&&!l.classList.contains("palette");l=l.parentElement)if("value"in l.dataset){let v=Z.querySelectorAll(`.${b}`);for(let p=0;p<v.length;p++)v[p].classList.remove(b);l.classList.add(b);u[c.button]=+l.dataset.value;c.preventDefault();c.stopPropagation();break}}};Z.oncontextmenu=c=>{c.preventDefault()};let N=[219,0,0],E=0,K=0,F=document.querySelector(".cursor"),O=(c,b)=>{F.style.left=`${8*c}px`;
F.style.top=`${16*b}px`;E=c;K=b},M=document.querySelector("#editor-block"),aa={freehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:D}=c;if(0===y||2===y){function z(t){t.pointerId===D&&t.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",z))}function q(t){if(t.pointerId===D){var r=Math.floor(80*(t.clientX-b.x)/b.width);t=Math.floor(25*(t.clientY-b.y)/b.height);for(const [x,H]of ba(v,p,r,t))g.setChar(x,H,N[y],u[0],u[2],w);m.drawImage(g.canvas,
0,0);v=r;p=t}}c.preventDefault();e.setPointerCapture(D);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width);c=Math.floor(25*(c.clientY-b.y)/b.height);g.setChar(l,c,N[y],u[0],u[2],w);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",z)}}}},vbFreehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:D}=c;if(0===y||2===y){function z(t){t.pointerId===D&&t.button===y&&(e.removeEventListener("pointermove",
q),e.removeEventListener("pointerup",z))}function q(t){if(t.pointerId===D){var r=Math.floor(80*(t.clientX-b.x)/b.width);t=Math.floor(50*(t.clientY-b.y)/b.height);for(const [x,H]of ba(v,p,r,t))g.putVHalf(x,H,u[y]);m.drawImage(g.canvas,0,0);v=r;p=t}}c.preventDefault();e.setPointerCapture(D);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width);c=Math.floor(50*(c.clientY-b.y)/b.height);g.putVHalf(l,c,u[y]);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",
z)}}}},hbFreehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:D}=c;if(0===y||2===y){function z(t){t.pointerId===D&&t.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",z))}function q(t){if(t.pointerId===D){var r=Math.floor(160*(t.clientX-b.x)/b.width);t=Math.floor(25*(t.clientY-b.y)/b.height);for(const [x,H]of ba(v,p,r,t))g.putHHalf(x,H,u[y]);m.drawImage(g.canvas,0,0);v=r;p=t}}c.preventDefault();e.setPointerCapture(D);var b=e.getBoundingClientRect(),
l=Math.floor(160*(c.clientX-b.x)/b.width);c=Math.floor(25*(c.clientY-b.y)/b.height);g.putHHalf(l,c,u[y]);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",z)}}}},lines:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function D(q){if(q.pointerId===y&&q.button===p){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of ba(l,v,t,q))g.setChar(r,
x,N[p],u[0],u[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",z);e.removeEventListener("pointerup",D)}}function z(q){if(q.pointerId===y){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of ba(l,v,t,q))f(m,r,x,N[p],u[0],u[2])}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),
v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],u[0],u[2]);e.addEventListener("pointermove",z);e.addEventListener("pointerup",D)}}}},filledBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function D(q){if(q.pointerId===y&&q.button===p){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of da(l,v,t,q))g.setChar(r,x,N[p],u[0],u[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);e.removeEventListener("pointermove",z);e.removeEventListener("pointerup",D)}}function z(q){if(q.pointerId===y){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of da(l,v,t,q))f(m,r,x,N[p],u[0],u[2])}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],u[0],u[2]);e.addEventListener("pointermove",
z);e.addEventListener("pointerup",D)}}}},emptyBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function D(q){if(q.pointerId===y&&q.button===p){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of oa(l,v,t,q))g.setChar(r,x,N[p],u[0],u[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",z);e.removeEventListener("pointerup",D)}}function z(q){if(q.pointerId===
y){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of oa(l,v,t,q))f(m,r,x,N[p],u[0],u[2])}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],u[0],u[2]);e.addEventListener("pointermove",z);e.addEventListener("pointerup",D)}}}},singleBorder:()=>{e.onpointerdown=c=>{if("mouse"===
c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function D(q){q.pointerId===y&&q.button===p&&(ca(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(t,r)=>g.getChar(t,r),(t,r,x)=>g.putChar(t,r,x,u[0],u[2]),!1),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",z),e.removeEventListener("pointerup",D))}function z(q){if(q.pointerId===y){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/
b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);ca(l,v,t,q,(r,x)=>g.getChar(r,x),(r,x,H)=>f(m,r,x,H,u[0],u[2]),!1)}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,S(15),u[0],u[2]);e.addEventListener("pointermove",z);e.addEventListener("pointerup",D)}}}},doubleBorder:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||
2===p){function D(q){q.pointerId===y&&q.button===p&&(ca(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(t,r)=>g.getChar(t,r),(t,r,x)=>g.putChar(t,r,x,u[0],u[2]),!0),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",z),e.removeEventListener("pointerup",D))}function z(q){if(q.pointerId===y){var t=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);ca(l,v,t,q,(r,x)=>g.getChar(r,x),(r,x,H)=>f(m,r,x,H,u[0],u[2]),!0)}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,S(15),u[0],u[2]);e.addEventListener("pointermove",z);e.addEventListener("pointerup",D)}}}},colorFloodFill:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:l}=c;if(0===l||2===l){c.preventDefault();var b=e.getBoundingClientRect();ta(80*(c.clientX-
b.x)/b.width,25*(c.clientY-b.y)/b.height,(v,p)=>g.getCharInfo(v,p),(v,p,y,D,z)=>g.putChar(v,p,y,D,z),n,k,u[l]);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0)}}}},pick:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:D}=c;if(0===y||2===y){function z(t){t.pointerId===D&&t.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",z))}function q(t){if(t.pointerId===D&&t.button===y){var r=e.getBoundingClientRect(),{charCode:x,fgColor:H,
bgColor:W}=g.getCharInfo(Math.floor(80*(t.clientX-r.x)/r.width),Math.floor(25*(t.clientY-r.y)/r.height));w&T.Tile&&ka(x,2===y);w&T.ForegroundColor&&U(H,!1);w&T.BackgroundColor&&U(W,!0)}}c.preventDefault();e.setPointerCapture(D);var b=e.getBoundingClientRect(),{charCode:l,fgColor:v,bgColor:p}=g.getCharInfo(Math.floor(80*(c.clientX-b.x)/b.width),Math.floor(25*(c.clientY-b.y)/b.height));w&T.Tile&&ka(l,2===y);w&T.ForegroundColor&&U(v,!1);w&T.BackgroundColor&&U(p,!0);e.addEventListener("pointermove",q);
e.addEventListener("pointerup",z)}}}},text:()=>{function c(b){if("Tab"!==b.key){b.preventDefault();b.stopPropagation();switch(b.key){case "ArrowDown":O(E,Math.min(K+1,24));return;case "ArrowUp":O(E,Math.max(K-1,0));return;case "ArrowLeft":0===E?0!==K&&O(79,K-1):O(E-1,K);return;case "ArrowRight":79===E?24!==K&&O(0,K+1):O(E+1,K);return;case "Enter":O(0,Math.min(24,K+1));return;case "End":case "PageDown":O(E,24);return;case "Home":case "PageUp":O(E,0);return;case "Backspace":0===E?0!==K&&O(79,K-1):O(E-
1,K);g.setChar(E,K,0,u[0],u[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return;case "Delete":g.setChar(E,K,0,u[0],u[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return}b=ya.get(b.key);"number"===typeof b&&(g.setChar(E,K,b,u[0],u[2],w),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),79===E?24!==K&&O(0,K+1):O(E+1,K))}}M.focus();e.onpointerdown=b=>{if("mouse"===b.pointerType){var {button:l}=b;0===l&&(b.preventDefault(),l=e.getBoundingClientRect(),
O(Math.floor(80*(b.clientX-l.x)/l.width),Math.floor(25*(b.clientY-l.y)/l.height)),M.focus())}};M.addEventListener("keydown",c);return()=>{M.removeEventListener("keydown",c)}},gradientBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:D,pointerId:z}=c;if(0===D||2===D){function q(r){if(r.pointerId===z&&r.button===D){var x=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);var [H,W]=v<x?[v,x]:[x,v],[R,P]=p<r?[p,r]:[r,p];for(const [J,C]of da(v,p,x,r)){x=
y(J,C,H,W,R,P);const {charCode:L,fgColor:la,bgColor:ma}=V(b,x);g.putChar(J,C,L,la,ma)}m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",t);e.removeEventListener("pointerup",q)}}function t(r){if(r.pointerId===z){var x=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);var [H,W]=v<x?[v,x]:[x,v],[R,P]=p<r?[p,r]:[r,p];for(const [J,C]of da(v,p,x,r)){x=y(J,C,H,W,R,P);const {charCode:L,
fgColor:la,bgColor:ma}=V(b,x);f(m,J,C,L,la,ma)}}}var b=I();if(0!==b.length){c.preventDefault();e.setPointerCapture(z);var l=e.getBoundingClientRect(),v=Math.floor(80*(c.clientX-l.x)/l.width),p=Math.floor(25*(c.clientY-l.y)/l.height);f(m,v,p,219,b[0],0);c=document.getElementById("gradient-direction-selector");var y="up"===c.value?(r,x,H,W,R,P)=>(x-P)/(R-P):"right"===c.value?(r,x,H,W,R,P)=>(r-H)/(W-H):"left"===c.value?(r,x,H,W,R,P)=>(r-W)/(H-W):(r,x,H,W,R,P)=>(x-R)/(P-R);e.addEventListener("pointermove",
t);e.addEventListener("pointerup",q)}}}}},spraypaint:()=>{e.onpointerdown=c=>{const {pointerId:b,pointerType:l,button:v}=c;if("mouse"===l&&0===v){const z=I();if(0!==z.length){function q(r){r.pointerId===b&&r.button===v&&(e.removeEventListener("pointermove",t),e.removeEventListener("pointerup",q))}function t(r){if(r.pointerId===b){var x=performance.now(),H=x-D;D=x;x=Math.floor(80*(r.clientX-y.x)/y.width);r=Math.floor(25*(r.clientY-y.y)/y.height);var {charCode:W,fgColor:R,bgColor:P}=g.getCharInfo(x,
r),J=80*r+x;if(-1===p[J])if(R===P){var C=z.indexOf(P);p[J]=z[-1===C?0:C]}else switch(W){case 0:case 32:case 255:C=z.indexOf(P);p[J]=z[-1===C?0:C];break;case 8:case 10:case 219:C=z.indexOf(R);p[J]=z[-1===C?0:C];break;case 176:C=z.indexOf(P);var L=z.indexOf(R);p[J]=-1===C?-1===L?0:Math.max(0,L-.5):-1===L?Math.max(0,C-.5):C===L-1?C+.25:L===C-1?L+.75:Math.max(0,Math.min(L,C)+.25);break;case 177:C=z.indexOf(P);L=z.indexOf(R);p[J]=-1===C?-1===L?0:Math.max(0,L-.5):-1===L?Math.max(0,C-.5):C===L-1?C+.5:L===
C-1?L+.5:Math.max(0,Math.min(L,C)+.5);break;case 178:C=z.indexOf(P);L=z.indexOf(R);p[J]=-1===C?-1===L?0:Math.max(0,L-.5):-1===L?Math.max(0,C-.5):C===L-1?C+.75:L===C-1?L+.25:Math.max(0,Math.min(L,C)+.5);break;default:C=z.indexOf(P),-1===C&&(C=z.indexOf(R)),p[J]=C+.5}p[J]+=H/100;p[J]>=z.length-1?(J=219,C=z[z.length-1],H=0):(H=Math.floor(p[J]),J=p[J]-H,.125>J?(J=219,C=z[H],H=0):(J=.375>J?176:.625>J?177:.875>J?178:219,C=z[H+1],H=z[H]));if(J!==W||C!==R||H!==P)g.putChar(x,r,J,C,H),m.globalCompositeOperation=
"copy",m.drawImage(g.canvas,0,0)}}var p=new Float32Array(2E3);p.fill(-1);var y=e.getBoundingClientRect(),D=performance.now();e.addEventListener("pointermove",t);e.addEventListener("pointerup",q)}}}}},A=document.getElementById("add-gradient-slot"),B=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),ea=document.querySelector(".gradient-slots"),G=c=>{const b=B.cloneNode(!0);b.dataset.value=String(c);b.querySelector(".remove-gradient-slot").onclick=()=>{ea.removeChild(b)};
ea.insertBefore(b,A)};A.onclick=()=>{G(u[0])};G(0);G(8);G(7);G(15);let I=()=>{const c=document.querySelectorAll(".gradient-slots .gradient-slot"),b=[];for(let l=0;l<c.length;l++)b.push(Number(c[l].dataset.value));return b},V=(c,b)=>{if(2>c.length)return{charCode:219,fgColor:c[0]||0,bgColor:0};b=Math.max(0,Math.min(1,Number(b)||0));b*=c.length;const l=Math.floor(b);if(l>=c.length-1)return{charCode:219,fgColor:c[c.length-1],bgColor:0};b-=l;return.125>b?{charCode:0,fgColor:c[l+1],bgColor:c[l]}:.375>
b?{charCode:176,fgColor:c[l+1],bgColor:c[l]}:.625>b?{charCode:177,fgColor:c[l+1],bgColor:c[l]}:.875>b?{charCode:178,fgColor:c[l+1],bgColor:c[l]}:{charCode:219,fgColor:c[l+1],bgColor:0}},Y;Y=aa.freehand();let ha=document.getElementById("tool-selector"),ia=ha.value;document.body.classList.add("tool-"+ia);ha.onchange=c=>{Y&&Y();Y=aa[ha.value]();document.body.classList.remove("tool-"+ia);ia=ha.value;document.body.classList.add("tool-"+ia)};e.oncontextmenu=c=>{c.preventDefault()};let ja=document.getElementById("char-picker"),
za=document.querySelector(".left-pick"),Aa=document.querySelector(".right-pick"),ka=(c,b)=>{const l=Math.floor(c/64),v=b?Aa:za;v.style.left=`${c%64*8}px`;v.style.top=`${16*l}px`;N[b?2:0]=c};a=ja.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let c=0;256>c;c++)f(a,c%64,Math.floor(c/64),c,7,0);ja.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var b=ja.getBoundingClientRect();ka(64*Math.floor(4*(c.clientY-b.y)/b.height)+Math.floor(64*(c.clientX-
b.x)/b.width),2===c.button)}};ja.oncontextmenu=c=>{c.preventDefault()};document.getElementById("save-image").onclick=c=>{c=g.saveBlob();c=URL.createObjectURL(c);let b=document.createElement("a");b.download="dosimage.dat";b.href=c;b.click()};document.getElementById("load-image").onclick=async c=>{if(c=await sa()){try{await g.loadBlob(c)}catch(b){alert(b);return}m.drawImage(g.canvas,0,0)}};document.getElementById("clear-image").onclick=c=>{g.fill(N[2],u[0],u[2],w);m.drawImage(g.canvas,0,0)}},{once:!0})})()
