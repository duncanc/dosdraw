'use strict';(function(){function*D(a,b,d,f){let g=Math.abs(d-a),h=Math.abs(f-b),k=a<d?1:-1,n=b<f?1:-1,p=g-h;for(;;){yield[a,b];if(a===d&&b===f)break;let t=2*p;t>-h&&(p-=h,a+=k);t<g&&(p+=g,b+=n)}}function E(){return new Promise((a,b)=>{let d=document.createElement("input");d.type="file";d.onchange=f=>{var g;(null===(g=d.files)||void 0===g?0:g.length)?a(d.files[0]):a(null)};d.click()})}let w=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var x;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=
1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]="White"})(x||(x={}));let y="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class F{constructor(a){this.drawChar=
a;this.buffer=new Uint16Array(2E3);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,b,d,f){if(!Number.isInteger(a)||!Number.isInteger(b))throw new TypeError("x and y must be integers");if(!Number.isInteger(d)||!Number.isInteger(b))throw new TypeError("width and height must be integers");if(0>a||0>b||0>d||0>f||80<a+d||25<b+f)throw new RangeError("edges exceed screen");
let g=new Uint16Array(d*f);for(let h=0;h<f;h++)g.set(this.buffer.subarray(80*(b+h)+a,80*(b+h)+a+d),h*d);return{data:g,width:d,height:f}}putBrush(a,b,d){let f,g,h=a.data;if(0>b){f=-b;if(f>=a.width)return;b=0}else f=0;g=Math.min(80-b,b+a.width);if(0>d){h=h.subarray(d*a.width);if(0===h.length)return;d=0}for(let k=0;k<a.height;k++)if(!(0>d+k)){if(25<=d+k)break;this.buffer.set(h.subarray((d+k)*a.width+f,(d+k)*a.width+g),80*d+b);for(let n=f;n<g;n++)this.updateCanvas(d+k,b+n)}}updateCanvas(a,b){let d=this.buffer[80*
b+a];this.drawChar(this.ctx,a,b,d&255,d>>8&15,d>>12&15)}getCharInfo(a,b){a=this.buffer[80*b+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}putChar(a,b,d,f,g){this.buffer[80*b+a]=d|f<<8|g<<12;this.updateCanvas(a,b)}fill(a,b,d){a=a|b<<8|d<<12;for(b=0;b<this.buffer.length;b++)this.buffer[b]=a,this.updateCanvas(b%80,Math.floor(b/80))}saveBlob(){if(w)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let b=0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!w)for(var b=0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(b=0;80>b;b++)this.updateCanvas(b,a)}}let G=fetch("./chardata.png");window.addEventListener("DOMContentLoaded",async function(){var a=await (await G).blob();let b=await createImageBitmap(a),d=b.width/9;a=(c,e,l,m,q,u)=>{c.save();c.globalCompositeOperation="source-over";c.fillStyle=y[u];c.fillRect(8*
e,16*l,8,16);c.globalCompositeOperation="destination-out";c.drawImage(b,m%d*9,16*Math.floor(m/d),8,16,8*e,16*l,8,16);c.globalCompositeOperation="destination-over";c.fillStyle=y[q];c.fillRect(8*e,16*l,8,16);c.restore()};let f=new F(a),g=document.getElementById("editor"),h=g.getContext("2d");if(!h)throw Error("unable to create canvas context");let k=[7,0,0],n=document.querySelector(".palette");n.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var e=0===c.button?"foreground-selected":
"background-selected";for(let l=c.target;l&&!l.classList.contains("palette");l=l.parentElement)if("value"in l.dataset){let m=n.querySelectorAll(`.${e}`);for(let q=0;q<m.length;q++)m[q].classList.remove(e);l.classList.add(e);k[c.button]=+l.dataset.value;c.preventDefault();c.stopPropagation();break}}};n.oncontextmenu=c=>{c.preventDefault()};let p=[219,0,0];g.onpointerdown=c=>{if("mouse"===c.pointerType){let {button:u,pointerId:v}=c;if(0===u||2===u){function z(r){r.pointerId===v&&(g.removeEventListener("pointermove",
A),g.removeEventListener("pointerup",z))}function A(r){if(r.pointerId===v){var B=Math.floor(80*(r.clientX-e.x)/e.width);r=Math.floor(25*(r.clientY-e.y)/e.height);for(let [H,I]of D(m,q,B,r))f.putChar(H,I,p[u],k[0],k[2]);h.drawImage(f.canvas,0,0);m=B;q=r}}g.setPointerCapture(v);var e=g.getBoundingClientRect(),l=Math.floor(80*(c.clientX-e.x)/e.width);c=Math.floor(25*(c.clientY-e.y)/e.height);f.putChar(l,c,p[u],k[0],k[2]);h.drawImage(f.canvas,0,0);var m=l,q=c;g.addEventListener("pointermove",A);g.addEventListener("pointerup",
z)}}};g.oncontextmenu=c=>{c.preventDefault()};let t=document.getElementById("char-picker"),C=t.getContext("2d");if(!C)throw Error("unable to create canvas context");for(let c=0;256>c;c++)a(C,c%64,Math.floor(c/64),c,7,0);let J=document.querySelector(".left-pick"),K=document.querySelector(".right-pick");t.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var e=t.getBoundingClientRect(),l=Math.floor(64*(c.clientX-e.x)/e.width);e=Math.floor(4*(c.clientY-e.y)/e.height);var m=
2===c.button?K:J;p[c.button]=64*e+l;m.style.left=`${8*l}px`;m.style.top=`${16*e}px`}};t.oncontextmenu=c=>{c.preventDefault()};document.getElementById("save-image").onclick=c=>{c=f.saveBlob();c=URL.createObjectURL(c);let e=document.createElement("a");e.download="dosimage.dat";e.href=c;e.click()};document.getElementById("load-image").onclick=async c=>{if(c=await E()){try{await f.loadBlob(c)}catch(e){alert(e);return}h.drawImage(f.canvas,0,0)}};document.getElementById("clear-image").onclick=c=>{f.fill(p[2],
k[0],k[2]);h.drawImage(f.canvas,0,0)}},{once:!0})})()
