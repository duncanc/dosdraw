'use strict';(function(){function C(a){a-=179;return!Number.isInteger(a)||0>a||a>=K.length?0:K[a]}function B(a){return R[a]||0}function G(a,c,k,h,f,b,g){let [r,m]=a<k?[a,k]:[k,a],[y,z]=c<h?[c,h]:[h,c];a=g?32:0;g=g?16:0;if(y===z)if(r===m)b(r,y,B(15));else{b(r,y,B(C(f(r,y))&-33|8|a));for(g=r+1;g<m;g++)b(g,y,B(C(f(g,y))&-33|12|a));b(m,y,B(C(f(m,y))&-33|4|a))}else if(r===m){b(r,y,B(C(f(r,y))&-17|2|g));for(a=y+1;a<z;a++)b(r,a,B(C(f(r,a))&-17|3|g));b(r,z,B(C(f(r,z))&-17|1|g))}else{b(r,y,B(C(f(r,y))&-49|
10|a|g));for(c=r+1;c<m;c++)b(c,y,B(C(f(c,y))&-33|12|a));b(m,y,B(C(f(m,y))&-49|6|a|g));for(c=y+1;c<z;c++)b(r,c,B(C(f(r,c))&-17|3|g)),b(m,c,B(C(f(m,c))&-17|3|g));b(r,z,B(C(f(r,z))&-49|9|a|g));for(c=r+1;c<m;c++)b(c,z,B(C(f(c,z))&-33|12|a));b(m,z,B(C(f(m,z))&-49|5|g|a))}}function*F(a,c,k,h){let f=Math.abs(k-a),b=Math.abs(h-c),g=a<k?1:-1,r=c<h?1:-1,m=f-b;for(;;){yield[a,c];if(a===k&&c===h)break;let y=2*m;y>-b&&(m-=b,a+=g);y<f&&(m+=f,c+=r)}}function*L(a,c,k,h){let f=Math.sign(k-a),b=Math.sign(h-c);if(0===
f)if(0===b)yield[a,c];else for(k=c;k!==h+b;k+=b)yield[a,k];else if(0===b)for(;a!==k+f;a+=f)yield[a,c];else for(;c!==h+b;c+=b)for(let g=a;g!==k+f;g+=f)yield[g,c]}function*M(a,c,k,h){let f=Math.sign(k-a),b=Math.sign(h-c);if(0===f)if(0===b)yield[a,c];else for(k=c;k!==h+b;k+=b)yield[a,k];else if(0===b)for(h=a;h!==k+f;h+=f)yield[h,c];else{for(let g=a;g!==k+f;g+=f)yield[g,c];for(c+=b;c!==h;c+=b)yield[a,c],yield[k,c];for(;a!==k+f;a+=f)yield[a,h]}}function S(){return new Promise((a,c)=>{let k=document.createElement("input");
k.type="file";k.onchange=h=>{var f;(null===(f=k.files)||void 0===f?0:f.length)?a(k.files[0]):a(null)};k.click()})}let N=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var D;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(D||(D={}));var O;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=
5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]="White"})(O||(O={}));let P="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class T{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=
640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,c,k,h){if(!Number.isInteger(a)||!Number.isInteger(c))throw new TypeError("x and y must be integers");if(!Number.isInteger(k)||!Number.isInteger(c))throw new TypeError("width and height must be integers");if(0>a||0>c||0>k||0>h||80<a+k||25<c+h)throw new RangeError("edges exceed screen");let f=new Uint16Array(k*h);for(let b=0;b<h;b++)f.set(this.buffer.subarray(80*(c+b)+
a,80*(c+b)+a+k),b*k);return{data:f,width:k,height:h}}putBrush(a,c,k){let h,f,b=a.data;if(0>c){h=-c;if(h>=a.width)return;c=0}else h=0;f=Math.min(80-c,c+a.width);if(0>k){b=b.subarray(k*a.width);if(0===b.length)return;k=0}for(let g=0;g<a.height;g++)if(!(0>k+g)){if(25<=k+g)break;this.buffer.set(b.subarray((k+g)*a.width+h,(k+g)*a.width+f),80*k+c);for(let r=h;r<f;r++)this.updateCanvas(k+g,c+r)}}updateCanvas(a,c){let k=this.buffer[80*c+a];this.drawChar(this.ctx,a,c,k&255,k>>8&15,k>>12&15)}getCharInfo(a,
c){a=this.buffer[80*c+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,c){return this.buffer[80*c+a]&255}putChar(a,c,k,h,f){this.buffer[80*c+a]=k|h<<8|f<<12;this.updateCanvas(a,c)}setChar(a,c,k,h,f,b=D.All){this.buffer[80*c+a]=this.buffer[80*c+a]&~b|(k|h<<8|f<<12)&b;this.updateCanvas(a,c)}fill(a,c,k,h=D.All){a=(a|c<<8|k<<12)&h;for(c=0;c<this.buffer.length;c++)this.buffer[c]=this.buffer[c]&~h|a,this.updateCanvas(c%80,Math.floor(c/80))}putVHalf(a,c,k){var h=this.buffer[80*(c>>1)+
a];let f=h>>>8&15,b=h>>>12&15,g=c&1;switch(h&255){case 219:case 8:case 10:h=f;break;default:h=b;break;case 220:h=1===g?b:f;break;case 223:h=1===g?f:b}h===k?this.putChar(a,c>>1,219,k,b):0===g?this.putChar(a,c>>1,223,k,h):this.putChar(a,c>>1,220,k,h)}putHHalf(a,c,k){var h=this.buffer[80*c+(a>>1)];let f=h>>>8&15,b=h>>>12&15,g=a&1;switch(h&255){case 219:case 8:case 10:h=f;break;default:h=b;break;case 222:h=1===g?b:f;break;case 221:h=1===g?f:b}h===k?this.putChar(a>>1,c,219,k,b):0===g?this.putChar(a>>1,
c,221,k,h):this.putChar(a>>1,c,222,k,h)}saveBlob(){if(N)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!N)for(var c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(c=0;80>c;c++)this.updateCanvas(c,a)}}let R=new Uint8Array([0,
193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,202,203,206]),K=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),U=fetch("./chardata.png");window.addEventListener("DOMContentLoaded",async function(){var a=await (await U).blob();let c=
await createImageBitmap(a),k=c.width/9,h=(e,d,p,u,q,t)=>{e.save();e.globalCompositeOperation="source-over";e.fillStyle=P[t];e.fillRect(8*d,16*p,8,16);e.globalCompositeOperation="destination-out";e.drawImage(c,u%k*9,16*Math.floor(u/k),8,16,8*d,16*p,8,16);e.globalCompositeOperation="destination-over";e.fillStyle=P[q];e.fillRect(8*d,16*p,8,16);e.restore()},f=new T(h),b=document.getElementById("editor"),g=b.getContext("2d");if(!g)throw Error("unable to create canvas context");let r=D.All;document.getElementById("tile").onchange=
e=>{r=e.target.checked?r|D.Tile:r&~D.Tile};document.getElementById("fgcolor").onchange=e=>{r=e.target.checked?r|D.ForegroundColor:r&~D.ForegroundColor};document.getElementById("bgcolor").onchange=e=>{r=e.target.checked?r|D.BackgroundColor:r&~D.BackgroundColor};let m=[7,0,0],y=document.querySelector(".palette");y.onpointerdown=e=>{if("mouse"===e.pointerType&&(0===e.button||2===e.button)){var d=0===e.button?"foreground-selected":"background-selected";for(let p=e.target;p&&!p.classList.contains("palette");p=
p.parentElement)if("value"in p.dataset){let u=y.querySelectorAll(`.${d}`);for(let q=0;q<u.length;q++)u[q].classList.remove(d);p.classList.add(d);m[e.button]=+p.dataset.value;e.preventDefault();e.stopPropagation();break}}};y.oncontextmenu=e=>{e.preventDefault()};let z=[219,0,0],Q={freehand:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:t,pointerId:x}=e;if(0===t||2===t){function A(n){n.pointerId===x&&n.button===t&&(b.removeEventListener("pointermove",l),b.removeEventListener("pointerup",
A))}function l(n){if(n.pointerId===x){var v=Math.floor(80*(n.clientX-d.x)/d.width);n=Math.floor(25*(n.clientY-d.y)/d.height);for(const [w,E]of F(u,q,v,n))f.setChar(w,E,z[t],m[0],m[2],r);g.drawImage(f.canvas,0,0);u=v;q=n}}b.setPointerCapture(x);var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width);e=Math.floor(25*(e.clientY-d.y)/d.height);f.setChar(p,e,z[t],m[0],m[2],r);g.drawImage(f.canvas,0,0);var u=p,q=e;b.addEventListener("pointermove",l);b.addEventListener("pointerup",A)}}}},
vbFreehand:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:t,pointerId:x}=e;if(0===t||2===t){function A(n){n.pointerId===x&&n.button===t&&(b.removeEventListener("pointermove",l),b.removeEventListener("pointerup",A))}function l(n){if(n.pointerId===x){var v=Math.floor(80*(n.clientX-d.x)/d.width);n=Math.floor(50*(n.clientY-d.y)/d.height);for(const [w,E]of F(u,q,v,n))f.putVHalf(w,E,m[t]);g.drawImage(f.canvas,0,0);u=v;q=n}}b.setPointerCapture(x);var d=b.getBoundingClientRect(),p=Math.floor(80*
(e.clientX-d.x)/d.width);e=Math.floor(50*(e.clientY-d.y)/d.height);f.putVHalf(p,e,m[t]);g.drawImage(f.canvas,0,0);var u=p,q=e;b.addEventListener("pointermove",l);b.addEventListener("pointerup",A)}}}},hbFreehand:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:t,pointerId:x}=e;if(0===t||2===t){function A(n){n.pointerId===x&&n.button===t&&(b.removeEventListener("pointermove",l),b.removeEventListener("pointerup",A))}function l(n){if(n.pointerId===x){var v=Math.floor(160*(n.clientX-
d.x)/d.width);n=Math.floor(25*(n.clientY-d.y)/d.height);for(const [w,E]of F(u,q,v,n))f.putHHalf(w,E,m[t]);g.drawImage(f.canvas,0,0);u=v;q=n}}b.setPointerCapture(x);var d=b.getBoundingClientRect(),p=Math.floor(160*(e.clientX-d.x)/d.width);e=Math.floor(25*(e.clientY-d.y)/d.height);f.putHHalf(p,e,m[t]);g.drawImage(f.canvas,0,0);var u=p,q=e;b.addEventListener("pointermove",l);b.addEventListener("pointerup",A)}}}},lines:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:q,pointerId:t}=
e;if(0===q||2===q){function x(l){if(l.pointerId===t&&l.button===q){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,w]of F(p,u,n,l))f.setChar(v,w,z[q],m[0],m[2],r);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);b.removeEventListener("pointermove",A);b.removeEventListener("pointerup",x)}}function A(l){if(l.pointerId===t){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);g.globalCompositeOperation="copy";
g.drawImage(f.canvas,0,0);for(const [v,w]of F(p,u,n,l))h(g,v,w,z[q],m[0],m[2])}}b.setPointerCapture(t);var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width),u=Math.floor(25*(e.clientY-d.y)/d.height);h(g,p,u,z[q],m[0],m[2]);b.addEventListener("pointermove",A);b.addEventListener("pointerup",x)}}}},filledBox:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:q,pointerId:t}=e;if(0===q||2===q){function x(l){if(l.pointerId===t&&l.button===q){var n=Math.floor(80*(l.clientX-
d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,w]of L(p,u,n,l))f.setChar(v,w,z[q],m[0],m[2],r);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);b.removeEventListener("pointermove",A);b.removeEventListener("pointerup",x)}}function A(l){if(l.pointerId===t){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);for(const [v,w]of L(p,u,n,l))h(g,v,w,z[q],m[0],m[2])}}b.setPointerCapture(t);
var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width),u=Math.floor(25*(e.clientY-d.y)/d.height);h(g,p,u,z[q],m[0],m[2]);b.addEventListener("pointermove",A);b.addEventListener("pointerup",x)}}}},emptyBox:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:q,pointerId:t}=e;if(0===q||2===q){function x(l){if(l.pointerId===t&&l.button===q){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,w]of M(p,u,n,l))f.setChar(v,w,
z[q],m[0],m[2],r);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);b.removeEventListener("pointermove",A);b.removeEventListener("pointerup",x)}}function A(l){if(l.pointerId===t){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);for(const [v,w]of M(p,u,n,l))h(g,v,w,z[q],m[0],m[2])}}b.setPointerCapture(t);var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width),u=Math.floor(25*
(e.clientY-d.y)/d.height);h(g,p,u,z[q],m[0],m[2]);b.addEventListener("pointermove",A);b.addEventListener("pointerup",x)}}}},singleBorder:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:q,pointerId:t}=e;if(0===q||2===q){function x(l){l.pointerId===t&&l.button===q&&(G(p,u,Math.floor(80*(l.clientX-d.x)/d.width),Math.floor(25*(l.clientY-d.y)/d.height),(n,v)=>f.getChar(n,v),(n,v,w)=>f.putChar(n,v,w,m[0],m[2]),!1),g.globalCompositeOperation="copy",g.drawImage(f.canvas,0,0),b.removeEventListener("pointermove",
A),b.removeEventListener("pointerup",x))}function A(l){if(l.pointerId===t){var n=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);G(p,u,n,l,(v,w)=>f.getChar(v,w),(v,w,E)=>h(g,v,w,E,m[0],m[2]),!1)}}b.setPointerCapture(t);var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width),u=Math.floor(25*(e.clientY-d.y)/d.height);h(g,p,u,B(15),m[0],m[2]);b.addEventListener("pointermove",A);b.addEventListener("pointerup",
x)}}}},doubleBorder:()=>{b.onpointerdown=e=>{if("mouse"===e.pointerType){const {button:q,pointerId:t}=e;if(0===q||2===q){function x(l){l.pointerId===t&&l.button===q&&(G(p,u,Math.floor(80*(l.clientX-d.x)/d.width),Math.floor(25*(l.clientY-d.y)/d.height),(n,v)=>f.getChar(n,v),(n,v,w)=>f.putChar(n,v,w,m[0],m[2]),!0),g.globalCompositeOperation="copy",g.drawImage(f.canvas,0,0),b.removeEventListener("pointermove",A),b.removeEventListener("pointerup",x))}function A(l){if(l.pointerId===t){var n=Math.floor(80*
(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);g.globalCompositeOperation="copy";g.drawImage(f.canvas,0,0);G(p,u,n,l,(v,w)=>f.getChar(v,w),(v,w,E)=>h(g,v,w,E,m[0],m[2]),!0)}}b.setPointerCapture(t);var d=b.getBoundingClientRect(),p=Math.floor(80*(e.clientX-d.x)/d.width),u=Math.floor(25*(e.clientY-d.y)/d.height);h(g,p,u,B(15),m[0],m[2]);b.addEventListener("pointermove",A);b.addEventListener("pointerup",x)}}}}};Q.freehand();let H=document.getElementById("tool-selector"),I=H.value;
document.body.classList.add("tool-"+I);H.onchange=e=>{Q[H.value]();document.body.classList.remove("tool-"+I);I=H.value;document.body.classList.add("tool-"+I)};b.oncontextmenu=e=>{e.preventDefault()};let J=document.getElementById("char-picker");a=J.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let e=0;256>e;e++)h(a,e%64,Math.floor(e/64),e,7,0);let V=document.querySelector(".left-pick"),W=document.querySelector(".right-pick");J.onpointerdown=e=>{if("mouse"===e.pointerType&&
(0===e.button||2===e.button)){var d=J.getBoundingClientRect(),p=Math.floor(64*(e.clientX-d.x)/d.width);d=Math.floor(4*(e.clientY-d.y)/d.height);var u=2===e.button?W:V;z[e.button]=64*d+p;u.style.left=`${8*p}px`;u.style.top=`${16*d}px`}};J.oncontextmenu=e=>{e.preventDefault()};document.getElementById("save-image").onclick=e=>{e=f.saveBlob();e=URL.createObjectURL(e);let d=document.createElement("a");d.download="dosimage.dat";d.href=e;d.click()};document.getElementById("load-image").onclick=async e=>
{if(e=await S()){try{await f.loadBlob(e)}catch(d){alert(d);return}g.drawImage(f.canvas,0,0)}};document.getElementById("clear-image").onclick=e=>{f.fill(z[2],m[0],m[2],r);g.drawImage(f.canvas,0,0)}},{once:!0})})()
