'use strict';(function(){function R(a){a-=179;return!Number.isInteger(a)||0>a||a>=na.length?0:na[a]}function N(a){return ra[a]||0}function ba(a,d,h,f,n,k,g){let [e,m]=a<h?[a,h]:[h,a],[v,q]=d<f?[d,f]:[f,d];a=g?32:0;g=g?16:0;if(v===q)if(e===m)k(e,v,N(15));else{k(e,v,N(R(n(e,v))&-33|8|a));for(g=e+1;g<m;g++)k(g,v,N(R(n(g,v))&-33|12|a));k(m,v,N(R(n(m,v))&-33|4|a))}else if(e===m){k(e,v,N(R(n(e,v))&-17|2|g));for(a=v+1;a<q;a++)k(e,a,N(R(n(e,a))&-17|3|g));k(e,q,N(R(n(e,q))&-17|1|g))}else{k(e,v,N(R(n(e,v))&
-49|10|a|g));for(d=e+1;d<m;d++)k(d,v,N(R(n(d,v))&-33|12|a));k(m,v,N(R(n(m,v))&-49|6|a|g));for(d=v+1;d<q;d++)k(e,d,N(R(n(e,d))&-17|3|g)),k(m,d,N(R(n(m,d))&-17|3|g));k(e,q,N(R(n(e,q))&-49|9|a|g));for(d=e+1;d<m;d++)k(d,q,N(R(n(d,q))&-33|12|a));k(m,q,N(R(n(m,q))&-49|5|g|a))}}function*Y(a,d,h,f){let n=Math.abs(h-a),k=Math.abs(f-d),g=a<h?1:-1,e=d<f?1:-1,m=n-k;for(;;){yield[a,d];if(a===h&&d===f)break;let v=2*m;v>-k&&(m-=k,a+=g);v<n&&(m+=n,d+=e)}}function*ca(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);
if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(;a!==h+n;a+=n)yield[a,d];else for(;d!==f+k;d+=k)for(let g=a;g!==h+n;g+=n)yield[g,d]}function*oa(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(f=a;f!==h+n;f+=n)yield[f,d];else{for(let g=a;g!==h+n;g+=n)yield[g,d];for(d+=k;d!==f;d+=k)yield[a,d],yield[h,d];for(;a!==h+n;a+=n)yield[a,f]}}function sa(){return new Promise((a,d)=>{let h=document.createElement("input");
h.type="file";h.onchange=f=>{var n;(null===(n=h.files)||void 0===n?0:n.length)?a(h.files[0]):a(null)};h.click()})}function M(a,d){let h=0;for(;a&d;){var f=Math.clz32(d);f=32-Math.clz32(~d<<f>>>f);f=d>>>f<<f;f&a&&(h|=f,a&=~f);d&=~f}return h}function ta(a,d,h,f,n,k,g){if(!(0>a||0>d||80<=a||25<=d)){var e=Math.floor(a%1*8),m=Math.floor(d%1*8);a=Math.floor(a);d=Math.floor(d);var {charCode:v,bgColor:q,fgColor:W}=h(a,d);if(q===W||32===v||255===v)v=0;var P=!!(n[v][m]&128>>>e),J=P?W:q,C=[],G=P?0:255,D=P?0:
65535,L=M(128>>>e,n[v][m]^G),I=M(32768>>>m,k[v][e]^D);a:if(0!==d){var X=L;for(let x=m-1;0<=x;x--)if(X=M(X,n[v][x]^G),0===X)break a;C.push({x:a,y:d-1,side:"bottom",mask:X})}a:if(24!==d){for(m+=1;8>m;m++)if(L=M(L,n[v][m]^G),0===L)break a;C.push({x:a,y:d+1,side:"top",mask:L})}a:if(0!==a){G=I;for(m=e-1;0<=m;m--)if(G=M(G,k[v][m]^D),0===G)break a;C.push({x:a-1,y:d,side:"right",mask:G})}a:if(79!==a){for(e+=1;8>e;e++)if(I=M(I,k[v][e]^D),0===I)break a;C.push({x:a+1,y:d,side:"left",mask:I})}P?f(a,d,v,g,q):
f(a,d,v,W,g);for(a=new Set([`${a},${d}`]);0<C.length;){let {x,y:A,side:da,mask:E}=C.pop(),{charCode:H,bgColor:Q,fgColor:S}=h(x,A);if(Q!==J&&S!==J||177===H||176===H&&Q!==J||178===H&&S!==J)a.add(`${x},${A}`);else{if(S===Q||32===H||255===H)H=0;d=Q===J?255:0;P=Q===J?65535:0;switch(da){case "top":for(D=I=e=0;16>D;D++){E=M(E,n[H][D]^d);if(0===E)break;E&128&&(e|=M(1<<D,k[H][0]^P));E&1&&(I|=M(1<<D,k[H][7]^P))}0<D&&(E&&24!==A&&!a.has(`${x},${A+1}`)&&C.push({x,y:A+1,side:"top",mask:E}),e&&0!==x&&!a.has(`${x-
1},${A}`)&&C.push({x:x-1,y:A,side:"right",mask:e}),I&&79!==x&&!a.has(`${x+1},${A}`)&&C.push({x:x+1,y:A,side:"left",mask:I}),Q===J?f(x,A,H,S,g):f(x,A,H,g,Q),a.add(`${x},${A}`));break;case "bottom":I=e=0;for(D=15;0<=D;D--){E=M(E,n[H][D]^d);if(0===E)break;E&128&&(e|=M(1<<D,k[H][0]^P));E&1&&(I|=M(1<<D,k[H][7]^P))}15>D&&(E&&0!==A&&!a.has(`${x},${A-1}`)&&C.push({x,y:A-1,side:"bottom",mask:E}),e&&0!==x&&!a.has(`${x-1},${A}`)&&C.push({x:x-1,y:A,side:"right",mask:e}),I&&79!==x&&!a.has(`${x+1},${A}`)&&C.push({x:x+
1,y:A,side:"left",mask:I}),Q===J?f(x,A,H,S,g):f(x,A,H,g,Q),a.add(`${x},${A}`));break;case "left":for(D=I=e=0;8>D;D++){E=M(E,k[H][D]^P);if(0===E)break;E&32768&&(I|=M(128>>D,n[H][15]^d));E&1&&(e|=M(128>>D,n[H][0]^d))}0<D&&(E&&79!==x&&!a.has(`${x+1},${A}`)&&C.push({x:x+1,y:A,side:"left",mask:E}),e&&0!==A&&!a.has(`${x},${A-1}`)&&C.push({x,y:A-1,side:"bottom",mask:e}),I&&24!==A&&!a.has(`${x},${A+1}`)&&C.push({x,y:A+1,side:"top",mask:I}),Q===J?f(x,A,H,S,g):f(x,A,H,g,Q),a.add(`${x},${A}`));break;case "right":I=
e=0;for(D=7;0<=D;D--){E=M(E,k[H][D]^P);if(0===E)break;E&32768&&(I|=M(128>>D,n[H][15]^d));E&1&&(e|=M(128>>D,n[H][0]^d))}7>D&&(E&&0!==x&&!a.has(`${x-1},${A}`)&&C.push({x:x-1,y:A,side:"right",mask:E}),e&&0!==A&&!a.has(`${x},${A-1}`)&&C.push({x,y:A-1,side:"bottom",mask:e}),I&&24!==A&&!a.has(`${x},${A+1}`)&&C.push({x,y:A+1,side:"top",mask:I}),Q===J?f(x,A,H,S,g):f(x,A,H,g,Q),a.add(`${x},${A}`))}}}}}let pa=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var O;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=
3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(O||(O={}));var ea;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=
15]="White"})(ea||(ea={}));let qa="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class ua{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,d,h,f){if(!Number.isInteger(a)||!Number.isInteger(d))throw new TypeError("x and y must be integers");
if(!Number.isInteger(h)||!Number.isInteger(d))throw new TypeError("width and height must be integers");if(0>a||0>d||0>h||0>f||80<a+h||25<d+f)throw new RangeError("edges exceed screen");let n=new Uint16Array(h*f);for(let k=0;k<f;k++)n.set(this.buffer.subarray(80*(d+k)+a,80*(d+k)+a+h),k*h);return{data:n,width:h,height:f}}putBrush(a,d,h){let f,n,k=a.data;if(0>d){f=-d;if(f>=a.width)return;d=0}else f=0;n=Math.min(80-d,d+a.width);if(0>h){k=k.subarray(h*a.width);if(0===k.length)return;h=0}for(let g=0;g<
a.height;g++)if(!(0>h+g)){if(25<=h+g)break;this.buffer.set(k.subarray((h+g)*a.width+f,(h+g)*a.width+n),80*h+d);for(let e=f;e<n;e++)this.updateCanvas(h+g,d+e)}}updateCanvas(a,d){let h=this.buffer[80*d+a];this.drawChar(this.ctx,a,d,h&255,h>>8&15,h>>12&15)}getCharInfo(a,d){a=this.buffer[80*d+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,d){return this.buffer[80*d+a]&255}putChar(a,d,h,f,n){this.buffer[80*d+a]=h|f<<8|n<<12;this.updateCanvas(a,d)}setChar(a,d,h,f,n,k=O.All){this.buffer[80*
d+a]=this.buffer[80*d+a]&~k|(h|f<<8|n<<12)&k;this.updateCanvas(a,d)}fill(a,d,h,f=O.All){a=(a|d<<8|h<<12)&f;for(d=0;d<this.buffer.length;d++)this.buffer[d]=this.buffer[d]&~f|a,this.updateCanvas(d%80,Math.floor(d/80))}putVHalf(a,d,h){var f=this.buffer[80*(d>>1)+a];let n=f>>>8&15,k=f>>>12&15,g=d&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 220:f=1===g?k:n;break;case 223:f=1===g?n:k}f===h?this.putChar(a,d>>1,219,h,k):0===g?this.putChar(a,d>>1,223,h,f):this.putChar(a,d>>1,220,
h,f)}putHHalf(a,d,h){var f=this.buffer[80*d+(a>>1)];let n=f>>>8&15,k=f>>>12&15,g=a&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 222:f=1===g?k:n;break;case 221:f=1===g?n:k}f===h?this.putChar(a>>1,d,219,h,k):0===g?this.putChar(a>>1,d,221,h,f):this.putChar(a>>1,d,222,h,f)}saveBlob(){if(pa)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!pa)for(var d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(d=0;80>d;d++)this.updateCanvas(d,a)}}let ra=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,
202,203,206]),na=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),va=fetch("./chardata.png"),wa=a=>{var d=document.createElement("canvas");d.width=a.width;d.height=a.height;d=d.getContext("2d");if(!d)throw Error("unable to create 2D canvas");d.drawImage(a,0,0);var h=a.width/9;a=new Uint8Array(4096);for(let f=0;256>f;f++){const {data:n}=d.getImageData(f%h*9,16*Math.floor(f/h),8,16);for(let k=0;16>k;k++)a[16*f+k]=n[32*
k+3]?128:0,a[16*f+k]|=n[4*(8*k+1)+3]?64:0,a[16*f+k]|=n[4*(8*k+2)+3]?32:0,a[16*f+k]|=n[4*(8*k+3)+3]?16:0,a[16*f+k]|=n[4*(8*k+4)+3]?8:0,a[16*f+k]|=n[4*(8*k+5)+3]?4:0,a[16*f+k]|=n[4*(8*k+5)+3]?2:0,a[16*f+k]|=n[4*(8*k+7)+3]?1:0}d=Array(256);for(h=0;256>h;h++)d[h]=a.subarray(16*h,16*(h+1));return d},xa=a=>{const d=new Uint16Array(2048);for(var h=0;256>h;h++)for(let f=0;8>f;f++)for(let n=0;16>n;n++)d[8*h+f]|=(a[h][n]>>>7-f&1)<<n;a=Array(256);for(h=0;256>h;h++)a[h]=d.subarray(8*h,8*(h+1));return a};ea=[0,
9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,d)=>32+d),8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,
9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160];let ya=new Map(ea.map((a,d)=>[String.fromCodePoint(a),d]));window.addEventListener("DOMContentLoaded",async function(){var a=await (await va).blob();let d=await createImageBitmap(a),h=d.width/9,f=(b,c,l,w,u,y)=>{b.save();b.globalCompositeOperation=
"source-over";b.fillStyle=qa[y];b.fillRect(8*c,16*l,8,16);b.globalCompositeOperation="destination-out";b.drawImage(d,w%h*9,16*Math.floor(w/h),8,16,8*c,16*l,8,16);b.globalCompositeOperation="destination-over";b.fillStyle=qa[u];b.fillRect(8*c,16*l,8,16);b.restore()},n=wa(d),k=xa(n),g=new ua(f),e=document.getElementById("editor"),m=e.getContext("2d");if(!m)throw Error("unable to create canvas context");let v=O.All;document.getElementById("tile").onchange=b=>{v=b.target.checked?v|O.Tile:v&~O.Tile};document.getElementById("fgcolor").onchange=
b=>{v=b.target.checked?v|O.ForegroundColor:v&~O.ForegroundColor};document.getElementById("bgcolor").onchange=b=>{v=b.target.checked?v|O.BackgroundColor:v&~O.BackgroundColor};let q=[7,0,0],W=document.querySelector(".palette"),P=(b,c)=>{const l=c?"background-selected":"foreground-selected";var w=W.querySelectorAll(`.${l}`);for(let u=0;u<w.length;u++)w[u].classList.remove(l);(w=W.querySelector(`.color-cell[data-value='${b}']`))&&w.classList.add(l);q[c?2:0]=b};W.onpointerdown=b=>{if("mouse"===b.pointerType&&
(0===b.button||2===b.button)){var c=0===b.button?"foreground-selected":"background-selected";for(let l=b.target;l&&!l.classList.contains("palette");l=l.parentElement)if("value"in l.dataset){let w=W.querySelectorAll(`.${c}`);for(let u=0;u<w.length;u++)w[u].classList.remove(c);l.classList.add(c);q[b.button]=+l.dataset.value;b.preventDefault();b.stopPropagation();break}}};W.oncontextmenu=b=>{b.preventDefault()};let J=[219,0,0],C=0,G=0,D=document.querySelector(".cursor"),L=(b,c)=>{D.style.left=`${8*b}px`;
D.style.top=`${16*c}px`;C=b;G=c},I=document.querySelector("#editor-block"),X={freehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:B}=b;if(0===y||2===y){function F(t){t.pointerId===B&&t.button===y&&(e.removeEventListener("pointermove",p),e.removeEventListener("pointerup",F))}function p(t){if(t.pointerId===B){var r=Math.floor(80*(t.clientX-c.x)/c.width);t=Math.floor(25*(t.clientY-c.y)/c.height);for(const [z,K]of Y(w,u,r,t))g.setChar(z,K,J[y],q[0],q[2],v);m.drawImage(g.canvas,
0,0);w=r;u=t}}b.preventDefault();e.setPointerCapture(B);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width);b=Math.floor(25*(b.clientY-c.y)/c.height);g.setChar(l,b,J[y],q[0],q[2],v);m.drawImage(g.canvas,0,0);var w=l,u=b;e.addEventListener("pointermove",p);e.addEventListener("pointerup",F)}}}},vbFreehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:B}=b;if(0===y||2===y){function F(t){t.pointerId===B&&t.button===y&&(e.removeEventListener("pointermove",
p),e.removeEventListener("pointerup",F))}function p(t){if(t.pointerId===B){var r=Math.floor(80*(t.clientX-c.x)/c.width);t=Math.floor(50*(t.clientY-c.y)/c.height);for(const [z,K]of Y(w,u,r,t))g.putVHalf(z,K,q[y]);m.drawImage(g.canvas,0,0);w=r;u=t}}b.preventDefault();e.setPointerCapture(B);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width);b=Math.floor(50*(b.clientY-c.y)/c.height);g.putVHalf(l,b,q[y]);m.drawImage(g.canvas,0,0);var w=l,u=b;e.addEventListener("pointermove",p);e.addEventListener("pointerup",
F)}}}},hbFreehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:B}=b;if(0===y||2===y){function F(t){t.pointerId===B&&t.button===y&&(e.removeEventListener("pointermove",p),e.removeEventListener("pointerup",F))}function p(t){if(t.pointerId===B){var r=Math.floor(160*(t.clientX-c.x)/c.width);t=Math.floor(25*(t.clientY-c.y)/c.height);for(const [z,K]of Y(w,u,r,t))g.putHHalf(z,K,q[y]);m.drawImage(g.canvas,0,0);w=r;u=t}}b.preventDefault();e.setPointerCapture(B);var c=e.getBoundingClientRect(),
l=Math.floor(160*(b.clientX-c.x)/c.width);b=Math.floor(25*(b.clientY-c.y)/c.height);g.putHHalf(l,b,q[y]);m.drawImage(g.canvas,0,0);var w=l,u=b;e.addEventListener("pointermove",p);e.addEventListener("pointerup",F)}}}},lines:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:u,pointerId:y}=b;if(0===u||2===u){function B(p){if(p.pointerId===y&&p.button===u){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);for(const [r,z]of Y(l,w,t,p))g.setChar(r,z,
J[u],q[0],q[2],v);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(p){if(p.pointerId===y){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,z]of Y(l,w,t,p))f(m,r,z,J[u],q[0],q[2])}}b.preventDefault();e.setPointerCapture(y);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width),
w=Math.floor(25*(b.clientY-c.y)/c.height);f(m,l,w,J[u],q[0],q[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},filledBox:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:u,pointerId:y}=b;if(0===u||2===u){function B(p){if(p.pointerId===y&&p.button===u){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);for(const [r,z]of ca(l,w,t,p))g.setChar(r,z,J[u],q[0],q[2],v);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(p){if(p.pointerId===y){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,z]of ca(l,w,t,p))f(m,r,z,J[u],q[0],q[2])}}b.preventDefault();e.setPointerCapture(y);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width),w=Math.floor(25*(b.clientY-c.y)/c.height);f(m,l,w,J[u],q[0],q[2]);e.addEventListener("pointermove",
F);e.addEventListener("pointerup",B)}}}},emptyBox:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:u,pointerId:y}=b;if(0===u||2===u){function B(p){if(p.pointerId===y&&p.button===u){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);for(const [r,z]of oa(l,w,t,p))g.setChar(r,z,J[u],q[0],q[2],v);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(p){if(p.pointerId===
y){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,z]of oa(l,w,t,p))f(m,r,z,J[u],q[0],q[2])}}b.preventDefault();e.setPointerCapture(y);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width),w=Math.floor(25*(b.clientY-c.y)/c.height);f(m,l,w,J[u],q[0],q[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},singleBorder:()=>{e.onpointerdown=b=>{if("mouse"===
b.pointerType){const {button:u,pointerId:y}=b;if(0===u||2===u){function B(p){p.pointerId===y&&p.button===u&&(ba(l,w,Math.floor(80*(p.clientX-c.x)/c.width),Math.floor(25*(p.clientY-c.y)/c.height),(t,r)=>g.getChar(t,r),(t,r,z)=>g.putChar(t,r,z,q[0],q[2]),!1),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",F),e.removeEventListener("pointerup",B))}function F(p){if(p.pointerId===y){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/
c.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);ba(l,w,t,p,(r,z)=>g.getChar(r,z),(r,z,K)=>f(m,r,z,K,q[0],q[2]),!1)}}b.preventDefault();e.setPointerCapture(y);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width),w=Math.floor(25*(b.clientY-c.y)/c.height);f(m,l,w,N(15),q[0],q[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},doubleBorder:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:u,pointerId:y}=b;if(0===u||
2===u){function B(p){p.pointerId===y&&p.button===u&&(ba(l,w,Math.floor(80*(p.clientX-c.x)/c.width),Math.floor(25*(p.clientY-c.y)/c.height),(t,r)=>g.getChar(t,r),(t,r,z)=>g.putChar(t,r,z,q[0],q[2]),!0),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",F),e.removeEventListener("pointerup",B))}function F(p){if(p.pointerId===y){var t=Math.floor(80*(p.clientX-c.x)/c.width);p=Math.floor(25*(p.clientY-c.y)/c.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);ba(l,w,t,p,(r,z)=>g.getChar(r,z),(r,z,K)=>f(m,r,z,K,q[0],q[2]),!0)}}b.preventDefault();e.setPointerCapture(y);var c=e.getBoundingClientRect(),l=Math.floor(80*(b.clientX-c.x)/c.width),w=Math.floor(25*(b.clientY-c.y)/c.height);f(m,l,w,N(15),q[0],q[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},colorFloodFill:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:l}=b;if(0===l||2===l){b.preventDefault();var c=e.getBoundingClientRect();ta(80*(b.clientX-
c.x)/c.width,25*(b.clientY-c.y)/c.height,(w,u)=>g.getCharInfo(w,u),(w,u,y,B,F)=>g.putChar(w,u,y,B,F),n,k,q[l]);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0)}}}},pick:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:B}=b;if(0===y||2===y){function F(t){t.pointerId===B&&t.button===y&&(e.removeEventListener("pointermove",p),e.removeEventListener("pointerup",F))}function p(t){if(t.pointerId===B&&t.button===y){var r=e.getBoundingClientRect(),{charCode:z,fgColor:K,
bgColor:T}=g.getCharInfo(Math.floor(80*(t.clientX-r.x)/r.width),Math.floor(25*(t.clientY-r.y)/r.height));v&O.Tile&&ja(z,2===y);v&O.ForegroundColor&&P(K,!1);v&O.BackgroundColor&&P(T,!0)}}b.preventDefault();e.setPointerCapture(B);var c=e.getBoundingClientRect(),{charCode:l,fgColor:w,bgColor:u}=g.getCharInfo(Math.floor(80*(b.clientX-c.x)/c.width),Math.floor(25*(b.clientY-c.y)/c.height));v&O.Tile&&ja(l,2===y);v&O.ForegroundColor&&P(w,!1);v&O.BackgroundColor&&P(u,!0);e.addEventListener("pointermove",p);
e.addEventListener("pointerup",F)}}}},text:()=>{function b(c){if("Tab"!==c.key){c.preventDefault();c.stopPropagation();switch(c.key){case "ArrowDown":L(C,Math.min(G+1,24));return;case "ArrowUp":L(C,Math.max(G-1,0));return;case "ArrowLeft":0===C?0!==G&&L(79,G-1):L(C-1,G);return;case "ArrowRight":79===C?24!==G&&L(0,G+1):L(C+1,G);return;case "Enter":L(0,Math.min(24,G+1));return;case "End":case "PageDown":L(C,24);return;case "Home":case "PageUp":L(C,0);return;case "Backspace":0===C?0!==G&&L(79,G-1):L(C-
1,G);g.setChar(C,G,0,q[0],q[2],v);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return;case "Delete":g.setChar(C,G,0,q[0],q[2],v);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return}c=ya.get(c.key);"number"===typeof c&&(g.setChar(C,G,c,q[0],q[2],v),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),79===C?24!==G&&L(0,G+1):L(C+1,G))}}I.focus();e.onpointerdown=c=>{if("mouse"===c.pointerType){var {button:l}=c;0===l&&(c.preventDefault(),l=e.getBoundingClientRect(),
L(Math.floor(80*(c.clientX-l.x)/l.width),Math.floor(25*(c.clientY-l.y)/l.height)),I.focus())}};I.addEventListener("keydown",b);return()=>{I.removeEventListener("keydown",b)}},gradientBox:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:B,pointerId:F}=b;if(0===B||2===B){function p(r){if(r.pointerId===F&&r.button===B){var z=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);var [K,T]=w<z?[w,z]:[z,w],[U,V]=u<r?[u,r]:[r,u];for(const [Z,aa]of ca(w,u,z,r)){z=
y(Z,aa,K,T,U,V);const {charCode:ka,fgColor:la,bgColor:ma}=Q(c,z);g.putChar(Z,aa,ka,la,ma)}m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",t);e.removeEventListener("pointerup",p)}}function t(r){if(r.pointerId===F){var z=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);var [K,T]=w<z?[w,z]:[z,w],[U,V]=u<r?[u,r]:[r,u];for(const [Z,aa]of ca(w,u,z,r)){z=y(Z,aa,K,T,
U,V);const {charCode:ka,fgColor:la,bgColor:ma}=Q(c,z);f(m,Z,aa,ka,la,ma)}}}var c=H();if(0!==c.length){b.preventDefault();e.setPointerCapture(F);var l=e.getBoundingClientRect(),w=Math.floor(80*(b.clientX-l.x)/l.width),u=Math.floor(25*(b.clientY-l.y)/l.height);f(m,w,u,219,c[0],0);b=document.getElementById("gradient-direction-selector");var y="up"===b.value?(r,z,K,T,U,V)=>(z-V)/(U-V):"right"===b.value?(r,z,K,T,U,V)=>(r-K)/(T-K):"left"===b.value?(r,z,K,T,U,V)=>(r-T)/(K-T):(r,z,K,T,U,V)=>(z-U)/(V-U);e.addEventListener("pointermove",
t);e.addEventListener("pointerup",p)}}}}}},x=document.getElementById("add-gradient-slot"),A=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),da=document.querySelector(".gradient-slots"),E=b=>{const c=A.cloneNode(!0);c.dataset.value=String(b);c.querySelector(".remove-gradient-slot").onclick=()=>{da.removeChild(c)};da.insertBefore(c,x)};x.onclick=()=>{E(q[0])};E(0);E(8);E(7);E(15);let H=()=>{const b=document.querySelectorAll(".gradient-slots .gradient-slot"),
c=[];for(let l=0;l<b.length;l++)c.push(Number(b[l].dataset.value));return c},Q=(b,c)=>{if(2>b.length)return{charCode:219,fgColor:b[0]||0,bgColor:0};c=Math.max(0,Math.min(1,Number(c)||0));c*=b.length;const l=Math.floor(c);if(l>=b.length-1)return{charCode:219,fgColor:b[b.length-1],bgColor:0};c-=l;return.125>c?{charCode:0,fgColor:b[l+1],bgColor:b[l]}:.375>c?{charCode:176,fgColor:b[l+1],bgColor:b[l]}:.625>c?{charCode:177,fgColor:b[l+1],bgColor:b[l]}:.875>c?{charCode:178,fgColor:b[l+1],bgColor:b[l]}:{charCode:219,
fgColor:b[l+1],bgColor:0}},S;S=X.freehand();let fa=document.getElementById("tool-selector"),ha=fa.value;document.body.classList.add("tool-"+ha);fa.onchange=b=>{S&&S();S=X[fa.value]();document.body.classList.remove("tool-"+ha);ha=fa.value;document.body.classList.add("tool-"+ha)};e.oncontextmenu=b=>{b.preventDefault()};let ia=document.getElementById("char-picker"),za=document.querySelector(".left-pick"),Aa=document.querySelector(".right-pick"),ja=(b,c)=>{const l=Math.floor(b/64),w=c?Aa:za;w.style.left=
`${b%64*8}px`;w.style.top=`${16*l}px`;J[c?2:0]=b};a=ia.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let b=0;256>b;b++)f(a,b%64,Math.floor(b/64),b,7,0);ia.onpointerdown=b=>{if("mouse"===b.pointerType&&(0===b.button||2===b.button)){var c=ia.getBoundingClientRect();ja(64*Math.floor(4*(b.clientY-c.y)/c.height)+Math.floor(64*(b.clientX-c.x)/c.width),2===b.button)}};ia.oncontextmenu=b=>{b.preventDefault()};document.getElementById("save-image").onclick=b=>{b=g.saveBlob();b=URL.createObjectURL(b);
let c=document.createElement("a");c.download="dosimage.dat";c.href=b;c.click()};document.getElementById("load-image").onclick=async b=>{if(b=await sa()){try{await g.loadBlob(b)}catch(c){alert(c);return}m.drawImage(g.canvas,0,0)}};document.getElementById("clear-image").onclick=b=>{g.fill(J[2],q[0],q[2],v);m.drawImage(g.canvas,0,0)}},{once:!0})})()
