'use strict';(function(){function*C(a,c,f,g){let h=Math.abs(f-a),e=Math.abs(g-c),k=a<f?1:-1,u=c<g?1:-1,q=h-e;for(;;){yield[a,c];if(a===f&&c===g)break;let B=2*q;B>-e&&(q-=e,a+=k);B<h&&(q+=h,c+=u)}}function*H(a,c,f,g){let h=Math.sign(f-a),e=Math.sign(g-c);if(0===h)if(0===e)yield[a,c];else for(f=c;f!==g+e;f+=e)yield[a,f];else if(0===e)for(;a!==f+h;a+=h)yield[a,c];else for(;c!==g+e;c+=e)for(let k=a;k!==f+h;k+=h)yield[k,c]}function*I(a,c,f,g){let h=Math.sign(f-a),e=Math.sign(g-c);if(0===h)if(0===e)yield[a,
c];else for(f=c;f!==g+e;f+=e)yield[a,f];else if(0===e)for(g=a;g!==f+h;g+=h)yield[g,c];else{for(let k=a;k!==f+h;k+=h)yield[k,c];for(c+=e;c!==g;c+=e)yield[a,c],yield[f,c];for(;a!==f+h;a+=h)yield[a,g]}}function N(){return new Promise((a,c)=>{let f=document.createElement("input");f.type="file";f.onchange=g=>{var h;(null===(h=f.files)||void 0===h?0:h.length)?a(f.files[0]):a(null)};f.click()})}let J=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var A;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=
3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(A||(A={}));var K;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]=
"White"})(K||(K={}));let L="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class O{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,c,f,g){if(!Number.isInteger(a)||!Number.isInteger(c))throw new TypeError("x and y must be integers");
if(!Number.isInteger(f)||!Number.isInteger(c))throw new TypeError("width and height must be integers");if(0>a||0>c||0>f||0>g||80<a+f||25<c+g)throw new RangeError("edges exceed screen");let h=new Uint16Array(f*g);for(let e=0;e<g;e++)h.set(this.buffer.subarray(80*(c+e)+a,80*(c+e)+a+f),e*f);return{data:h,width:f,height:g}}putBrush(a,c,f){let g,h,e=a.data;if(0>c){g=-c;if(g>=a.width)return;c=0}else g=0;h=Math.min(80-c,c+a.width);if(0>f){e=e.subarray(f*a.width);if(0===e.length)return;f=0}for(let k=0;k<
a.height;k++)if(!(0>f+k)){if(25<=f+k)break;this.buffer.set(e.subarray((f+k)*a.width+g,(f+k)*a.width+h),80*f+c);for(let u=g;u<h;u++)this.updateCanvas(f+k,c+u)}}updateCanvas(a,c){let f=this.buffer[80*c+a];this.drawChar(this.ctx,a,c,f&255,f>>8&15,f>>12&15)}getCharInfo(a,c){a=this.buffer[80*c+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}putChar(a,c,f,g,h){this.buffer[80*c+a]=f|g<<8|h<<12;this.updateCanvas(a,c)}setChar(a,c,f,g,h,e=A.All){this.buffer[80*c+a]=this.buffer[80*c+a]&~e|(f|g<<8|
h<<12)&e;this.updateCanvas(a,c)}fill(a,c,f,g=A.All){a=(a|c<<8|f<<12)&g;for(c=0;c<this.buffer.length;c++)this.buffer[c]=this.buffer[c]&~g|a,this.updateCanvas(c%80,Math.floor(c/80))}putVHalf(a,c,f){var g=this.buffer[80*(c>>1)+a];let h=g>>>8&15,e=g>>>12&15,k=c&1;switch(g&255){case 219:case 8:case 10:g=h;break;default:g=e;break;case 220:g=1===k?e:h;break;case 223:g=1===k?h:e}g===f?this.putChar(a,c>>1,219,f,e):0===k?this.putChar(a,c>>1,223,f,g):this.putChar(a,c>>1,220,f,g)}putHHalf(a,c,f){var g=this.buffer[80*
c+(a>>1)];let h=g>>>8&15,e=g>>>12&15,k=a&1;switch(g&255){case 219:case 8:case 10:g=h;break;default:g=e;break;case 222:g=1===k?e:h;break;case 221:g=1===k?h:e}g===f?this.putChar(a>>1,c,219,f,e):0===k?this.putChar(a>>1,c,221,f,g):this.putChar(a>>1,c,222,f,g)}saveBlob(){if(J)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=await a.arrayBuffer();if(a.byteLength!==
this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!J)for(var c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(c=0;80>c;c++)this.updateCanvas(c,a)}}let P=fetch("./chardata.png");window.addEventListener("DOMContentLoaded",async function(){var a=await (await P).blob();let c=await createImageBitmap(a),f=c.width/9,g=(b,d,n,t,p,r)=>{b.save();b.globalCompositeOperation="source-over";b.fillStyle=L[r];b.fillRect(8*d,16*n,8,16);b.globalCompositeOperation=
"destination-out";b.drawImage(c,t%f*9,16*Math.floor(t/f),8,16,8*d,16*n,8,16);b.globalCompositeOperation="destination-over";b.fillStyle=L[p];b.fillRect(8*d,16*n,8,16);b.restore()},h=new O(g),e=document.getElementById("editor"),k=e.getContext("2d");if(!k)throw Error("unable to create canvas context");let u=A.All;document.getElementById("tile").onchange=b=>{u=b.target.checked?u|A.Tile:u&~A.Tile};document.getElementById("fgcolor").onchange=b=>{u=b.target.checked?u|A.ForegroundColor:u&~A.ForegroundColor};
document.getElementById("bgcolor").onchange=b=>{u=b.target.checked?u|A.BackgroundColor:u&~A.BackgroundColor};let q=[7,0,0],B=document.querySelector(".palette");B.onpointerdown=b=>{if("mouse"===b.pointerType&&(0===b.button||2===b.button)){var d=0===b.button?"foreground-selected":"background-selected";for(let n=b.target;n&&!n.classList.contains("palette");n=n.parentElement)if("value"in n.dataset){let t=B.querySelectorAll(`.${d}`);for(let p=0;p<t.length;p++)t[p].classList.remove(d);n.classList.add(d);
q[b.button]=+n.dataset.value;b.preventDefault();b.stopPropagation();break}}};B.oncontextmenu=b=>{b.preventDefault()};let z=[219,0,0],M={freehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:r,pointerId:v}=b;if(0===r||2===r){function x(m){m.pointerId===v&&m.button===r&&(e.removeEventListener("pointermove",l),e.removeEventListener("pointerup",x))}function l(m){if(m.pointerId===v){var w=Math.floor(80*(m.clientX-d.x)/d.width);m=Math.floor(25*(m.clientY-d.y)/d.height);for(const [y,
D]of C(t,p,w,m))h.setChar(y,D,z[r],q[0],q[2],u);k.drawImage(h.canvas,0,0);t=w;p=m}}e.setPointerCapture(v);var d=e.getBoundingClientRect(),n=Math.floor(80*(b.clientX-d.x)/d.width);b=Math.floor(25*(b.clientY-d.y)/d.height);h.setChar(n,b,z[r],q[0],q[2],u);k.drawImage(h.canvas,0,0);var t=n,p=b;e.addEventListener("pointermove",l);e.addEventListener("pointerup",x)}}}},vbFreehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:r,pointerId:v}=b;if(0===r||2===r){function x(m){m.pointerId===
v&&m.button===r&&(e.removeEventListener("pointermove",l),e.removeEventListener("pointerup",x))}function l(m){if(m.pointerId===v){var w=Math.floor(80*(m.clientX-d.x)/d.width);m=Math.floor(50*(m.clientY-d.y)/d.height);for(const [y,D]of C(t,p,w,m))h.putVHalf(y,D,q[r]);k.drawImage(h.canvas,0,0);t=w;p=m}}e.setPointerCapture(v);var d=e.getBoundingClientRect(),n=Math.floor(80*(b.clientX-d.x)/d.width);b=Math.floor(50*(b.clientY-d.y)/d.height);h.putVHalf(n,b,q[r]);k.drawImage(h.canvas,0,0);var t=n,p=b;e.addEventListener("pointermove",
l);e.addEventListener("pointerup",x)}}}},hbFreehand:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:r,pointerId:v}=b;if(0===r||2===r){function x(m){m.pointerId===v&&m.button===r&&(e.removeEventListener("pointermove",l),e.removeEventListener("pointerup",x))}function l(m){if(m.pointerId===v){var w=Math.floor(160*(m.clientX-d.x)/d.width);m=Math.floor(25*(m.clientY-d.y)/d.height);for(const [y,D]of C(t,p,w,m))h.putHHalf(y,D,q[r]);k.drawImage(h.canvas,0,0);t=w;p=m}}e.setPointerCapture(v);
var d=e.getBoundingClientRect(),n=Math.floor(160*(b.clientX-d.x)/d.width);b=Math.floor(25*(b.clientY-d.y)/d.height);h.putHHalf(n,b,q[r]);k.drawImage(h.canvas,0,0);var t=n,p=b;e.addEventListener("pointermove",l);e.addEventListener("pointerup",x)}}}},lines:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:p,pointerId:r}=b;if(0===p||2===p){function v(l){if(l.pointerId===r&&l.button===p){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [w,
y]of C(n,t,m,l))h.setChar(w,y,z[p],q[0],q[2],u);k.globalCompositeOperation="copy";k.drawImage(h.canvas,0,0);e.removeEventListener("pointermove",x);e.removeEventListener("pointerup",v)}}function x(l){if(l.pointerId===r){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(h.canvas,0,0);for(const [w,y]of C(n,t,m,l))g(k,w,y,z[p],q[0],q[2])}}e.setPointerCapture(r);var d=e.getBoundingClientRect(),n=Math.floor(80*(b.clientX-
d.x)/d.width),t=Math.floor(25*(b.clientY-d.y)/d.height);g(k,n,t,z[p],q[0],q[2]);e.addEventListener("pointermove",x);e.addEventListener("pointerup",v)}}}},filledBox:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:p,pointerId:r}=b;if(0===p||2===p){function v(l){if(l.pointerId===r&&l.button===p){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [w,y]of H(n,t,m,l))h.setChar(w,y,z[p],q[0],q[2],u);k.globalCompositeOperation="copy";k.drawImage(h.canvas,
0,0);e.removeEventListener("pointermove",x);e.removeEventListener("pointerup",v)}}function x(l){if(l.pointerId===r){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(h.canvas,0,0);for(const [w,y]of H(n,t,m,l))g(k,w,y,z[p],q[0],q[2])}}e.setPointerCapture(r);var d=e.getBoundingClientRect(),n=Math.floor(80*(b.clientX-d.x)/d.width),t=Math.floor(25*(b.clientY-d.y)/d.height);g(k,n,t,z[p],q[0],q[2]);e.addEventListener("pointermove",
x);e.addEventListener("pointerup",v)}}}},emptyBox:()=>{e.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:p,pointerId:r}=b;if(0===p||2===p){function v(l){if(l.pointerId===r&&l.button===p){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [w,y]of I(n,t,m,l))h.setChar(w,y,z[p],q[0],q[2],u);k.globalCompositeOperation="copy";k.drawImage(h.canvas,0,0);e.removeEventListener("pointermove",x);e.removeEventListener("pointerup",v)}}function x(l){if(l.pointerId===
r){var m=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(h.canvas,0,0);for(const [w,y]of I(n,t,m,l))g(k,w,y,z[p],q[0],q[2])}}e.setPointerCapture(r);var d=e.getBoundingClientRect(),n=Math.floor(80*(b.clientX-d.x)/d.width),t=Math.floor(25*(b.clientY-d.y)/d.height);g(k,n,t,z[p],q[0],q[2]);e.addEventListener("pointermove",x);e.addEventListener("pointerup",v)}}}}};M.freehand();let E=document.getElementById("tool-selector"),
F=E.value;document.body.classList.add("tool-"+F);E.onchange=b=>{M[E.value]();document.body.classList.remove("tool-"+F);F=E.value;document.body.classList.add("tool-"+F)};e.oncontextmenu=b=>{b.preventDefault()};let G=document.getElementById("char-picker");a=G.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let b=0;256>b;b++)g(a,b%64,Math.floor(b/64),b,7,0);let Q=document.querySelector(".left-pick"),R=document.querySelector(".right-pick");G.onpointerdown=b=>{if("mouse"===b.pointerType&&
(0===b.button||2===b.button)){var d=G.getBoundingClientRect(),n=Math.floor(64*(b.clientX-d.x)/d.width);d=Math.floor(4*(b.clientY-d.y)/d.height);var t=2===b.button?R:Q;z[b.button]=64*d+n;t.style.left=`${8*n}px`;t.style.top=`${16*d}px`}};G.oncontextmenu=b=>{b.preventDefault()};document.getElementById("save-image").onclick=b=>{b=h.saveBlob();b=URL.createObjectURL(b);let d=document.createElement("a");d.download="dosimage.dat";d.href=b;d.click()};document.getElementById("load-image").onclick=async b=>
{if(b=await N()){try{await h.loadBlob(b)}catch(d){alert(d);return}k.drawImage(h.canvas,0,0)}};document.getElementById("clear-image").onclick=b=>{h.fill(z[2],q[0],q[2],u);k.drawImage(h.canvas,0,0)}},{once:!0})})()
