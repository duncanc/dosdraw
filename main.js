'use strict';(function(){function W(a){a-=179;return!Number.isInteger(a)||0>a||a>=oa.length?0:oa[a]}function S(a){return ta[a]||0}function da(a,d,h,f,n,k,g){let [e,m]=a<h?[a,h]:[h,a],[w,t]=d<f?[d,f]:[f,d];a=g?32:0;g=g?16:0;if(w===t)if(e===m)k(e,w,S(15));else{k(e,w,S(W(n(e,w))&-33|8|a));for(g=e+1;g<m;g++)k(g,w,S(W(n(g,w))&-33|12|a));k(m,w,S(W(n(m,w))&-33|4|a))}else if(e===m){k(e,w,S(W(n(e,w))&-17|2|g));for(a=w+1;a<t;a++)k(e,a,S(W(n(e,a))&-17|3|g));k(e,t,S(W(n(e,t))&-17|1|g))}else{k(e,w,S(W(n(e,w))&
-49|10|a|g));for(d=e+1;d<m;d++)k(d,w,S(W(n(d,w))&-33|12|a));k(m,w,S(W(n(m,w))&-49|6|a|g));for(d=w+1;d<t;d++)k(e,d,S(W(n(e,d))&-17|3|g)),k(m,d,S(W(n(m,d))&-17|3|g));k(e,t,S(W(n(e,t))&-49|9|a|g));for(d=e+1;d<m;d++)k(d,t,S(W(n(d,t))&-33|12|a));k(m,t,S(W(n(m,t))&-49|5|g|a))}}function*ca(a,d,h,f){let n=Math.abs(h-a),k=Math.abs(f-d),g=a<h?1:-1,e=d<f?1:-1,m=n-k;for(;;){yield[a,d];if(a===h&&d===f)break;let w=2*m;w>-k&&(m-=k,a+=g);w<n&&(m+=n,d+=e)}}function*ea(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);
if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(;a!==h+n;a+=n)yield[a,d];else for(;d!==f+k;d+=k)for(let g=a;g!==h+n;g+=n)yield[g,d]}function*pa(a,d,h,f){let n=Math.sign(h-a),k=Math.sign(f-d);if(0===n)if(0===k)yield[a,d];else for(h=d;h!==f+k;h+=k)yield[a,h];else if(0===k)for(f=a;f!==h+n;f+=n)yield[f,d];else{for(let g=a;g!==h+n;g+=n)yield[g,d];for(d+=k;d!==f;d+=k)yield[a,d],yield[h,d];for(;a!==h+n;a+=n)yield[a,f]}}function ua(){return new Promise((a,d)=>{let h=document.createElement("input");
h.type="file";h.onchange=f=>{var n;(null===(n=h.files)||void 0===n?0:n.length)?a(h.files[0]):a(null)};h.click()})}function Q(a,d){let h=0;for(;a&d;){var f=Math.clz32(d);f=32-Math.clz32(~d<<f>>>f);f=d>>>f<<f;f&a&&(h|=f,a&=~f);d&=~f}return h}function va(a,d,h,f,n,k,g){if(!(0>a||0>d||80<=a||25<=d)){var e=Math.floor(a%1*8),m=Math.floor(d%1*8);a=Math.floor(a);d=Math.floor(d);var {charCode:w,bgColor:t,fgColor:Z}=h(a,d);if(t===Z||32===w||255===w)w=0;var U=!!(n[w][m]&128>>>e),N=U?Z:t,D=[],L=U?0:255,F=U?0:
65535,X=Q(128>>>e,n[w][m]^L),G=Q(32768>>>m,k[w][e]^F);a:if(0!==d){var aa=X;for(let z=m-1;0<=z;z--)if(aa=Q(aa,n[w][z]^L),0===aa)break a;D.push({x:a,y:d-1,side:"bottom",mask:aa})}a:if(24!==d){for(m+=1;8>m;m++)if(X=Q(X,n[w][m]^L),0===X)break a;D.push({x:a,y:d+1,side:"top",mask:X})}a:if(0!==a){L=G;for(m=e-1;0<=m;m--)if(L=Q(L,k[w][m]^F),0===L)break a;D.push({x:a-1,y:d,side:"right",mask:L})}a:if(79!==a){for(e+=1;8>e;e++)if(G=Q(G,k[w][e]^F),0===G)break a;D.push({x:a+1,y:d,side:"left",mask:G})}U?f(a,d,w,
g,t):f(a,d,w,Z,g);for(a=new Set([`${a},${d}`]);0<D.length;){let {x:z,y:B,side:fa,mask:I}=D.pop(),{charCode:J,bgColor:O,fgColor:Y}=h(z,B);if(O!==N&&Y!==N||177===J||176===J&&O!==N||178===J&&Y!==N)a.add(`${z},${B}`);else{if(Y===O||32===J||255===J)J=0;d=O===N?255:0;U=O===N?65535:0;switch(fa){case "top":for(F=G=e=0;16>F;F++){I=Q(I,n[J][F]^d);if(0===I)break;I&128&&(e|=Q(1<<F,k[J][0]^U));I&1&&(G|=Q(1<<F,k[J][7]^U))}0<F&&(I&&24!==B&&!a.has(`${z},${B+1}`)&&D.push({x:z,y:B+1,side:"top",mask:I}),e&&0!==z&&!a.has(`${z-
1},${B}`)&&D.push({x:z-1,y:B,side:"right",mask:e}),G&&79!==z&&!a.has(`${z+1},${B}`)&&D.push({x:z+1,y:B,side:"left",mask:G}),O===N?f(z,B,J,Y,g):f(z,B,J,g,O),a.add(`${z},${B}`));break;case "bottom":G=e=0;for(F=15;0<=F;F--){I=Q(I,n[J][F]^d);if(0===I)break;I&128&&(e|=Q(1<<F,k[J][0]^U));I&1&&(G|=Q(1<<F,k[J][7]^U))}15>F&&(I&&0!==B&&!a.has(`${z},${B-1}`)&&D.push({x:z,y:B-1,side:"bottom",mask:I}),e&&0!==z&&!a.has(`${z-1},${B}`)&&D.push({x:z-1,y:B,side:"right",mask:e}),G&&79!==z&&!a.has(`${z+1},${B}`)&&D.push({x:z+
1,y:B,side:"left",mask:G}),O===N?f(z,B,J,Y,g):f(z,B,J,g,O),a.add(`${z},${B}`));break;case "left":for(F=G=e=0;8>F;F++){I=Q(I,k[J][F]^U);if(0===I)break;I&32768&&(G|=Q(128>>F,n[J][15]^d));I&1&&(e|=Q(128>>F,n[J][0]^d))}0<F&&(I&&79!==z&&!a.has(`${z+1},${B}`)&&D.push({x:z+1,y:B,side:"left",mask:I}),e&&0!==B&&!a.has(`${z},${B-1}`)&&D.push({x:z,y:B-1,side:"bottom",mask:e}),G&&24!==B&&!a.has(`${z},${B+1}`)&&D.push({x:z,y:B+1,side:"top",mask:G}),O===N?f(z,B,J,Y,g):f(z,B,J,g,O),a.add(`${z},${B}`));break;case "right":G=
e=0;for(F=7;0<=F;F--){I=Q(I,k[J][F]^U);if(0===I)break;I&32768&&(G|=Q(128>>F,n[J][15]^d));I&1&&(e|=Q(128>>F,n[J][0]^d))}7>F&&(I&&0!==z&&!a.has(`${z-1},${B}`)&&D.push({x:z-1,y:B,side:"right",mask:I}),e&&0!==B&&!a.has(`${z},${B-1}`)&&D.push({x:z,y:B-1,side:"bottom",mask:e}),G&&24!==B&&!a.has(`${z},${B+1}`)&&D.push({x:z,y:B+1,side:"top",mask:G}),O===N?f(z,B,J,Y,g):f(z,B,J,g,O),a.add(`${z},${B}`))}}}}}let qa=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var T;(function(a){a[a.Tile=255]="Tile";
a[a.ForegroundColor=3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(T||(T={}));var ha;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]=
"Yellow";a[a.White=15]="White"})(ha||(ha={}));let ra="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class wa{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,d,h,f){if(!Number.isInteger(a)||!Number.isInteger(d))throw new TypeError("x and y must be integers");
if(!Number.isInteger(h)||!Number.isInteger(d))throw new TypeError("width and height must be integers");if(0>a||0>d||0>h||0>f||80<a+h||25<d+f)throw new RangeError("edges exceed screen");let n=new Uint16Array(h*f);for(let k=0;k<f;k++)n.set(this.buffer.subarray(80*(d+k)+a,80*(d+k)+a+h),k*h);return{data:n,width:h,height:f}}putBrush(a,d,h){let f,n,k=a.data;if(0>d){f=-d;if(f>=a.width)return;d=0}else f=0;n=Math.min(80-d,d+a.width);if(0>h){k=k.subarray(h*a.width);if(0===k.length)return;h=0}for(let g=0;g<
a.height;g++)if(!(0>h+g)){if(25<=h+g)break;this.buffer.set(k.subarray((h+g)*a.width+f,(h+g)*a.width+n),80*h+d);for(let e=f;e<n;e++)this.updateCanvas(h+g,d+e)}}updateCanvas(a,d){let h=this.buffer[80*d+a];this.drawChar(this.ctx,a,d,h&255,h>>8&15,h>>12&15)}getCharInfo(a,d){a=this.buffer[80*d+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,d){return this.buffer[80*d+a]&255}putChar(a,d,h,f,n){this.buffer[80*d+a]=h|f<<8|n<<12;this.updateCanvas(a,d)}setChar(a,d,h,f,n,k=T.All){this.buffer[80*
d+a]=this.buffer[80*d+a]&~k|(h|f<<8|n<<12)&k;this.updateCanvas(a,d)}fill(a,d,h,f=T.All){a=(a|d<<8|h<<12)&f;for(d=0;d<this.buffer.length;d++)this.buffer[d]=this.buffer[d]&~f|a,this.updateCanvas(d%80,Math.floor(d/80))}putVHalf(a,d,h){var f=this.buffer[80*(d>>1)+a];let n=f>>>8&15,k=f>>>12&15,g=d&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 220:f=1===g?k:n;break;case 223:f=1===g?n:k}f===h?this.putChar(a,d>>1,219,h,k):0===g?this.putChar(a,d>>1,223,h,f):this.putChar(a,d>>1,220,
h,f)}putHHalf(a,d,h){var f=this.buffer[80*d+(a>>1)];let n=f>>>8&15,k=f>>>12&15,g=a&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 222:f=1===g?k:n;break;case 221:f=1===g?n:k}f===h?this.putChar(a>>1,d,219,h,k):0===g?this.putChar(a>>1,d,221,h,f):this.putChar(a>>1,d,222,h,f)}saveBlob(){if(qa)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!qa)for(var d=0;d<a.length;d++)a[d]=a[d]>>8|a[d]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(d=0;80>d;d++)this.updateCanvas(d,a)}}let ta=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,
202,203,206]),oa=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),xa=fetch("./chardata.png"),ya=a=>{var d=document.createElement("canvas");d.width=a.width;d.height=a.height;d=d.getContext("2d");if(!d)throw Error("unable to create 2D canvas");d.drawImage(a,0,0);var h=a.width/9;a=new Uint8Array(4096);for(let f=0;256>f;f++){const {data:n}=d.getImageData(f%h*9,16*Math.floor(f/h),8,16);for(let k=0;16>k;k++)a[16*f+k]=n[32*
k+3]?128:0,a[16*f+k]|=n[4*(8*k+1)+3]?64:0,a[16*f+k]|=n[4*(8*k+2)+3]?32:0,a[16*f+k]|=n[4*(8*k+3)+3]?16:0,a[16*f+k]|=n[4*(8*k+4)+3]?8:0,a[16*f+k]|=n[4*(8*k+5)+3]?4:0,a[16*f+k]|=n[4*(8*k+5)+3]?2:0,a[16*f+k]|=n[4*(8*k+7)+3]?1:0}d=Array(256);for(h=0;256>h;h++)d[h]=a.subarray(16*h,16*(h+1));return d},za=a=>{const d=new Uint16Array(2048);for(var h=0;256>h;h++)for(let f=0;8>f;f++)for(let n=0;16>n;n++)d[8*h+f]|=(a[h][n]>>>7-f&1)<<n;a=Array(256);for(h=0;256>h;h++)a[h]=d.subarray(8*h,8*(h+1));return a};ha=[0,
9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,d)=>32+d),8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,
9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160];let Aa=new Map(ha.map((a,d)=>[String.fromCodePoint(a),d]));window.addEventListener("DOMContentLoaded",async function(){var a=await (await xa).blob();let d=await createImageBitmap(a),h=d.width/9,f=(c,b,l,v,p,y)=>{c.save();c.globalCompositeOperation=
"source-over";c.fillStyle=ra[y];c.fillRect(8*b,16*l,8,16);c.globalCompositeOperation="destination-out";c.drawImage(d,v%h*9,16*Math.floor(v/h),8,16,8*b,16*l,8,16);c.globalCompositeOperation="destination-over";c.fillStyle=ra[p];c.fillRect(8*b,16*l,8,16);c.restore()},n=ya(d),k=za(n),g=new wa(f),e=document.getElementById("editor"),m=e.getContext("2d");if(!m)throw Error("unable to create canvas context");let w=T.All;document.getElementById("tile").onchange=c=>{w=c.target.checked?w|T.Tile:w&~T.Tile};document.getElementById("fgcolor").onchange=
c=>{w=c.target.checked?w|T.ForegroundColor:w&~T.ForegroundColor};document.getElementById("bgcolor").onchange=c=>{w=c.target.checked?w|T.BackgroundColor:w&~T.BackgroundColor};let t=[7,0,0],Z=document.querySelector(".palette"),U=(c,b)=>{const l=b?"background-selected":"foreground-selected";var v=Z.querySelectorAll(`.${l}`);for(let p=0;p<v.length;p++)v[p].classList.remove(l);(v=Z.querySelector(`.color-cell[data-value='${c}']`))&&v.classList.add(l);t[b?2:0]=c};Z.onpointerdown=c=>{if("mouse"===c.pointerType&&
(0===c.button||2===c.button)){var b=0===c.button?"foreground-selected":"background-selected";for(let l=c.target;l&&!l.classList.contains("palette");l=l.parentElement)if("value"in l.dataset){let v=Z.querySelectorAll(`.${b}`);for(let p=0;p<v.length;p++)v[p].classList.remove(b);l.classList.add(b);t[c.button]=+l.dataset.value;c.preventDefault();c.stopPropagation();break}}};Z.oncontextmenu=c=>{c.preventDefault()};let N=[219,0,0],D=0,L=0,F=0,X=document.querySelector(".cursor"),G=(c,b)=>{X.style.left=`${8*
c}px`;X.style.top=`${16*b}px`;X.style.animation="none";X.getBoundingClientRect();X.style.removeProperty("animation");D=c;L=b},aa=document.querySelector("#editor-block"),z="freehand",B={freehand:()=>{z="freehand";e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:E}=c;if(0===y||2===y){function A(u){u.pointerId===E&&u.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",A))}function q(u){if(u.pointerId===E){var r=Math.floor(80*(u.clientX-b.x)/
b.width);u=Math.floor(25*(u.clientY-b.y)/b.height);for(const [x,H]of ca(v,p,r,u))g.setChar(x,H,N[y],t[0],t[2],w);m.drawImage(g.canvas,0,0);v=r;p=u}}c.preventDefault();e.setPointerCapture(E);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width);c=Math.floor(25*(c.clientY-b.y)/b.height);g.setChar(l,c,N[y],t[0],t[2],w);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",A)}}}},vbFreehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,
pointerId:E}=c;if(0===y||2===y){function A(u){u.pointerId===E&&u.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",A))}function q(u){if(u.pointerId===E){var r=Math.floor(80*(u.clientX-b.x)/b.width);u=Math.floor(50*(u.clientY-b.y)/b.height);for(const [x,H]of ca(v,p,r,u))g.putVHalf(x,H,t[y]);m.drawImage(g.canvas,0,0);v=r;p=u}}c.preventDefault();e.setPointerCapture(E);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width);c=Math.floor(50*(c.clientY-
b.y)/b.height);g.putVHalf(l,c,t[y]);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",A)}}}},hbFreehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:E}=c;if(0===y||2===y){function A(u){u.pointerId===E&&u.button===y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",A))}function q(u){if(u.pointerId===E){var r=Math.floor(160*(u.clientX-b.x)/b.width);u=Math.floor(25*(u.clientY-b.y)/b.height);
for(const [x,H]of ca(v,p,r,u))g.putHHalf(x,H,t[y]);m.drawImage(g.canvas,0,0);v=r;p=u}}c.preventDefault();e.setPointerCapture(E);var b=e.getBoundingClientRect(),l=Math.floor(160*(c.clientX-b.x)/b.width);c=Math.floor(25*(c.clientY-b.y)/b.height);g.putHHalf(l,c,t[y]);m.drawImage(g.canvas,0,0);var v=l,p=c;e.addEventListener("pointermove",q);e.addEventListener("pointerup",A)}}}},lines:()=>{z="lines";e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function E(q){if(q.pointerId===
y&&q.button===p){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of ca(l,v,u,q))g.setChar(r,x,N[p],t[0],t[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",A);e.removeEventListener("pointerup",E)}}function A(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of ca(l,
v,u,q))f(m,r,x,N[p],t[0],t[2])}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],t[0],t[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",E)}}}},filledBox:()=>{z="filledBox";e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function E(q){if(q.pointerId===y&&q.button===p){var u=Math.floor(80*(q.clientX-b.x)/b.width);
q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of ea(l,v,u,q))g.setChar(r,x,N[p],t[0],t[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",A);e.removeEventListener("pointerup",E)}}function A(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of ea(l,v,u,q))f(m,r,x,N[p],t[0],t[2])}}c.preventDefault();e.setPointerCapture(y);
var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],t[0],t[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",E)}}}},emptyBox:()=>{z="emptyBox";e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function E(q){if(q.pointerId===y&&q.button===p){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [r,x]of pa(l,v,u,q))g.setChar(r,
x,N[p],t[0],t[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",A);e.removeEventListener("pointerup",E)}}function A(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [r,x]of pa(l,v,u,q))f(m,r,x,N[p],t[0],t[2])}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),
v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,N[p],t[0],t[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",E)}}}},singleBorder:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function E(q){q.pointerId===y&&q.button===p&&(da(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(u,r)=>g.getChar(u,r),(u,r,x)=>g.putChar(u,r,x,t[0],t[2]),!1),m.globalCompositeOperation="copy",m.drawImage(g.canvas,
0,0),e.removeEventListener("pointermove",A),e.removeEventListener("pointerup",E))}function A(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);da(l,v,u,q,(r,x)=>g.getChar(r,x),(r,x,H)=>f(m,r,x,H,t[0],t[2]),!1)}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,S(15),
t[0],t[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",E)}}}},doubleBorder:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:y}=c;if(0===p||2===p){function E(q){q.pointerId===y&&q.button===p&&(da(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(u,r)=>g.getChar(u,r),(u,r,x)=>g.putChar(u,r,x,t[0],t[2]),!0),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",A),e.removeEventListener("pointerup",
E))}function A(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);da(l,v,u,q,(r,x)=>g.getChar(r,x),(r,x,H)=>f(m,r,x,H,t[0],t[2]),!0)}}c.preventDefault();e.setPointerCapture(y);var b=e.getBoundingClientRect(),l=Math.floor(80*(c.clientX-b.x)/b.width),v=Math.floor(25*(c.clientY-b.y)/b.height);f(m,l,v,S(15),t[0],t[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",
E)}}}},colorFloodFill:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:l}=c;if(0===l||2===l){c.preventDefault();var b=e.getBoundingClientRect();va(80*(c.clientX-b.x)/b.width,25*(c.clientY-b.y)/b.height,(v,p)=>g.getCharInfo(v,p),(v,p,y,E,A)=>g.putChar(v,p,y,E,A),n,k,t[l]);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0)}}}},pick:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:y,pointerId:E}=c;if(0===y||2===y){function A(u){u.pointerId===E&&u.button===
y&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",A),ba.value=z,ba.dispatchEvent(new Event("change")))}function q(u){if(u.pointerId===E){var r=e.getBoundingClientRect(),{charCode:x,fgColor:H,bgColor:V}=g.getCharInfo(Math.floor(80*(u.clientX-r.x)/r.width),Math.floor(25*(u.clientY-r.y)/r.height));w&T.Tile&&la(x,2===y);w&T.ForegroundColor&&U(H,!1);w&T.BackgroundColor&&U(V,!0)}}c.preventDefault();e.setPointerCapture(E);var b=e.getBoundingClientRect(),{charCode:l,fgColor:v,bgColor:p}=
g.getCharInfo(Math.floor(80*(c.clientX-b.x)/b.width),Math.floor(25*(c.clientY-b.y)/b.height));w&T.Tile&&la(l,2===y);w&T.ForegroundColor&&U(v,!1);w&T.BackgroundColor&&U(p,!0);e.addEventListener("pointermove",q);e.addEventListener("pointerup",A)}}}},text:()=>{function c(b){if("Tab"!==b.key){b.preventDefault();b.stopPropagation();switch(b.key){case "ArrowDown":G(D,Math.min(L+1,24));return;case "ArrowUp":G(D,Math.max(L-1,0));return;case "ArrowLeft":0===D?0!==L&&G(79,L-1):(D-1<F&&(F=D-1),G(D-1,L));return;
case "ArrowRight":79===D?24!==L&&G(0,L+1):G(D+1,L);return;case "Enter":G(F,Math.min(24,L+1));return;case "End":case "PageDown":G(D,24);return;case "Home":case "PageUp":G(D,0);return;case "Backspace":0===D?0!==L&&G(79,L-1):(D-1<F&&(F=D-1),G(D-1,L));g.setChar(D,L,0,t[0],t[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return;case "Delete":g.setChar(D,L,0,t[0],t[2],w);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return}b=Aa.get(b.key);"number"===typeof b&&(g.setChar(D,
L,b,t[0],t[2],w),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),79===D?24!==L&&G(0,L+1):G(D+1,L))}}aa.focus();e.onpointerdown=b=>{if("mouse"===b.pointerType){var {button:l}=b;if(0===l){b.preventDefault();l=e.getBoundingClientRect();var v=Math.floor(80*(b.clientX-l.x)/l.width);G(v,Math.floor(25*(b.clientY-l.y)/l.height));F=v;aa.focus()}}};aa.addEventListener("keydown",c);return()=>{aa.removeEventListener("keydown",c)}},gradientBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:E,
pointerId:A}=c;if(0===E||2===E){function q(r){if(r.pointerId===A&&r.button===E){var x=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);var [H,V]=v<x?[v,x]:[x,v],[R,P]=p<r?[p,r]:[r,p];for(const [K,C]of ea(v,p,x,r)){x=y(K,C,H,V,R,P);const {charCode:M,fgColor:ma,bgColor:na}=sa(b,x);g.putChar(K,C,M,ma,na)}m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",u);e.removeEventListener("pointerup",q)}}function u(r){if(r.pointerId===
A){var x=Math.floor(80*(r.clientX-l.x)/l.width);r=Math.floor(25*(r.clientY-l.y)/l.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);var [H,V]=v<x?[v,x]:[x,v],[R,P]=p<r?[p,r]:[r,p];for(const [K,C]of ea(v,p,x,r)){x=y(K,C,H,V,R,P);const {charCode:M,fgColor:ma,bgColor:na}=sa(b,x);f(m,K,C,M,ma,na)}}}var b=Y();if(0!==b.length){c.preventDefault();e.setPointerCapture(A);var l=e.getBoundingClientRect(),v=Math.floor(80*(c.clientX-l.x)/l.width),p=Math.floor(25*(c.clientY-l.y)/l.height);f(m,
v,p,219,b[0],0);c=document.getElementById("gradient-direction-selector");var y="up"===c.value?(r,x,H,V,R,P)=>(x-P)/(R-P):"right"===c.value?(r,x,H,V,R,P)=>(r-H)/(V-H):"left"===c.value?(r,x,H,V,R,P)=>(r-V)/(H-V):(r,x,H,V,R,P)=>(x-R)/(P-R);e.addEventListener("pointermove",u);e.addEventListener("pointerup",q)}}}}},spraypaint:()=>{e.onpointerdown=c=>{const {pointerId:b,pointerType:l,button:v}=c;if("mouse"===l&&0===v){const A=Y();if(0!==A.length){function q(r){r.pointerId===b&&r.button===v&&(e.removeEventListener("pointermove",
u),e.removeEventListener("pointerup",q))}function u(r){if(r.pointerId===b){var x=performance.now(),H=x-E;E=x;x=Math.floor(80*(r.clientX-y.x)/y.width);r=Math.floor(25*(r.clientY-y.y)/y.height);var {charCode:V,fgColor:R,bgColor:P}=g.getCharInfo(x,r),K=80*r+x;if(-1===p[K])if(R===P){var C=A.indexOf(P);p[K]=-1===C?0:C}else switch(V){case 0:case 32:case 255:C=A.indexOf(P);p[K]=-1===C?0:C;break;case 8:case 10:case 219:C=A.indexOf(R);p[K]=-1===C?0:C;break;case 176:C=A.indexOf(P);var M=A.indexOf(R);p[K]=-1===
C?-1===M?0:Math.max(0,M-.5):-1===M?Math.max(0,C-.5):C===M-1?C+.25:M===C-1?M+.75:Math.max(0,Math.min(M,C)+.25);break;case 177:C=A.indexOf(P);M=A.indexOf(R);p[K]=-1===C?-1===M?0:Math.max(0,M-.5):-1===M?Math.max(0,C-.5):C===M-1?C+.5:M===C-1?M+.5:Math.max(0,Math.min(M,C)+.5);break;case 178:C=A.indexOf(P);M=A.indexOf(R);p[K]=-1===C?-1===M?0:Math.max(0,M-.5):-1===M?Math.max(0,C-.5):C===M-1?C+.75:M===C-1?M+.25:Math.max(0,Math.min(M,C)+.5);break;default:C=A.indexOf(P),-1===C&&(C=A.indexOf(R)),p[K]=C+.5}p[K]+=
Math.min(.25,H/100);p[K]>=A.length-1?(K=219,C=A[A.length-1],H=0):(H=Math.floor(p[K]),K=p[K]-H,.125>K?(K=219,C=A[H],H=0):(K=.375>K?176:.625>K?177:.875>K?178:219,C=A[H+1],H=A[H]));if(K!==V||C!==R||H!==P)g.putChar(x,r,K,C,H),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0)}}var p=new Float32Array(2E3);p.fill(-1);var y=e.getBoundingClientRect(),E=performance.now();e.addEventListener("pointermove",u);e.addEventListener("pointerup",q)}}}}},fa=document.getElementById("add-gradient-slot"),I=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),
J=document.querySelector(".gradient-slots"),O=c=>{const b=I.cloneNode(!0);b.dataset.value=String(c);b.querySelector(".remove-gradient-slot").onclick=()=>{J.removeChild(b)};J.insertBefore(b,fa)};fa.onclick=()=>{O(t[0])};O(0);O(8);O(7);O(15);let Y=()=>{const c=document.querySelectorAll(".gradient-slots .gradient-slot"),b=[];for(let l=0;l<c.length;l++)b.push(Number(c[l].dataset.value));return b},sa=(c,b)=>{if(2>c.length)return{charCode:219,fgColor:c[0]||0,bgColor:0};b=Math.max(0,Math.min(1,Number(b)||
0));b*=c.length-1;const l=Math.floor(b);if(l>=c.length-1)return{charCode:219,fgColor:c[c.length-1],bgColor:0};b-=l;return.125>b?{charCode:0,fgColor:c[l+1],bgColor:c[l]}:.375>b?{charCode:176,fgColor:c[l+1],bgColor:c[l]}:.625>b?{charCode:177,fgColor:c[l+1],bgColor:c[l]}:.875>b?{charCode:178,fgColor:c[l+1],bgColor:c[l]}:{charCode:219,fgColor:c[l+1],bgColor:0}},ia;ia=B.freehand();let ba=document.getElementById("tool-selector"),ja=ba.value;document.body.classList.add("tool-"+ja);ba.onchange=c=>{ia&&ia();
ia=B[ba.value]();document.body.classList.remove("tool-"+ja);ja=ba.value;document.body.classList.add("tool-"+ja)};e.oncontextmenu=c=>{c.preventDefault()};let ka=document.getElementById("char-picker"),Ba=document.querySelector(".left-pick"),Ca=document.querySelector(".right-pick"),la=(c,b)=>{const l=Math.floor(c/64),v=b?Ca:Ba;v.style.left=`${c%64*8}px`;v.style.top=`${16*l}px`;N[b?2:0]=c};a=ka.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let c=0;256>c;c++)f(a,c%64,Math.floor(c/
64),c,7,0);ka.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var b=ka.getBoundingClientRect();la(64*Math.floor(4*(c.clientY-b.y)/b.height)+Math.floor(64*(c.clientX-b.x)/b.width),2===c.button)}};ka.oncontextmenu=c=>{c.preventDefault()};document.getElementById("save-image").onclick=c=>{c=g.saveBlob();c=URL.createObjectURL(c);let b=document.createElement("a");b.download="dosimage.dat";b.href=c;b.click()};document.getElementById("load-image").onclick=async c=>{if(c=await ua()){try{await g.loadBlob(c)}catch(b){alert(b);
return}m.drawImage(g.canvas,0,0)}};document.getElementById("clear-image").onclick=c=>{g.fill(N[2],t[0],t[2],w);m.drawImage(g.canvas,0,0)}},{once:!0})})()
