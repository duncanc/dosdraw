'use strict';(function(){function*D(a,b,f,h){let g=Math.abs(f-a),e=Math.abs(h-b),k=a<f?1:-1,r=b<h?1:-1,m=g-e;for(;;){yield[a,b];if(a===f&&b===h)break;let B=2*m;B>-e&&(m-=e,a+=k);B<g&&(m+=g,b+=r)}}function*E(a,b,f,h){let g=Math.sign(f-a),e=Math.sign(h-b);if(0===g)if(0===e)yield[a,b];else for(f=b;f!==h+e;f+=e)yield[a,f];else if(0===e)for(;a!==f+g;a+=g)yield[a,b];else for(;b!==h+e;b+=e)for(let k=a;k!==f+g;k+=g)yield[k,b]}function*F(a,b,f,h){let g=Math.sign(f-a),e=Math.sign(h-b);if(0===g)if(0===e)yield[a,
b];else for(f=b;f!==h+e;f+=e)yield[a,f];else if(0===e)for(h=a;h!==f+g;h+=g)yield[h,b];else{for(let k=a;k!==f+g;k+=g)yield[k,b];for(b+=e;b!==h;b+=e)yield[a,b],yield[f,b];for(;a!==f+g;a+=g)yield[a,h]}}function K(){return new Promise((a,b)=>{let f=document.createElement("input");f.type="file";f.onchange=h=>{var g;(null===(g=f.files)||void 0===g?0:g.length)?a(f.files[0]):a(null)};f.click()})}let G=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var z;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=
3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(z||(z={}));var H;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]=
"White"})(H||(H={}));let I="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class L{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,b,f,h){if(!Number.isInteger(a)||!Number.isInteger(b))throw new TypeError("x and y must be integers");
if(!Number.isInteger(f)||!Number.isInteger(b))throw new TypeError("width and height must be integers");if(0>a||0>b||0>f||0>h||80<a+f||25<b+h)throw new RangeError("edges exceed screen");let g=new Uint16Array(f*h);for(let e=0;e<h;e++)g.set(this.buffer.subarray(80*(b+e)+a,80*(b+e)+a+f),e*f);return{data:g,width:f,height:h}}putBrush(a,b,f){let h,g,e=a.data;if(0>b){h=-b;if(h>=a.width)return;b=0}else h=0;g=Math.min(80-b,b+a.width);if(0>f){e=e.subarray(f*a.width);if(0===e.length)return;f=0}for(let k=0;k<
a.height;k++)if(!(0>f+k)){if(25<=f+k)break;this.buffer.set(e.subarray((f+k)*a.width+h,(f+k)*a.width+g),80*f+b);for(let r=h;r<g;r++)this.updateCanvas(f+k,b+r)}}updateCanvas(a,b){let f=this.buffer[80*b+a];this.drawChar(this.ctx,a,b,f&255,f>>8&15,f>>12&15)}getCharInfo(a,b){a=this.buffer[80*b+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}putChar(a,b,f,h,g){this.buffer[80*b+a]=f|h<<8|g<<12;this.updateCanvas(a,b)}setChar(a,b,f,h,g,e=z.All){this.buffer[80*b+a]=this.buffer[80*b+a]&~e|(f|h<<8|
g<<12)&e;this.updateCanvas(a,b)}fill(a,b,f,h=z.All){a=(a|b<<8|f<<12)&h;for(b=0;b<this.buffer.length;b++)this.buffer[b]=this.buffer[b]&~h|a,this.updateCanvas(b%80,Math.floor(b/80))}saveBlob(){if(G)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let b=0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!G)for(var b=
0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(b=0;80>b;b++)this.updateCanvas(b,a)}}let M=fetch("./chardata.png");window.addEventListener("DOMContentLoaded",async function(){var a=await (await M).blob();let b=await createImageBitmap(a),f=b.width/9,h=(c,d,n,q,p,u)=>{c.save();c.globalCompositeOperation="source-over";c.fillStyle=I[u];c.fillRect(8*d,16*n,8,16);c.globalCompositeOperation="destination-out";c.drawImage(b,q%f*9,16*Math.floor(q/f),8,16,8*d,16*n,8,16);c.globalCompositeOperation=
"destination-over";c.fillStyle=I[p];c.fillRect(8*d,16*n,8,16);c.restore()},g=new L(h),e=document.getElementById("editor"),k=e.getContext("2d");if(!k)throw Error("unable to create canvas context");let r=z.All;document.getElementById("tile").onchange=c=>{r=c.target.checked?r|z.Tile:r&~z.Tile};document.getElementById("fgcolor").onchange=c=>{r=c.target.checked?r|z.ForegroundColor:r&~z.ForegroundColor};document.getElementById("bgcolor").onchange=c=>{r=c.target.checked?r|z.BackgroundColor:r&~z.BackgroundColor};
let m=[7,0,0],B=document.querySelector(".palette");B.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var d=0===c.button?"foreground-selected":"background-selected";for(let n=c.target;n&&!n.classList.contains("palette");n=n.parentElement)if("value"in n.dataset){let q=B.querySelectorAll(`.${d}`);for(let p=0;p<q.length;p++)q[p].classList.remove(d);n.classList.add(d);m[c.button]=+n.dataset.value;c.preventDefault();c.stopPropagation();break}}};B.oncontextmenu=c=>{c.preventDefault()};
let w=[219,0,0],J={freehand:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:u,pointerId:y}=c;if(0===u||2===u){function A(t){t.pointerId===y&&t.button===u&&(e.removeEventListener("pointermove",l),e.removeEventListener("pointerup",A))}function l(t){if(t.pointerId===y){var v=Math.floor(80*(t.clientX-d.x)/d.width);t=Math.floor(25*(t.clientY-d.y)/d.height);for(const [x,N]of D(q,p,v,t))g.setChar(x,N,w[u],m[0],m[2],r);k.drawImage(g.canvas,0,0);q=v;p=t}}e.setPointerCapture(y);var d=e.getBoundingClientRect(),
n=Math.floor(80*(c.clientX-d.x)/d.width);c=Math.floor(25*(c.clientY-d.y)/d.height);g.setChar(n,c,w[u],m[0],m[2],r);k.drawImage(g.canvas,0,0);var q=n,p=c;e.addEventListener("pointermove",l);e.addEventListener("pointerup",A)}}}},lines:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:u}=c;if(0===p||2===p){function y(l){if(l.pointerId===u&&l.button===p){var t=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,x]of D(n,q,t,l))g.setChar(v,
x,w[p],m[0],m[2],r);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",A);e.removeEventListener("pointerup",y)}}function A(l){if(l.pointerId===u){var t=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);for(const [v,x]of D(n,q,t,l))h(k,v,x,w[p],m[0],m[2])}}e.setPointerCapture(u);var d=e.getBoundingClientRect(),n=Math.floor(80*(c.clientX-d.x)/d.width),q=Math.floor(25*
(c.clientY-d.y)/d.height);h(k,n,q,w[p],m[0],m[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",y)}}}},filledBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:u}=c;if(0===p||2===p){function y(l){if(l.pointerId===u&&l.button===p){var t=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,x]of E(n,q,t,l))g.setChar(v,x,w[p],m[0],m[2],r);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",
A);e.removeEventListener("pointerup",y)}}function A(l){if(l.pointerId===u){var t=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);for(const [v,x]of E(n,q,t,l))h(k,v,x,w[p],m[0],m[2])}}e.setPointerCapture(u);var d=e.getBoundingClientRect(),n=Math.floor(80*(c.clientX-d.x)/d.width),q=Math.floor(25*(c.clientY-d.y)/d.height);h(k,n,q,w[p],m[0],m[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",
y)}}}},emptyBox:()=>{e.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:p,pointerId:u}=c;if(0===p||2===p){function y(l){if(l.pointerId===u&&l.button===p){var t=Math.floor(80*(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);for(const [v,x]of F(n,q,t,l))g.setChar(v,x,w[p],m[0],m[2],r);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",A);e.removeEventListener("pointerup",y)}}function A(l){if(l.pointerId===u){var t=Math.floor(80*
(l.clientX-d.x)/d.width);l=Math.floor(25*(l.clientY-d.y)/d.height);k.globalCompositeOperation="copy";k.drawImage(g.canvas,0,0);for(const [v,x]of F(n,q,t,l))h(k,v,x,w[p],m[0],m[2])}}e.setPointerCapture(u);var d=e.getBoundingClientRect(),n=Math.floor(80*(c.clientX-d.x)/d.width),q=Math.floor(25*(c.clientY-d.y)/d.height);h(k,n,q,w[p],m[0],m[2]);e.addEventListener("pointermove",A);e.addEventListener("pointerup",y)}}}}};J.freehand();document.getElementById("tool-selector").onchange=c=>{J[c.target.value]()};
e.oncontextmenu=c=>{c.preventDefault()};let C=document.getElementById("char-picker");a=C.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let c=0;256>c;c++)h(a,c%64,Math.floor(c/64),c,7,0);let O=document.querySelector(".left-pick"),P=document.querySelector(".right-pick");C.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var d=C.getBoundingClientRect(),n=Math.floor(64*(c.clientX-d.x)/d.width);d=Math.floor(4*(c.clientY-d.y)/d.height);var q=2===c.button?
P:O;w[c.button]=64*d+n;q.style.left=`${8*n}px`;q.style.top=`${16*d}px`}};C.oncontextmenu=c=>{c.preventDefault()};document.getElementById("save-image").onclick=c=>{c=g.saveBlob();c=URL.createObjectURL(c);let d=document.createElement("a");d.download="dosimage.dat";d.href=c;d.click()};document.getElementById("load-image").onclick=async c=>{if(c=await K()){try{await g.loadBlob(c)}catch(d){alert(d);return}k.drawImage(g.canvas,0,0)}};document.getElementById("clear-image").onclick=c=>{g.fill(w[2],m[0],m[2],
r);k.drawImage(g.canvas,0,0)}},{once:!0})})()
