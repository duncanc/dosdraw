'use strict';(function(){function R(a){a-=179;return!Number.isInteger(a)||0>a||a>=ka.length?0:ka[a]}function M(a){return oa[a]||0}function Y(a,c,h,f,n,k,g){let [e,m]=a<h?[a,h]:[h,a],[u,r]=c<f?[c,f]:[f,c];a=g?32:0;g=g?16:0;if(u===r)if(e===m)k(e,u,M(15));else{k(e,u,M(R(n(e,u))&-33|8|a));for(g=e+1;g<m;g++)k(g,u,M(R(n(g,u))&-33|12|a));k(m,u,M(R(n(m,u))&-33|4|a))}else if(e===m){k(e,u,M(R(n(e,u))&-17|2|g));for(a=u+1;a<r;a++)k(e,a,M(R(n(e,a))&-17|3|g));k(e,r,M(R(n(e,r))&-17|1|g))}else{k(e,u,M(R(n(e,u))&
-49|10|a|g));for(c=e+1;c<m;c++)k(c,u,M(R(n(c,u))&-33|12|a));k(m,u,M(R(n(m,u))&-49|6|a|g));for(c=u+1;c<r;c++)k(e,c,M(R(n(e,c))&-17|3|g)),k(m,c,M(R(n(m,c))&-17|3|g));k(e,r,M(R(n(e,r))&-49|9|a|g));for(c=e+1;c<m;c++)k(c,r,M(R(n(c,r))&-33|12|a));k(m,r,M(R(n(m,r))&-49|5|g|a))}}function*V(a,c,h,f){let n=Math.abs(h-a),k=Math.abs(f-c),g=a<h?1:-1,e=c<f?1:-1,m=n-k;for(;;){yield[a,c];if(a===h&&c===f)break;let u=2*m;u>-k&&(m-=k,a+=g);u<n&&(m+=n,c+=e)}}function*Z(a,c,h,f){let n=Math.sign(h-a),k=Math.sign(f-c);
if(0===n)if(0===k)yield[a,c];else for(h=c;h!==f+k;h+=k)yield[a,h];else if(0===k)for(;a!==h+n;a+=n)yield[a,c];else for(;c!==f+k;c+=k)for(let g=a;g!==h+n;g+=n)yield[g,c]}function*la(a,c,h,f){let n=Math.sign(h-a),k=Math.sign(f-c);if(0===n)if(0===k)yield[a,c];else for(h=c;h!==f+k;h+=k)yield[a,h];else if(0===k)for(f=a;f!==h+n;f+=n)yield[f,c];else{for(let g=a;g!==h+n;g+=n)yield[g,c];for(c+=k;c!==f;c+=k)yield[a,c],yield[h,c];for(;a!==h+n;a+=n)yield[a,f]}}function pa(){return new Promise((a,c)=>{let h=document.createElement("input");
h.type="file";h.onchange=f=>{var n;(null===(n=h.files)||void 0===n?0:n.length)?a(h.files[0]):a(null)};h.click()})}function L(a,c){let h=0;for(;a&c;){var f=Math.clz32(c);f=32-Math.clz32(~c<<f>>>f);f=c>>>f<<f;f&a&&(h|=f,a&=~f);c&=~f}return h}function qa(a,c,h,f,n,k,g){if(!(0>a||0>c||80<=a||25<=c)){var e=Math.floor(a%1*8),m=Math.floor(c%1*8);a=Math.floor(a);c=Math.floor(c);var {charCode:u,bgColor:r,fgColor:T}=h(a,c);if(r===T||32===u||255===u)u=0;var O=!!(n[u][m]&128>>>e),J=O?T:r,C=[],G=O?0:255,D=O?0:
65535,K=L(128>>>e,n[u][m]^G),I=L(32768>>>m,k[u][e]^D);a:if(0!==c){var U=K;for(let x=m-1;0<=x;x--)if(U=L(U,n[u][x]^G),0===U)break a;C.push({x:a,y:c-1,side:"bottom",mask:U})}a:if(24!==c){for(m+=1;8>m;m++)if(K=L(K,n[u][m]^G),0===K)break a;C.push({x:a,y:c+1,side:"top",mask:K})}a:if(0!==a){G=I;for(m=e-1;0<=m;m--)if(G=L(G,k[u][m]^D),0===G)break a;C.push({x:a-1,y:c,side:"right",mask:G})}a:if(79!==a){for(e+=1;8>e;e++)if(I=L(I,k[u][e]^D),0===I)break a;C.push({x:a+1,y:c,side:"left",mask:I})}O?f(a,c,u,g,r):
f(a,c,u,T,g);for(a=new Set([`${a},${c}`]);0<C.length;){let {x,y,side:aa,mask:E}=C.pop(),{charCode:H,bgColor:P,fgColor:S}=h(x,y);if(P!==J&&S!==J||177===H||176===H&&P!==J||178===H&&S!==J)a.add(`${x},${y}`);else{if(S===P||32===H||255===H)H=0;c=P===J?255:0;O=P===J?65535:0;switch(aa){case "top":for(D=I=e=0;16>D;D++){E=L(E,n[H][D]^c);if(0===E)break;E&128&&(e|=L(1<<D,k[H][0]^O));E&1&&(I|=L(1<<D,k[H][7]^O))}0<D&&(E&&24!==y&&!a.has(`${x},${y+1}`)&&C.push({x,y:y+1,side:"top",mask:E}),e&&0!==x&&!a.has(`${x-
1},${y}`)&&C.push({x:x-1,y,side:"right",mask:e}),I&&79!==x&&!a.has(`${x+1},${y}`)&&C.push({x:x+1,y,side:"left",mask:I}),P===J?f(x,y,H,S,g):f(x,y,H,g,P),a.add(`${x},${y}`));break;case "bottom":I=e=0;for(D=15;0<=D;D--){E=L(E,n[H][D]^c);if(0===E)break;E&128&&(e|=L(1<<D,k[H][0]^O));E&1&&(I|=L(1<<D,k[H][7]^O))}15>D&&(E&&0!==y&&!a.has(`${x},${y-1}`)&&C.push({x,y:y-1,side:"bottom",mask:E}),e&&0!==x&&!a.has(`${x-1},${y}`)&&C.push({x:x-1,y,side:"right",mask:e}),I&&79!==x&&!a.has(`${x+1},${y}`)&&C.push({x:x+
1,y,side:"left",mask:I}),P===J?f(x,y,H,S,g):f(x,y,H,g,P),a.add(`${x},${y}`));break;case "left":for(D=I=e=0;8>D;D++){E=L(E,k[H][D]^O);if(0===E)break;E&32768&&(I|=L(128>>D,n[H][15]^c));E&1&&(e|=L(128>>D,n[H][0]^c))}0<D&&(E&&79!==x&&!a.has(`${x+1},${y}`)&&C.push({x:x+1,y,side:"left",mask:E}),e&&0!==y&&!a.has(`${x},${y-1}`)&&C.push({x,y:y-1,side:"bottom",mask:e}),I&&24!==y&&!a.has(`${x},${y+1}`)&&C.push({x,y:y+1,side:"top",mask:I}),P===J?f(x,y,H,S,g):f(x,y,H,g,P),a.add(`${x},${y}`));break;case "right":I=
e=0;for(D=7;0<=D;D--){E=L(E,k[H][D]^O);if(0===E)break;E&32768&&(I|=L(128>>D,n[H][15]^c));E&1&&(e|=L(128>>D,n[H][0]^c))}7>D&&(E&&0!==x&&!a.has(`${x-1},${y}`)&&C.push({x:x-1,y,side:"right",mask:E}),e&&0!==y&&!a.has(`${x},${y-1}`)&&C.push({x,y:y-1,side:"bottom",mask:e}),I&&24!==y&&!a.has(`${x},${y+1}`)&&C.push({x,y:y+1,side:"top",mask:I}),P===J?f(x,y,H,S,g):f(x,y,H,g,P),a.add(`${x},${y}`))}}}}}let ma=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var N;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=
3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(N||(N={}));var ba;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=
15]="White"})(ba||(ba={}));let na="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class ra{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,c,h,f){if(!Number.isInteger(a)||!Number.isInteger(c))throw new TypeError("x and y must be integers");
if(!Number.isInteger(h)||!Number.isInteger(c))throw new TypeError("width and height must be integers");if(0>a||0>c||0>h||0>f||80<a+h||25<c+f)throw new RangeError("edges exceed screen");let n=new Uint16Array(h*f);for(let k=0;k<f;k++)n.set(this.buffer.subarray(80*(c+k)+a,80*(c+k)+a+h),k*h);return{data:n,width:h,height:f}}putBrush(a,c,h){let f,n,k=a.data;if(0>c){f=-c;if(f>=a.width)return;c=0}else f=0;n=Math.min(80-c,c+a.width);if(0>h){k=k.subarray(h*a.width);if(0===k.length)return;h=0}for(let g=0;g<
a.height;g++)if(!(0>h+g)){if(25<=h+g)break;this.buffer.set(k.subarray((h+g)*a.width+f,(h+g)*a.width+n),80*h+c);for(let e=f;e<n;e++)this.updateCanvas(h+g,c+e)}}updateCanvas(a,c){let h=this.buffer[80*c+a];this.drawChar(this.ctx,a,c,h&255,h>>8&15,h>>12&15)}getCharInfo(a,c){a=this.buffer[80*c+a];return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,c){return this.buffer[80*c+a]&255}putChar(a,c,h,f,n){this.buffer[80*c+a]=h|f<<8|n<<12;this.updateCanvas(a,c)}setChar(a,c,h,f,n,k=N.All){this.buffer[80*
c+a]=this.buffer[80*c+a]&~k|(h|f<<8|n<<12)&k;this.updateCanvas(a,c)}fill(a,c,h,f=N.All){a=(a|c<<8|h<<12)&f;for(c=0;c<this.buffer.length;c++)this.buffer[c]=this.buffer[c]&~f|a,this.updateCanvas(c%80,Math.floor(c/80))}putVHalf(a,c,h){var f=this.buffer[80*(c>>1)+a];let n=f>>>8&15,k=f>>>12&15,g=c&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 220:f=1===g?k:n;break;case 223:f=1===g?n:k}f===h?this.putChar(a,c>>1,219,h,k):0===g?this.putChar(a,c>>1,223,h,f):this.putChar(a,c>>1,220,
h,f)}putHHalf(a,c,h){var f=this.buffer[80*c+(a>>1)];let n=f>>>8&15,k=f>>>12&15,g=a&1;switch(f&255){case 219:case 8:case 10:f=n;break;default:f=k;break;case 222:f=1===g?k:n;break;case 221:f=1===g?n:k}f===h?this.putChar(a>>1,c,219,h,k):0===g?this.putChar(a>>1,c,221,h,f):this.putChar(a>>1,c,222,h,f)}saveBlob(){if(ma)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!ma)for(var c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(c=0;80>c;c++)this.updateCanvas(c,a)}}let oa=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,
202,203,206]),ka=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),sa=fetch("./chardata.png"),ta=a=>{var c=document.createElement("canvas");c.width=a.width;c.height=a.height;c=c.getContext("2d");if(!c)throw Error("unable to create 2D canvas");c.drawImage(a,0,0);var h=a.width/9;a=new Uint8Array(4096);for(let f=0;256>f;f++){const {data:n}=c.getImageData(f%h*9,16*Math.floor(f/h),8,16);for(let k=0;16>k;k++)a[16*f+k]=n[32*
k+3]?128:0,a[16*f+k]|=n[4*(8*k+1)+3]?64:0,a[16*f+k]|=n[4*(8*k+2)+3]?32:0,a[16*f+k]|=n[4*(8*k+3)+3]?16:0,a[16*f+k]|=n[4*(8*k+4)+3]?8:0,a[16*f+k]|=n[4*(8*k+5)+3]?4:0,a[16*f+k]|=n[4*(8*k+5)+3]?2:0,a[16*f+k]|=n[4*(8*k+7)+3]?1:0}c=Array(256);for(h=0;256>h;h++)c[h]=a.subarray(16*h,16*(h+1));return c},ua=a=>{const c=new Uint16Array(2048);for(var h=0;256>h;h++)for(let f=0;8>f;f++)for(let n=0;16>n;n++)c[8*h+f]|=(a[h][n]>>>7-f&1)<<n;a=Array(256);for(h=0;256>h;h++)a[h]=c.subarray(8*h,8*(h+1));return a};ba=[0,
9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,c)=>32+c),8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,
9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160];let va=new Map(ba.map((a,c)=>[String.fromCodePoint(a),c]));window.addEventListener("DOMContentLoaded",async function(){var a=await (await sa).blob();let c=await createImageBitmap(a),h=c.width/9,f=(d,b,l,v,t,w)=>{d.save();d.globalCompositeOperation=
"source-over";d.fillStyle=na[w];d.fillRect(8*b,16*l,8,16);d.globalCompositeOperation="destination-out";d.drawImage(c,v%h*9,16*Math.floor(v/h),8,16,8*b,16*l,8,16);d.globalCompositeOperation="destination-over";d.fillStyle=na[t];d.fillRect(8*b,16*l,8,16);d.restore()},n=ta(c),k=ua(n),g=new ra(f),e=document.getElementById("editor"),m=e.getContext("2d");if(!m)throw Error("unable to create canvas context");let u=N.All;document.getElementById("tile").onchange=d=>{u=d.target.checked?u|N.Tile:u&~N.Tile};document.getElementById("fgcolor").onchange=
d=>{u=d.target.checked?u|N.ForegroundColor:u&~N.ForegroundColor};document.getElementById("bgcolor").onchange=d=>{u=d.target.checked?u|N.BackgroundColor:u&~N.BackgroundColor};let r=[7,0,0],T=document.querySelector(".palette"),O=(d,b)=>{const l=b?"background-selected":"foreground-selected";var v=T.querySelectorAll(`.${l}`);for(let t=0;t<v.length;t++)v[t].classList.remove(l);(v=T.querySelector(`.color-cell[data-value='${d}']`))&&v.classList.add(l);r[b?2:0]=d};T.onpointerdown=d=>{if("mouse"===d.pointerType&&
(0===d.button||2===d.button)){var b=0===d.button?"foreground-selected":"background-selected";for(let l=d.target;l&&!l.classList.contains("palette");l=l.parentElement)if("value"in l.dataset){let v=T.querySelectorAll(`.${b}`);for(let t=0;t<v.length;t++)v[t].classList.remove(b);l.classList.add(b);r[d.button]=+l.dataset.value;d.preventDefault();d.stopPropagation();break}}};T.oncontextmenu=d=>{d.preventDefault()};let J=[219,0,0],C=0,G=0,D=document.querySelector(".cursor"),K=(d,b)=>{D.style.left=`${8*d}px`;
D.style.top=`${16*b}px`;C=d;G=b},I=document.querySelector("#editor-block"),U={freehand:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:w,pointerId:B}=d;if(0===w||2===w){function F(p){p.pointerId===B&&p.button===w&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",F))}function q(p){if(p.pointerId===B){var z=Math.floor(80*(p.clientX-b.x)/b.width);p=Math.floor(25*(p.clientY-b.y)/b.height);for(const [A,Q]of V(v,t,z,p))g.setChar(A,Q,J[w],r[0],r[2],u);m.drawImage(g.canvas,
0,0);v=z;t=p}}d.preventDefault();e.setPointerCapture(B);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width);d=Math.floor(25*(d.clientY-b.y)/b.height);g.setChar(l,d,J[w],r[0],r[2],u);m.drawImage(g.canvas,0,0);var v=l,t=d;e.addEventListener("pointermove",q);e.addEventListener("pointerup",F)}}}},vbFreehand:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:w,pointerId:B}=d;if(0===w||2===w){function F(p){p.pointerId===B&&p.button===w&&(e.removeEventListener("pointermove",
q),e.removeEventListener("pointerup",F))}function q(p){if(p.pointerId===B){var z=Math.floor(80*(p.clientX-b.x)/b.width);p=Math.floor(50*(p.clientY-b.y)/b.height);for(const [A,Q]of V(v,t,z,p))g.putVHalf(A,Q,r[w]);m.drawImage(g.canvas,0,0);v=z;t=p}}d.preventDefault();e.setPointerCapture(B);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width);d=Math.floor(50*(d.clientY-b.y)/b.height);g.putVHalf(l,d,r[w]);m.drawImage(g.canvas,0,0);var v=l,t=d;e.addEventListener("pointermove",q);e.addEventListener("pointerup",
F)}}}},hbFreehand:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:w,pointerId:B}=d;if(0===w||2===w){function F(p){p.pointerId===B&&p.button===w&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",F))}function q(p){if(p.pointerId===B){var z=Math.floor(160*(p.clientX-b.x)/b.width);p=Math.floor(25*(p.clientY-b.y)/b.height);for(const [A,Q]of V(v,t,z,p))g.putHHalf(A,Q,r[w]);m.drawImage(g.canvas,0,0);v=z;t=p}}d.preventDefault();e.setPointerCapture(B);var b=e.getBoundingClientRect(),
l=Math.floor(160*(d.clientX-b.x)/b.width);d=Math.floor(25*(d.clientY-b.y)/b.height);g.putHHalf(l,d,r[w]);m.drawImage(g.canvas,0,0);var v=l,t=d;e.addEventListener("pointermove",q);e.addEventListener("pointerup",F)}}}},lines:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:t,pointerId:w}=d;if(0===t||2===t){function B(q){if(q.pointerId===w&&q.button===t){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [z,A]of V(l,v,p,q))g.setChar(z,A,
J[t],r[0],r[2],u);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(q){if(q.pointerId===w){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [z,A]of V(l,v,p,q))f(m,z,A,J[t],r[0],r[2])}}d.preventDefault();e.setPointerCapture(w);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width),
v=Math.floor(25*(d.clientY-b.y)/b.height);f(m,l,v,J[t],r[0],r[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},filledBox:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:t,pointerId:w}=d;if(0===t||2===t){function B(q){if(q.pointerId===w&&q.button===t){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [z,A]of Z(l,v,p,q))g.setChar(z,A,J[t],r[0],r[2],u);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(q){if(q.pointerId===w){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [z,A]of Z(l,v,p,q))f(m,z,A,J[t],r[0],r[2])}}d.preventDefault();e.setPointerCapture(w);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width),v=Math.floor(25*(d.clientY-b.y)/b.height);f(m,l,v,J[t],r[0],r[2]);e.addEventListener("pointermove",
F);e.addEventListener("pointerup",B)}}}},emptyBox:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:t,pointerId:w}=d;if(0===t||2===t){function B(q){if(q.pointerId===w&&q.button===t){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);for(const [z,A]of la(l,v,p,q))g.setChar(z,A,J[t],r[0],r[2],u);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",F);e.removeEventListener("pointerup",B)}}function F(q){if(q.pointerId===
w){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);for(const [z,A]of la(l,v,p,q))f(m,z,A,J[t],r[0],r[2])}}d.preventDefault();e.setPointerCapture(w);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width),v=Math.floor(25*(d.clientY-b.y)/b.height);f(m,l,v,J[t],r[0],r[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},singleBorder:()=>{e.onpointerdown=d=>{if("mouse"===
d.pointerType){const {button:t,pointerId:w}=d;if(0===t||2===t){function B(q){q.pointerId===w&&q.button===t&&(Y(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(p,z)=>g.getChar(p,z),(p,z,A)=>g.putChar(p,z,A,r[0],r[2]),!1),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",F),e.removeEventListener("pointerup",B))}function F(q){if(q.pointerId===w){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/
b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);Y(l,v,p,q,(z,A)=>g.getChar(z,A),(z,A,Q)=>f(m,z,A,Q,r[0],r[2]),!1)}}d.preventDefault();e.setPointerCapture(w);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width),v=Math.floor(25*(d.clientY-b.y)/b.height);f(m,l,v,M(15),r[0],r[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},doubleBorder:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:t,pointerId:w}=d;if(0===t||2===
t){function B(q){q.pointerId===w&&q.button===t&&(Y(l,v,Math.floor(80*(q.clientX-b.x)/b.width),Math.floor(25*(q.clientY-b.y)/b.height),(p,z)=>g.getChar(p,z),(p,z,A)=>g.putChar(p,z,A,r[0],r[2]),!0),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),e.removeEventListener("pointermove",F),e.removeEventListener("pointerup",B))}function F(q){if(q.pointerId===w){var p=Math.floor(80*(q.clientX-b.x)/b.width);q=Math.floor(25*(q.clientY-b.y)/b.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,
0,0);Y(l,v,p,q,(z,A)=>g.getChar(z,A),(z,A,Q)=>f(m,z,A,Q,r[0],r[2]),!0)}}d.preventDefault();e.setPointerCapture(w);var b=e.getBoundingClientRect(),l=Math.floor(80*(d.clientX-b.x)/b.width),v=Math.floor(25*(d.clientY-b.y)/b.height);f(m,l,v,M(15),r[0],r[2]);e.addEventListener("pointermove",F);e.addEventListener("pointerup",B)}}}},colorFloodFill:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:l}=d;if(0===l||2===l){d.preventDefault();var b=e.getBoundingClientRect();qa(80*(d.clientX-b.x)/
b.width,25*(d.clientY-b.y)/b.height,(v,t)=>g.getCharInfo(v,t),(v,t,w,B,F)=>g.putChar(v,t,w,B,F),n,k,r[l]);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0)}}}},pick:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:w,pointerId:B}=d;if(0===w||2===w){function F(p){p.pointerId===B&&p.button===w&&(e.removeEventListener("pointermove",q),e.removeEventListener("pointerup",F))}function q(p){if(p.pointerId===B&&p.button===w){var z=e.getBoundingClientRect(),{charCode:A,fgColor:Q,
bgColor:W}=g.getCharInfo(Math.floor(80*(p.clientX-z.x)/z.width),Math.floor(25*(p.clientY-z.y)/z.height));u&N.Tile&&fa(A,2===w);u&N.ForegroundColor&&O(Q,!1);u&N.BackgroundColor&&O(W,!0)}}d.preventDefault();e.setPointerCapture(B);var b=e.getBoundingClientRect(),{charCode:l,fgColor:v,bgColor:t}=g.getCharInfo(Math.floor(80*(d.clientX-b.x)/b.width),Math.floor(25*(d.clientY-b.y)/b.height));u&N.Tile&&fa(l,2===w);u&N.ForegroundColor&&O(v,!1);u&N.BackgroundColor&&O(t,!0);e.addEventListener("pointermove",q);
e.addEventListener("pointerup",F)}}}},text:()=>{function d(b){if("Tab"!==b.key){b.preventDefault();b.stopPropagation();switch(b.key){case "ArrowDown":K(C,Math.min(G+1,24));return;case "ArrowUp":K(C,Math.max(G-1,0));return;case "ArrowLeft":0===C?0!==G&&K(79,G-1):K(C-1,G);return;case "ArrowRight":79===C?24!==G&&K(0,G+1):K(C+1,G);return;case "Enter":K(0,Math.min(24,G+1));return;case "End":case "PageDown":K(C,24);return;case "Home":case "PageUp":K(C,0);return;case "Backspace":0===C?0!==G&&K(79,G-1):K(C-
1,G);g.setChar(C,G,0,r[0],r[2],u);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return;case "Delete":g.setChar(C,G,0,r[0],r[2],u);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);return}b=va.get(b.key);"number"===typeof b&&(g.setChar(C,G,b,r[0],r[2],u),m.globalCompositeOperation="copy",m.drawImage(g.canvas,0,0),79===C?24!==G&&K(0,G+1):K(C+1,G))}}I.focus();e.onpointerdown=b=>{if("mouse"===b.pointerType){var {button:l}=b;0===l&&(b.preventDefault(),l=e.getBoundingClientRect(),
K(Math.floor(80*(b.clientX-l.x)/l.width),Math.floor(25*(b.clientY-l.y)/l.height)),I.focus())}};I.addEventListener("keydown",d);return()=>{I.removeEventListener("keydown",d)}},gradientBox:()=>{e.onpointerdown=d=>{if("mouse"===d.pointerType){const {button:w,pointerId:B}=d;if(0===w||2===w){function F(p){if(p.pointerId===B&&p.button===w){var z=Math.floor(80*(p.clientX-l.x)/l.width);p=Math.floor(25*(p.clientY-l.y)/l.height);var [A,Q]=t<p?[t,p+1]:[p,t+1];for(const [W,X]of Z(v,t,z,p)){const {charCode:ha,
fgColor:ia,bgColor:ja}=P(b,(X-A)/(Q-A));g.setChar(W,X,ha,ia,ja,u)}m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);e.removeEventListener("pointermove",q);e.removeEventListener("pointerup",F)}}function q(p){if(p.pointerId===B){var z=Math.floor(80*(p.clientX-l.x)/l.width);p=Math.floor(25*(p.clientY-l.y)/l.height);m.globalCompositeOperation="copy";m.drawImage(g.canvas,0,0);var [A,Q]=t<p?[t,p+1]:[p,t+1];for(const [W,X]of Z(v,t,z,p)){const {charCode:ha,fgColor:ia,bgColor:ja}=P(b,(X-A)/(Q-A));
f(m,W,X,ha,ia,ja)}}}var b=H();if(0!==b.length){d.preventDefault();e.setPointerCapture(B);var l=e.getBoundingClientRect(),v=Math.floor(80*(d.clientX-l.x)/l.width),t=Math.floor(25*(d.clientY-l.y)/l.height);b.length%2?f(m,v,t,178,b[Math.floor(b.length/2)],b[Math.floor(b.length/2)+1]):f(m,v,t,219,b[b.length/2],0);e.addEventListener("pointermove",q);e.addEventListener("pointerup",F)}}}}}},x=document.getElementById("add-gradient-slot"),y=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),
aa=document.querySelector(".gradient-slots"),E=d=>{const b=y.cloneNode(!0);b.dataset.value=String(d);b.querySelector(".remove-gradient-slot").onclick=()=>{aa.removeChild(b)};aa.insertBefore(b,x)};x.onclick=()=>{E(r[0])};E(0);E(8);E(7);E(15);let H=()=>{const d=document.querySelectorAll(".gradient-slots .gradient-slot"),b=[];for(let l=0;l<d.length;l++)b.push(Number(d[l].dataset.value));return b},P=(d,b)=>{if(2>d.length)return{charCode:219,fgColor:d[0]||0,bgColor:0};b=Math.max(0,Math.min(1,Number(b)||
0));b*=d.length;const l=Math.floor(b);if(l>=d.length-1)return{charCode:219,fgColor:d[d.length-1],bgColor:0};b-=l;return.125>b?{charCode:0,fgColor:d[l+1],bgColor:d[l]}:.375>b?{charCode:176,fgColor:d[l+1],bgColor:d[l]}:.625>b?{charCode:177,fgColor:d[l+1],bgColor:d[l]}:.875>b?{charCode:178,fgColor:d[l+1],bgColor:d[l]}:{charCode:219,fgColor:d[l+1],bgColor:0}},S;S=U.freehand();let ca=document.getElementById("tool-selector"),da=ca.value;document.body.classList.add("tool-"+da);ca.onchange=d=>{S&&S();S=U[ca.value]();
document.body.classList.remove("tool-"+da);da=ca.value;document.body.classList.add("tool-"+da)};e.oncontextmenu=d=>{d.preventDefault()};let ea=document.getElementById("char-picker"),wa=document.querySelector(".left-pick"),xa=document.querySelector(".right-pick"),fa=(d,b)=>{const l=Math.floor(d/64),v=b?xa:wa;v.style.left=`${d%64*8}px`;v.style.top=`${16*l}px`;J[b?2:0]=d};a=ea.getContext("2d");if(!a)throw Error("unable to create canvas context");for(let d=0;256>d;d++)f(a,d%64,Math.floor(d/64),d,7,0);
ea.onpointerdown=d=>{if("mouse"===d.pointerType&&(0===d.button||2===d.button)){var b=ea.getBoundingClientRect();fa(64*Math.floor(4*(d.clientY-b.y)/b.height)+Math.floor(64*(d.clientX-b.x)/b.width),2===d.button)}};ea.oncontextmenu=d=>{d.preventDefault()};document.getElementById("save-image").onclick=d=>{d=g.saveBlob();d=URL.createObjectURL(d);let b=document.createElement("a");b.download="dosimage.dat";b.href=d;b.click()};document.getElementById("load-image").onclick=async d=>{if(d=await pa()){try{await g.loadBlob(d)}catch(b){alert(b);
return}m.drawImage(g.canvas,0,0)}};document.getElementById("clear-image").onclick=d=>{g.fill(J[2],r[0],r[2],u);m.drawImage(g.canvas,0,0)}},{once:!0})})()
