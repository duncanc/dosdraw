'use strict';(function(){function ba(a){a-=179;return!Number.isInteger(a)||0>a||a>=ra.length?0:ra[a]}function Y(a){return Ea[a]||0}function sa(a,b,g,e,k,d,m){let [n,H]=a<g?[a,g]:[g,a],[F,l]=b<e?[b,e]:[e,b];a=m?32:0;m=m?16:0;if(F===l)if(n===H)d(n,F,Y(15));else{d(n,F,Y(ba(k(n,F))&-33|8|a));for(m=n+1;m<H;m++)d(m,F,Y(ba(k(m,F))&-33|12|a));d(H,F,Y(ba(k(H,F))&-33|4|a))}else if(n===H){d(n,F,Y(ba(k(n,F))&-17|2|m));for(a=F+1;a<l;a++)d(n,a,Y(ba(k(n,a))&-17|3|m));d(n,l,Y(ba(k(n,l))&-17|1|m))}else{d(n,F,Y(ba(k(n,
F))&-49|10|a|m));for(b=n+1;b<H;b++)d(b,F,Y(ba(k(b,F))&-33|12|a));d(H,F,Y(ba(k(H,F))&-49|6|a|m));for(b=F+1;b<l;b++)d(n,b,Y(ba(k(n,b))&-17|3|m)),d(H,b,Y(ba(k(H,b))&-17|3|m));d(n,l,Y(ba(k(n,l))&-49|9|a|m));for(b=n+1;b<H;b++)d(b,l,Y(ba(k(b,l))&-33|12|a));d(H,l,Y(ba(k(H,l))&-49|5|m|a))}}function fa(){return ta=ta||new Promise((a,b)=>{let g=indexedDB.open("dosdraw",1);g.onerror=()=>{b(g.error||"unable to open db")};g.onblocked=()=>{b("blocked")};g.onupgradeneeded=({oldVersion:e})=>{1>e&&(e=g.result,e.createObjectStore("sessions",
{autoIncrement:!0,keyPath:"id"}),e=e.createObjectStore("updates",{autoIncrement:!0,keyPath:"id"}),e.createIndex("bySessionId","sessionId",{unique:!1,multiEntry:!1}),e.createIndex("byParentUpdateId","parentUpdateId",{unique:!1,multiEntry:!1}))};g.onsuccess=()=>{a(g.result)}})}function Fa(a){return fa().then(b=>new Promise((g,e)=>{let k=b.transaction(["sessions","updates"],"readwrite"),d=k.objectStore("sessions"),m=k.objectStore("updates"),n={sessionId:-1,headUpdateId:-1};k.oncomplete=()=>{g(n)};k.onerror=
()=>{e(k.error||"db failure")};let H=d.add({saved:!0,headUpdateId:-1});H.onsuccess=()=>{let F=H.result;n.sessionId=F;let l=m.add({sessionId:F,parentUpdateId:-1,data:a,x:0,y:0,width:80,height:25});l.onsuccess=()=>{let p=l.result;n.headUpdateId=p;d.put({id:F,saved:!0,headUpdateId:p})}}}))}function Ga(a,b){return fa().then(g=>new Promise((e,k)=>{let d=g.transaction(["sessions"],"readwrite");d.oncomplete=()=>{e()};d.onerror=()=>{k(d.error||"db failure")};let m=d.objectStore("sessions"),n=m.get(a);n.onsuccess=
()=>{let H=n.result;H&&!H.saved&&(H.saved=!0,H.headUpdateId=b,m.put(H))}}))}function Ha(a){let b=Infinity;var g=-Infinity;let e=Infinity;var k=-Infinity;for(var d=0;80>d;d++)for(var m=0;25>m;m++)a[80*m+d]&&(b=Math.min(b,d),g=Math.max(g,d),e=Math.min(e,m),k=Math.max(k,m));if(Infinity===b)return{width:0,height:0,x:0,y:0,data:new Uint16Array(0)};g=g+1-b;k=k+1-e;d=new Uint16Array(g*k);for(m=0;m<k;m++)d.set(a.subarray(80*(e+m)+b,80*(e+m)+b+g),m*g);return{width:g,height:k,x:b,y:e,data:d}}function aa(a,
b,g,e){let k=new Uint16Array(2E3);for(let l=0;l<k.length;l++)k[l]=g[l]^e[l];let {x:d,y:m,width:n,height:H,data:F}=Ha(k);return fa().then(l=>new Promise((p,R)=>{let E=l.transaction(["sessions","updates"],"readwrite"),q=E.objectStore("sessions"),L=E.objectStore("updates"),z=q.get(a),M=-1;E.oncomplete=()=>{p(M)};E.onerror=()=>{R(E.error||"db failure")};z.onsuccess=()=>{let B=z.result;if(B){let ca=L.add({sessionId:B.id,x:d,y:m,width:n,height:H,data:F,parentUpdateId:b});ca.onsuccess=()=>{M=ca.result;B.saved=
!1;B.headUpdateId=M;q.put(B)}}else R("session not found: "+a)}}))}function Ia(a,b,g){return fa().then(e=>new Promise((k,d)=>{let m=e.transaction(["updates","sessions"],"readwrite"),n=m.objectStore("sessions"),H=m.objectStore("updates").get(b),F=-1;m.oncomplete=()=>{k({data:g,newUpdateId:F})};m.onerror=()=>{d(m.error||"db failure")};H.onsuccess=()=>{let l=H.result;if(!l)throw Error("update not found: "+b);if(l.sessionId!==a)throw Error("wrong session id");if(-1===l.parentUpdateId)F=b;else{F=l.parentUpdateId;
var p=n.get(a);ua(g,l);p.onsuccess=()=>{let R=H.result;if(!R)throw Error("session not found: "+a);R.saved=!1;R.headUpdateId=l.parentUpdateId;n.put(R)}}}}))}function Ja(a,b,g){return fa().then(e=>new Promise((k,d)=>{let m=e.transaction(["updates","sessions"],"readwrite"),n=m.objectStore("sessions"),H=m.objectStore("updates").index("byParentUpdateId"),F=-1;m.oncomplete=()=>{k({data:g,newUpdateId:F})};m.onerror=()=>{d(m.error||"db failure")};let l=H.openCursor(b,"prev");l.onsuccess=()=>{var p=l.result;
if(p){p=p.value;if(p.sessionId!==a)throw Error("wrong session id");ua(g,p);F=p.id;n.put({id:a,headUpdateId:p.id,saved:!1})}else F=b}}))}function*ha(a,b,g,e){let k=Math.abs(g-a),d=Math.abs(e-b),m=a<g?1:-1,n=b<e?1:-1,H=k-d;for(;;){yield[a,b];if(a===g&&b===e)break;let F=2*H;F>-d&&(H-=d,a+=m);F<k&&(H+=k,b+=n)}}function*va(a,b,g,e){let k=Math.sign(g-a),d=Math.sign(e-b);if(0===k)if(0===d)yield[a,b];else for(g=b;g!==e+d;g+=d)yield[a,g];else if(0===d)for(;a!==g+k;a+=k)yield[a,b];else for(;b!==e+d;b+=d)for(let m=
a;m!==g+k;m+=k)yield[m,b]}function*Ka(a,b,g,e){let k=Math.sign(g-a),d=Math.sign(e-b);if(0===k)if(0===d)yield[a,b];else for(g=b;g!==e+d;g+=d)yield[a,g];else if(0===d)for(e=a;e!==g+k;e+=k)yield[e,b];else{for(let m=a;m!==g+k;m+=k)yield[m,b];for(b+=d;b!==e;b+=d)yield[a,b],yield[g,b];for(;a!==g+k;a+=k)yield[a,e]}}function La(){return new Promise((a,b)=>{let g=document.createElement("input");g.type="file";g.onchange=e=>{var k;(null===(k=g.files)||void 0===k?0:k.length)?a(g.files[0]):a(null)};g.click()})}
function X(a,b){let g=0;for(;a&b;){var e=Math.clz32(b);e=32-Math.clz32(~b<<e>>>e);e=b>>>e<<e;e&a&&(g|=e,a&=~e);b&=~e}return g}function Ma(a,b,g,e,k,d,m){if(!(0>a||0>b||80<=a||25<=b)){var n=Math.floor(a%1*8),H=Math.floor(b%1*8);a=Math.floor(a);b=Math.floor(b);var {charCode:F,bgColor:l,fgColor:p}=g(a,b);if(l===p||32===F||255===F)F=0;var R=!!(k[F][H]&128>>>n),E=R?p:l,q=[],L=R?0:255,z=R?0:65535,M=X(128>>>n,k[F][H]^L),B=X(32768>>>H,d[F][n]^z);a:if(0!==b){var ca=M;for(let D=H-1;0<=D;D--)if(ca=X(ca,k[F][D]^
L),0===ca)break a;q.push({x:a,y:b-1,side:"bottom",mask:ca})}a:if(24!==b){for(H+=1;8>H;H++)if(M=X(M,k[F][H]^L),0===M)break a;q.push({x:a,y:b+1,side:"top",mask:M})}a:if(0!==a){L=B;for(H=n-1;0<=H;H--)if(L=X(L,d[F][H]^z),0===L)break a;q.push({x:a-1,y:b,side:"right",mask:L})}a:if(79!==a){for(n+=1;8>n;n++)if(B=X(B,d[F][n]^z),0===B)break a;q.push({x:a+1,y:b,side:"left",mask:B})}R?e(a,b,F,m,l):e(a,b,F,p,m);for(a=new Set([`${a},${b}`]);0<q.length;){let {x:D,y:C,side:P,mask:G}=q.pop(),{charCode:N,bgColor:T,
fgColor:S}=g(D,C);if(T!==E&&S!==E||177===N||176===N&&T!==E||178===N&&S!==E)a.add(`${D},${C}`);else{if(S===T||32===N||255===N)N=0;b=T===E?255:0;R=T===E?65535:0;switch(P){case "top":for(z=B=n=0;16>z;z++){G=X(G,k[N][z]^b);if(0===G)break;G&128&&(n|=X(1<<z,d[N][0]^R));G&1&&(B|=X(1<<z,d[N][7]^R))}0<z&&(G&&24!==C&&!a.has(`${D},${C+1}`)&&q.push({x:D,y:C+1,side:"top",mask:G}),n&&0!==D&&!a.has(`${D-1},${C}`)&&q.push({x:D-1,y:C,side:"right",mask:n}),B&&79!==D&&!a.has(`${D+1},${C}`)&&q.push({x:D+1,y:C,side:"left",
mask:B}),T===E?e(D,C,N,S,m):e(D,C,N,m,T),a.add(`${D},${C}`));break;case "bottom":B=n=0;for(z=15;0<=z;z--){G=X(G,k[N][z]^b);if(0===G)break;G&128&&(n|=X(1<<z,d[N][0]^R));G&1&&(B|=X(1<<z,d[N][7]^R))}15>z&&(G&&0!==C&&!a.has(`${D},${C-1}`)&&q.push({x:D,y:C-1,side:"bottom",mask:G}),n&&0!==D&&!a.has(`${D-1},${C}`)&&q.push({x:D-1,y:C,side:"right",mask:n}),B&&79!==D&&!a.has(`${D+1},${C}`)&&q.push({x:D+1,y:C,side:"left",mask:B}),T===E?e(D,C,N,S,m):e(D,C,N,m,T),a.add(`${D},${C}`));break;case "left":for(z=B=
n=0;8>z;z++){G=X(G,d[N][z]^R);if(0===G)break;G&32768&&(B|=X(128>>z,k[N][15]^b));G&1&&(n|=X(128>>z,k[N][0]^b))}0<z&&(G&&79!==D&&!a.has(`${D+1},${C}`)&&q.push({x:D+1,y:C,side:"left",mask:G}),n&&0!==C&&!a.has(`${D},${C-1}`)&&q.push({x:D,y:C-1,side:"bottom",mask:n}),B&&24!==C&&!a.has(`${D},${C+1}`)&&q.push({x:D,y:C+1,side:"top",mask:B}),T===E?e(D,C,N,S,m):e(D,C,N,m,T),a.add(`${D},${C}`));break;case "right":B=n=0;for(z=7;0<=z;z--){G=X(G,d[N][z]^R);if(0===G)break;G&32768&&(B|=X(128>>z,k[N][15]^b));G&1&&
(n|=X(128>>z,k[N][0]^b))}7>z&&(G&&0!==D&&!a.has(`${D-1},${C}`)&&q.push({x:D-1,y:C,side:"right",mask:G}),n&&0!==C&&!a.has(`${D},${C-1}`)&&q.push({x:D,y:C-1,side:"bottom",mask:n}),B&&24!==C&&!a.has(`${D},${C+1}`)&&q.push({x:D,y:C+1,side:"top",mask:B}),T===E?e(D,C,N,S,m):e(D,C,N,m,T),a.add(`${D},${C}`))}}}}}let wa=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var Z;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=
65535]="All"})(Z||(Z={}));var ka;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]="White"})(ka||(ka={}));let xa="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");
class ya{constructor(a){this.drawChar=a;this.buffer=new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,b,g,e){if(!Number.isInteger(a)||!Number.isInteger(b))throw new TypeError("x and y must be integers");if(!Number.isInteger(g)||!Number.isInteger(b))throw new TypeError("width and height must be integers");if(0>
a||0>b||0>g||0>e||80<a+g||25<b+e)throw new RangeError("edges exceed screen");let k=new Uint16Array(g*e);for(let d=0;d<e;d++)k.set(this.buffer.subarray(80*(b+d)+a,80*(b+d)+a+g),d*g);return{data:k,width:g,height:e}}putBrush(a,b,g){let e,k,d=a.data;if(0>b){e=-b;if(e>=a.width)return;b=0}else e=0;k=Math.min(80-b,b+a.width);if(0>g){d=d.subarray(g*a.width);if(0===d.length)return;g=0}for(let m=0;m<a.height;m++)if(!(0>g+m)){if(25<=g+m)break;this.buffer.set(d.subarray((g+m)*a.width+e,(g+m)*a.width+k),80*g+
b);for(let n=e;n<k;n++)this.updateCanvas(g+m,b+n)}}getRawChar(a,b){return this.buffer[80*b+a]||0}setRawChar(a,b,g){0>a||0>b||80<=a||25<=b||(this.buffer[80*b+a]=g)}updateCanvas(a,b){if(!(0>a||0>b||80<=a||25<=b)){var g=this.getRawChar(a,b);this.drawChar(this.ctx,a,b,g&255,g>>8&15,g>>12&15)}}getCharInfo(a,b){a=this.getRawChar(a,b);return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,b){return this.getRawChar(a,b)&255}putChar(a,b,g,e,k){this.setRawChar(a,b,g|e<<8|k<<12);this.updateCanvas(a,
b)}setChar(a,b,g,e,k,d=Z.All){this.setRawChar(a,b,this.buffer[80*b+a]&~d|(g|e<<8|k<<12)&d);this.updateCanvas(a,b)}fill(a,b,g,e=Z.All){a=(a|b<<8|g<<12)&e;for(b=0;25>b;b++)for(g=0;80>g;g++)this.setRawChar(g,b,this.getRawChar(g,b)&~e|a),this.updateCanvas(g,b)}putVHalf(a,b,g){var e=this.getRawChar(a,b>>1);let k=e>>>8&15,d=e>>>12&15,m=b&1;switch(e&255){case 219:case 8:case 10:e=k;break;default:e=d;break;case 220:e=1===m?d:k;break;case 223:e=1===m?k:d}e===g?this.putChar(a,b>>1,219,g,d):0===m?this.putChar(a,
b>>1,223,g,e):this.putChar(a,b>>1,220,g,e)}putHHalf(a,b,g){var e=this.getRawChar(a>>1,b);let k=e>>>8&15,d=e>>>12&15,m=a&1;switch(e&255){case 219:case 8:case 10:e=k;break;default:e=d;break;case 222:e=1===m?d:k;break;case 221:e=1===m?k:d}e===g?this.putChar(a>>1,b,219,g,d):0===m?this.putChar(a>>1,b,221,g,e):this.putChar(a>>1,b,222,g,e)}saveBlob(){if(wa)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let b=0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=
await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");a=new Uint16Array(a);if(!wa)for(var b=0;b<a.length;b++)a[b]=a[b]>>8|a[b]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(b=0;80>b;b++)this.updateCanvas(b,a)}}class Na extends ya{constructor(a){super(a.drawChar);this.baseScreen=a;this.mask=new Uint8Array(this.buffer.length)}reset(){this.mask.fill(0);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateCanvas(a,b){if(!(0>a||0>b||80<=a||25<=b))if(this.mask[80*
b+a]){let g=this.buffer[80*b+a];this.drawChar(this.ctx,a,b,g&255,g>>8&15,g>>12&15)}else this.ctx.clearRect(8*a,16*b,8,16)}getRawChar(a,b){return(this.mask[80*b+a]?this.buffer:this.baseScreen.buffer)[80*b+a]||0}setRawChar(a,b,g){0>a||0>b||80<=a||25<=b||(this.buffer[80*b+a]=g,this.mask[80*b+a]=255)}clearChar(a,b){0>a||0>b||80<=a||25<=b||(this.mask[80*b+a]=0,this.updateCanvas(a,b))}commit(){for(let a=0;a<this.buffer.length;a++)this.mask[a]&&(this.baseScreen.buffer[a]=this.buffer[a],this.baseScreen.updateCanvas(a%
80,Math.floor(a/80)));this.reset()}shiftChars(a,b,g,e){let k=80*b+a,d=k+g;0>e?(this.buffer.copyWithin(k,k-e,d),this.mask.copyWithin(k,k-e,d),this.mask.fill(0,d+e,d)):(this.buffer.copyWithin(k+e,k,d-e),this.mask.copyWithin(k+e,k,d-e),this.mask.fill(0,k,k+e));for(e=0;e<g;e++)this.updateCanvas(a+e,b)}isModified(a,b){return!!this.mask[80*b+a]}}let Ea=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,
181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,202,203,206]),ra=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),ua=(a,{x:b,y:g,width:e,height:k,data:d})=>{for(let m=0;m<k;m++)for(let n=0;n<e;n++)a[80*(g+m)+b+n]^=d[m*e+n]},ta,Oa=-1===(navigator.platform||"").toUpperCase().indexOf("MAC")?a=>a.ctrlKey:a=>a.metaKey,Pa=fetch("./chardata.png"),Qa=a=>{var b=document.createElement("canvas");
b.width=a.width;b.height=a.height;b=b.getContext("2d");if(!b)throw Error("unable to create 2D canvas");b.drawImage(a,0,0);var g=a.width/9;a=new Uint8Array(4096);for(let e=0;256>e;e++){const {data:k}=b.getImageData(e%g*9,16*Math.floor(e/g),8,16);for(let d=0;16>d;d++)a[16*e+d]=k[32*d+3]?128:0,a[16*e+d]|=k[4*(8*d+1)+3]?64:0,a[16*e+d]|=k[4*(8*d+2)+3]?32:0,a[16*e+d]|=k[4*(8*d+3)+3]?16:0,a[16*e+d]|=k[4*(8*d+4)+3]?8:0,a[16*e+d]|=k[4*(8*d+5)+3]?4:0,a[16*e+d]|=k[4*(8*d+5)+3]?2:0,a[16*e+d]|=k[4*(8*d+7)+3]?
1:0}b=Array(256);for(g=0;256>g;g++)b[g]=a.subarray(16*g,16*(g+1));return b},Ra=a=>{const b=new Uint16Array(2048);for(var g=0;256>g;g++)for(let e=0;8>e;e++)for(let k=0;16>k;k++)b[8*g+e]|=(a[g][k]>>>7-e&1)<<k;a=Array(256);for(g=0;256>g;g++)a[g]=b.subarray(8*g,8*(g+1));return a};ka=[0,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,b)=>32+b),8962,199,252,233,226,228,224,
229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,
247,8776,176,8729,183,8730,8319,178,9632,160];let za=new Map(ka.map((a,b)=>[String.fromCodePoint(a),b]));window.addEventListener("DOMContentLoaded",async function(){var a=await (await Pa).blob();let b=await createImageBitmap(a),g=b.width/9;a=(c,f,r,v,t,A)=>{c.save();c.globalCompositeOperation="source-over";c.fillStyle=xa[A];c.fillRect(8*f,16*r,8,16);c.globalCompositeOperation="destination-out";c.drawImage(b,v%g*9,16*Math.floor(v/g),8,16,8*f,16*r,8,16);c.globalCompositeOperation="destination-over";
c.fillStyle=xa[t];c.fillRect(8*f,16*r,8,16);c.restore()};let e=Qa(b),k=Ra(e),d=new ya(a),{sessionId:m,headUpdateId:n}=await Fa(d.buffer),H=async()=>{var c=new Uint16Array(d.buffer);const {data:f,newUpdateId:r}=await Ia(m,n,c);d.buffer.set(f);for(c=0;25>c;c++)for(let v=0;80>v;v++)d.updateCanvas(v,c);E.globalCompositeOperation="copy";E.drawImage(d.canvas,0,0);n=r},F=async()=>{var c=new Uint16Array(d.buffer);const {data:f,newUpdateId:r}=await Ja(m,n,c);d.buffer.set(f);for(c=0;25>c;c++)for(let v=0;80>
v;v++)d.updateCanvas(v,c);E.globalCompositeOperation="copy";E.drawImage(d.canvas,0,0);n=r};document.getElementById("undo").onclick=H;document.getElementById("redo").onclick=F;document.addEventListener("keydown",c=>{Oa(c)&&("y"===c.key.toLowerCase()||"z"===c.key.toLowerCase()&&c.shiftKey?(F(),c.preventDefault()):"z"!==c.key.toLowerCase()||c.shiftKey||(H(),c.preventDefault()))});let l=new Na(d),p=document.getElementById("editor");var R=document.getElementById("editor-overlay");let E=p.getContext("2d"),
q=R.getContext("2d"),L=new Uint16Array(2E3),z=new Uint16Array(2E3);if(!E||!q)throw Error("unable to create canvas context");let M=Z.All;document.getElementById("tile").onchange=c=>{M=c.target.checked?M|Z.Tile:M&~Z.Tile};document.getElementById("fgcolor").onchange=c=>{M=c.target.checked?M|Z.ForegroundColor:M&~Z.ForegroundColor};document.getElementById("bgcolor").onchange=c=>{M=c.target.checked?M|Z.BackgroundColor:M&~Z.BackgroundColor};let B=[7,0,0],ca=document.querySelector(".palette"),D=(c,f)=>{const r=
f?"background-selected":"foreground-selected";var v=ca.querySelectorAll(`.${r}`);for(let t=0;t<v.length;t++)v[t].classList.remove(r);(v=ca.querySelector(`.color-cell[data-value='${c}']`))&&v.classList.add(r);B[f?2:0]=c};ca.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var f=0===c.button?"foreground-selected":"background-selected";for(let r=c.target;r&&!r.classList.contains("palette");r=r.parentElement)if("value"in r.dataset){let v=ca.querySelectorAll(`.${f}`);for(let t=
0;t<v.length;t++)v[t].classList.remove(f);r.classList.add(f);B[c.button]=+r.dataset.value;c.preventDefault();c.stopPropagation();break}}};ca.oncontextmenu=c=>{c.preventDefault()};let C=[219,0,0],P=0,G=0,N=0,T=document.querySelector(".cursor"),S=(c,f)=>{T.style.left=`${8*c}px`;T.style.top=`${16*f}px`;T.style.animation="none";T.getBoundingClientRect();T.style.removeProperty("animation");P=c;G=f},da=document.querySelector("#editor-block"),ia="freehand",Ba={freehand:()=>{ia="freehand";p.onpointerdown=
c=>{if("mouse"===c.pointerType){const {button:A,pointerId:h}=c;if(0===A||2===A){async function u(x){x.pointerId===h&&x.button===A&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(y=>{n=y}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",w),p.removeEventListener("pointerup",u))}function w(x){if(x.pointerId===h){var y=Math.floor(80*(x.clientX-f.x)/f.width);x=Math.floor(25*(x.clientY-
f.y)/f.height);for(const [I,K]of ha(v,t,y,x))l.setChar(I,K,C[A],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);v=y;t=x}}c.preventDefault();p.setPointerCapture(h);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width);c=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,c,C[A],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);var v=r,t=c;p.addEventListener("pointermove",w);p.addEventListener("pointerup",u)}}}},vbFreehand:()=>{p.onpointerdown=
c=>{if("mouse"===c.pointerType){const {button:A,pointerId:h}=c;if(0===A||2===A){function u(x){x.pointerId===h&&x.button===A&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(y=>{n=y}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",w),p.removeEventListener("pointerup",u))}function w(x){if(x.pointerId===h){var y=Math.floor(80*(x.clientX-f.x)/f.width);x=Math.floor(50*(x.clientY-f.y)/
f.height);for(const [I,K]of ha(v,t,y,x))l.putVHalf(I,K,B[A]);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);v=y;t=x}}c.preventDefault();p.setPointerCapture(h);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width);c=Math.floor(50*(c.clientY-f.y)/f.height);l.putVHalf(r,c,B[A]);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);var v=r,t=c;p.addEventListener("pointermove",w);p.addEventListener("pointerup",u)}}}},hbFreehand:()=>{p.onpointerdown=c=>{if("mouse"===
c.pointerType){const {button:A,pointerId:h}=c;if(0===A||2===A){function u(x){x.pointerId===h&&x.button===A&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(y=>{n=y}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",w),p.removeEventListener("pointerup",u))}function w(x){if(x.pointerId===h){var y=Math.floor(160*(x.clientX-f.x)/f.width);x=Math.floor(25*(x.clientY-f.y)/f.height);for(const [I,
K]of ha(v,t,y,x))l.putHHalf(I,K,B[A]);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);v=y;t=x}}c.preventDefault();p.setPointerCapture(h);var f=p.getBoundingClientRect(),r=Math.floor(160*(c.clientX-f.x)/f.width);c=Math.floor(25*(c.clientY-f.y)/f.height);l.putHHalf(r,c,B[A]);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);var v=r,t=c;p.addEventListener("pointermove",w);p.addEventListener("pointerup",u)}}}},lines:()=>{ia="lines";p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:t,
pointerId:A}=c;if(0===t||2===t){function h(w){w.pointerId===A&&w.button===t&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(x=>{n=x}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",u),p.removeEventListener("pointerup",h))}function u(w){if(w.pointerId===A){var x=Math.floor(80*(w.clientX-f.x)/f.width);w=Math.floor(25*(w.clientY-f.y)/f.height);l.reset();for(const [y,I]of ha(r,v,
x,w))l.setChar(y,I,C[t],B[0],B[2],M);q.drawImage(l.canvas,0,0)}}c.preventDefault();p.setPointerCapture(A);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width),v=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,v,C[t],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);p.addEventListener("pointermove",u);p.addEventListener("pointerup",h)}}}},filledBox:()=>{ia="filledBox";p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:t,pointerId:A}=c;if(0===
t||2===t){function h(w){w.pointerId===A&&w.button===t&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(x=>{n=x}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",u),p.removeEventListener("pointerup",h))}function u(w){if(w.pointerId===A){var x=Math.floor(80*(w.clientX-f.x)/f.width);w=Math.floor(25*(w.clientY-f.y)/f.height);l.reset();for(const [y,I]of va(r,v,x,w))l.setChar(y,I,C[t],
B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0)}}c.preventDefault();p.setPointerCapture(A);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width),v=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,v,C[t],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);p.addEventListener("pointermove",u);p.addEventListener("pointerup",h)}}}},emptyBox:()=>{ia="emptyBox";p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:t,pointerId:A}=
c;if(0===t||2===t){function h(w){w.pointerId===A&&w.button===t&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(x=>{n=x}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",u),p.removeEventListener("pointerup",h))}function u(w){if(w.pointerId===A){var x=Math.floor(80*(w.clientX-f.x)/f.width);w=Math.floor(25*(w.clientY-f.y)/f.height);l.reset();for(const [y,I]of Ka(r,v,x,w))l.setChar(y,
I,C[t],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0)}}c.preventDefault();p.setPointerCapture(A);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width),v=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,v,C[t],B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);p.addEventListener("pointermove",u);p.addEventListener("pointerup",h)}}}},singleBorder:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:t,pointerId:A}=c;
if(0===t||2===t){function h(w){w.pointerId===A&&w.button===t&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(x=>{n=x}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",u),p.removeEventListener("pointerup",h))}function u(w){if(w.pointerId===A){var x=Math.floor(80*(w.clientX-f.x)/f.width);w=Math.floor(25*(w.clientY-f.y)/f.height);l.reset();sa(r,v,x,w,(y,I)=>d.getChar(y,I),(y,I,K)=>
l.setChar(y,I,K,B[0],B[2],M),!1);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0)}}c.preventDefault();p.setPointerCapture(A);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width),v=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,v,Y(15),B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);p.addEventListener("pointermove",u);p.addEventListener("pointerup",h)}}}},doubleBorder:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:t,pointerId:A}=
c;if(0===t||2===t){function h(w){w.pointerId===A&&w.button===t&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(x=>{n=x}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",u),p.removeEventListener("pointerup",h))}function u(w){if(w.pointerId===A){var x=Math.floor(80*(w.clientX-f.x)/f.width);w=Math.floor(25*(w.clientY-f.y)/f.height);l.reset();sa(r,v,x,w,(y,I)=>d.getChar(y,I),(y,I,
K)=>l.setChar(y,I,K,B[0],B[2],M),!0);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0)}}c.preventDefault();p.setPointerCapture(A);var f=p.getBoundingClientRect(),r=Math.floor(80*(c.clientX-f.x)/f.width),v=Math.floor(25*(c.clientY-f.y)/f.height);l.setChar(r,v,Y(15),B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);p.addEventListener("pointermove",u);p.addEventListener("pointerup",h)}}}},colorFloodFill:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:v}=
c;if(0===v||2===v){c.preventDefault();var f=p.getBoundingClientRect(),r=80*(c.clientX-f.x)/f.width;c=25*(c.clientY-f.y)/f.height;L.set(d.buffer);Ma(r,c,(t,A)=>d.getCharInfo(t,A),(t,A,h,u,w)=>d.putChar(t,A,h,u,w),e,k,B[v]);z.set(d.buffer);aa(m,n,L,z).then(t=>{n=t});E.globalCompositeOperation="copy";E.drawImage(d.canvas,0,0)}}}},pick:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:A,pointerId:h}=c;if(0===A||2===A){function u(x){x.pointerId===h&&x.button===A&&(p.removeEventListener("pointermove",
w),p.removeEventListener("pointerup",u),ea.value=ia,ea.dispatchEvent(new Event("change")))}function w(x){if(x.pointerId===h){var y=p.getBoundingClientRect(),{charCode:I,fgColor:K,bgColor:U}=d.getCharInfo(Math.floor(80*(x.clientX-y.x)/y.width),Math.floor(25*(x.clientY-y.y)/y.height));M&Z.Tile&&oa(I,2===A);M&Z.ForegroundColor&&D(K,!1);M&Z.BackgroundColor&&D(U,!0)}}c.preventDefault();p.setPointerCapture(h);var f=p.getBoundingClientRect(),{charCode:r,fgColor:v,bgColor:t}=d.getCharInfo(Math.floor(80*(c.clientX-
f.x)/f.width),Math.floor(25*(c.clientY-f.y)/f.height));M&Z.Tile&&oa(r,2===A);M&Z.ForegroundColor&&D(v,!1);M&Z.BackgroundColor&&D(t,!0);p.addEventListener("pointermove",w);p.addEventListener("pointerup",u)}}}},text:()=>{function c(h){if("AltLeft"===h.code||"AltRight"===h.code)h.preventDefault(),h.stopPropagation();else{switch(h.key){case "Tab":return;case "ArrowDown":if(h.altKey||h.ctrlKey||h.metaKey)return;S(P,Math.min(G+1,24));h.preventDefault();h.stopPropagation();return;case "ArrowUp":if(h.altKey||
h.ctrlKey||h.metaKey)return;S(P,Math.max(G-1,0));h.preventDefault();h.stopPropagation();return;case "ArrowLeft":if(h.altKey||h.ctrlKey||h.metaKey)return;0===P?0!==G&&S(79,G-1):(P-1<N&&(N=P-1),S(P-1,G));h.preventDefault();h.stopPropagation();return;case "ArrowRight":if(h.altKey||h.ctrlKey||h.metaKey)return;79===P?24!==G&&S(0,G+1):S(P+1,G);h.preventDefault();h.stopPropagation();return;case "Enter":if(h.altKey||h.ctrlKey||h.metaKey)return;S(N,Math.min(24,G+1));h.preventDefault();h.stopPropagation();
return;case "End":case "PageDown":if(h.altKey||h.ctrlKey||h.metaKey)return;S(P,24);h.preventDefault();h.stopPropagation();return;case "Home":case "PageUp":if(h.altKey||h.ctrlKey||h.metaKey)return;S(P,0);h.preventDefault();h.stopPropagation();return;case "Backspace":if(h.altKey||h.ctrlKey||h.metaKey)return;0===P?0!==G&&S(79,G-1):(P-1<N&&(N=P-1),S(P-1,G));l.shiftChars(P,G,80-P,-1);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);return;case "Delete":if(h.altKey||h.ctrlKey||h.metaKey)return;
l.shiftChars(P,G,80-P,-1);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);return}if(h.altKey&&!h.ctrlKey&&3===h.location&&"0"<=h.key&&"9">=h.key)A.push(h.key),h.preventDefault(),h.stopPropagation();else if(!h.ctrlKey&&!h.altKey){const u=za.get(h.key);"number"===typeof u&&(t(u),h.preventDefault(),h.stopPropagation())}}}function f(h){if("Alt"===h.key||"AltLeft"===h.code||"AltRight"===h.code){if(0<A.length){const u=Number.parseInt(A.slice(-3).join(""))&255;A.length=0;t(u)}h.preventDefault();
h.stopPropagation()}}function r(h){var u,w;const x=null===(u=h.clipboardData)||void 0===u?void 0:u.getData("text");if(x){h.preventDefault();for(const y of x.replace(/\r\n?|\n\r/g,"\n"))"\n"===y?S(N,Math.min(24,G+1)):t(null!==(w=za.get(y))&&void 0!==w?w:63)}}da.focus();let v=!1;p.onpointerdown=h=>{if("mouse"===h.pointerType){var {button:u}=h;if(0===u){h.preventDefault();u=p.getBoundingClientRect();var w=Math.floor(80*(h.clientX-u.x)/u.width);S(w,Math.floor(25*(h.clientY-u.y)/u.height));N=w;da.focus()}}};
const t=h=>{v=!0;let u=P;for(;l.isModified(u,G);)if(80===++u){u--;break}u>P&&l.shiftChars(P,G,u+1-P,1);l.setChar(P,G,h,B[0],B[2],M);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);79===P?24!==G&&S(0,G+1):S(P+1,G)};da.onblur=function(){v&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(h=>{n=h}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),v=!1)};let A=[];da.addEventListener("keydown",c);da.addEventListener("keyup",
f);document.addEventListener("paste",r);return()=>{da.onblur=null;v&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(h=>{n=h}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0));da.removeEventListener("keydown",c);da.removeEventListener("keyup",f);document.removeEventListener("paste",r)}},gradientBox:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:h,pointerId:u}=c;if(0===h||2===h){function w(y){y.pointerId===
u&&y.button===h&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(I=>{n=I}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",x),p.removeEventListener("pointerup",w))}function x(y){if(y.pointerId===u){var I=Math.floor(80*(y.clientX-r.x)/r.width);y=Math.floor(25*(y.clientY-r.y)/r.height);l.reset();var [K,U]=v<I?[v,I]:[I,v],[V,W]=t<y?[t,y]:[y,t];for(const [O,J]of va(v,t,I,y)){if(0>O||
0>J||80<=O||25<=J)continue;I=A(O,J,K,U,V,W);const {charCode:Q,fgColor:pa,bgColor:Sa}=Aa(f,I);l.setChar(O,J,Q,pa,Sa)}q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0)}}var f=qa();if(0!==f.length){c.preventDefault();p.setPointerCapture(u);var r=p.getBoundingClientRect(),v=Math.floor(80*(c.clientX-r.x)/r.width),t=Math.floor(25*(c.clientY-r.y)/r.height);l.setChar(v,t,219,f[0],0);q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);c=document.getElementById("gradient-direction-selector");
var A="up"===c.value?(y,I,K,U,V,W)=>(I-W)/(V-W):"right"===c.value?(y,I,K,U,V,W)=>(y-K)/(U-K):"left"===c.value?(y,I,K,U,V,W)=>(y-U)/(K-U):(y,I,K,U,V,W)=>(I-V)/(W-V);p.addEventListener("pointermove",x);p.addEventListener("pointerup",w)}}}}},rainbowBrush:()=>{p.onpointerdown=c=>{if("mouse"===c.pointerType){const {button:w,pointerId:x}=c;if(0===w){function y(K){K.pointerId===x&&K.button===w&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(U=>{n=U}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,
0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",I),p.removeEventListener("pointerup",y))}function I(K){if(K.pointerId===x){var U=Math.floor(80*(K.clientX-v.x)/v.width);K=Math.floor(25*(K.clientY-v.y)/v.height);if(U!==h||K!==u){let V=!0;for(const [W,O]of ha(h,u,U,K)){if(V){V=!1;continue}A=(A+.25)%r;const {charCode:J,fgColor:Q,bgColor:pa}=Aa(f,A/r);l.setChar(W,O,J,Q,pa)}}q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);h=U;u=K}}c.preventDefault();
var f=qa(),r=f.length;if(0!==r){f.push(f[0]);p.setPointerCapture(x);var v=p.getBoundingClientRect(),t=Math.floor(80*(c.clientX-v.x)/v.width);c=Math.floor(25*(c.clientY-v.y)/v.height);l.setChar(t,c,219,f[0],f[0]);var A=0;q.globalCompositeOperation="copy";q.drawImage(l.canvas,0,0);var h=t,u=c;p.addEventListener("pointermove",I);p.addEventListener("pointerup",y)}}}}},spraypaint:()=>{p.onpointerdown=c=>{const {pointerId:f,pointerType:r,button:v}=c;if("mouse"===r&&0===v){const u=qa();if(0!==u.length){function w(y){y.pointerId===
f&&y.button===v&&(L.set(d.buffer),l.commit(),z.set(d.buffer),aa(m,n,L,z).then(I=>{n=I}),q.globalCompositeOperation="copy",q.drawImage(l.canvas,0,0),E.globalCompositeOperation="copy",E.drawImage(d.canvas,0,0),p.removeEventListener("pointermove",x),p.removeEventListener("pointerup",w))}function x(y){if(y.pointerId===f){var I=performance.now(),K=I-h;h=I;I=Math.floor(80*(y.clientX-A.x)/A.width);y=Math.floor(25*(y.clientY-A.y)/A.height);var {charCode:U,fgColor:V,bgColor:W}=d.getCharInfo(I,y),O=80*y+I;
if(-1===t[O])if(V===W){var J=u.indexOf(W);t[O]=-1===J?0:J}else switch(U){case 0:case 32:case 255:J=u.indexOf(W);t[O]=-1===J?0:J;break;case 8:case 10:case 219:J=u.indexOf(V);t[O]=-1===J?0:J;break;case 176:J=u.indexOf(W);var Q=u.indexOf(V);t[O]=-1===J?-1===Q?0:Math.max(0,Q-.5):-1===Q?Math.max(0,J-.5):J===Q-1?J+.25:Q===J-1?Q+.75:Math.max(0,Math.min(Q,J)+.25);break;case 177:J=u.indexOf(W);Q=u.indexOf(V);t[O]=-1===J?-1===Q?0:Math.max(0,Q-.5):-1===Q?Math.max(0,J-.5):J===Q-1?J+.5:Q===J-1?Q+.5:Math.max(0,
Math.min(Q,J)+.5);break;case 178:J=u.indexOf(W);Q=u.indexOf(V);t[O]=-1===J?-1===Q?0:Math.max(0,Q-.5):-1===Q?Math.max(0,J-.5):J===Q-1?J+.75:Q===J-1?Q+.25:Math.max(0,Math.min(Q,J)+.5);break;default:J=u.indexOf(W),-1===J&&(J=u.indexOf(V)),t[O]=J+.5}t[O]+=Math.min(.25,K/100);t[O]>=u.length-1?(O=219,J=u[u.length-1],K=0):(K=Math.floor(t[O]),O=t[O]-K,.125>O?(O=219,J=u[K],K=0):(O=.375>O?176:.625>O?177:.875>O?178:219,J=u[K+1],K=u[K]));if(O!==U||J!==V||K!==W)l.putChar(I,y,O,J,K),q.globalCompositeOperation=
"copy",q.drawImage(l.canvas,0,0)}}var t=new Float32Array(2E3);t.fill(-1);var A=p.getBoundingClientRect(),h=performance.now();p.addEventListener("pointermove",x);p.addEventListener("pointerup",w)}}}}},Ca=document.getElementById("add-gradient-slot"),Ta=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),Da=document.querySelector(".gradient-slots"),ja=c=>{const f=Ta.cloneNode(!0);f.dataset.value=String(c);f.querySelector(".remove-gradient-slot").onclick=()=>{Da.removeChild(f)};
Da.insertBefore(f,Ca)};Ca.onclick=()=>{ja(B[0])};ja(0);ja(8);ja(7);ja(15);let qa=()=>{const c=document.querySelectorAll(".gradient-slots .gradient-slot"),f=[];for(let r=0;r<c.length;r++)f.push(Number(c[r].dataset.value));return f},Aa=(c,f)=>{if(2>c.length)return{charCode:219,fgColor:c[0]||0,bgColor:0};f=Math.max(0,Math.min(1,Number(f)||0));f*=c.length-1;const r=Math.floor(f);if(r>=c.length-1)return{charCode:219,fgColor:c[c.length-1],bgColor:0};f-=r;return.125>f?{charCode:0,fgColor:c[r+1],bgColor:c[r]}:
.375>f?{charCode:176,fgColor:c[r+1],bgColor:c[r]}:.625>f?{charCode:177,fgColor:c[r+1],bgColor:c[r]}:.875>f?{charCode:178,fgColor:c[r+1],bgColor:c[r]}:{charCode:219,fgColor:c[r+1],bgColor:0}},la;la=Ba.freehand();let ea=document.getElementById("tool-selector"),ma=ea.value;document.body.classList.add("tool-"+ma);ea.onchange=c=>{la&&la();la=Ba[ea.value]();document.body.classList.remove("tool-"+ma);ma=ea.value;document.body.classList.add("tool-"+ma)};p.oncontextmenu=c=>{c.preventDefault()};let na=document.getElementById("char-picker"),
Ua=document.querySelector(".left-pick"),Va=document.querySelector(".right-pick"),oa=(c,f)=>{const r=Math.floor(c/64),v=f?Va:Ua;v.style.left=`${c%64*8}px`;v.style.top=`${16*r}px`;C[f?2:0]=c};R=na.getContext("2d");if(!R)throw Error("unable to create canvas context");for(let c=0;256>c;c++)a(R,c%64,Math.floor(c/64),c,7,0);na.onpointerdown=c=>{if("mouse"===c.pointerType&&(0===c.button||2===c.button)){var f=na.getBoundingClientRect();oa(64*Math.floor(4*(c.clientY-f.y)/f.height)+Math.floor(64*(c.clientX-
f.x)/f.width),2===c.button)}};na.oncontextmenu=c=>{c.preventDefault()};document.getElementById("save-image").onclick=c=>{c=d.saveBlob();c=URL.createObjectURL(c);let f=document.createElement("a");f.download="dosimage.dat";f.href=c;f.click();Ga(m,n)};document.getElementById("load-image").onclick=async c=>{if(c=await La()){let f=new Uint16Array(d.buffer);try{await d.loadBlob(c)}catch(r){alert(r);return}z.set(d.buffer);aa(m,n,f,z).then(r=>{n=r});E.drawImage(d.canvas,0,0)}};document.getElementById("clear-image").onclick=
c=>{L.set(d.buffer);d.fill(C[2],B[0],B[2],M);z.set(d.buffer);aa(m,n,L,z).then(f=>{n=f});E.drawImage(d.canvas,0,0)}},{once:!0})})()
