'use strict';(function(){function da(a){a-=179;return!Number.isInteger(a)||0>a||a>=za.length?0:za[a]}function Z(a){return Qa[a]||0}function Aa(a,c,f,e,k,d,n){let [p,M]=a<f?[a,f]:[f,a],[J,l]=c<e?[c,e]:[e,c];a=n?32:0;n=n?16:0;if(J===l)if(p===M)d(p,J,Z(15));else{d(p,J,Z(da(k(p,J))&-33|8|a));for(n=p+1;n<M;n++)d(n,J,Z(da(k(n,J))&-33|12|a));d(M,J,Z(da(k(M,J))&-33|4|a))}else if(p===M){d(p,J,Z(da(k(p,J))&-17|2|n));for(a=J+1;a<l;a++)d(p,a,Z(da(k(p,a))&-17|3|n));d(p,l,Z(da(k(p,l))&-17|1|n))}else{d(p,J,Z(da(k(p,
J))&-49|10|a|n));for(c=p+1;c<M;c++)d(c,J,Z(da(k(c,J))&-33|12|a));d(M,J,Z(da(k(M,J))&-49|6|a|n));for(c=J+1;c<l;c++)d(p,c,Z(da(k(p,c))&-17|3|n)),d(M,c,Z(da(k(M,c))&-17|3|n));d(p,l,Z(da(k(p,l))&-49|9|a|n));for(c=p+1;c<M;c++)d(c,l,Z(da(k(c,l))&-33|12|a));d(M,l,Z(da(k(M,l))&-49|5|n|a))}}function la(){return Ba=Ba||new Promise((a,c)=>{let f=indexedDB.open("dosdraw",1);f.onerror=()=>{c(f.error||"unable to open db")};f.onblocked=()=>{c("blocked")};f.onupgradeneeded=({oldVersion:e})=>{1>e&&(e=f.result,e.createObjectStore("sessions",
{autoIncrement:!0,keyPath:"id"}),e=e.createObjectStore("updates",{autoIncrement:!0,keyPath:"id"}),e.createIndex("bySessionId","sessionId",{unique:!1,multiEntry:!1}),e.createIndex("byParentUpdateId","parentUpdateId",{unique:!1,multiEntry:!1}))};f.onsuccess=()=>{a(f.result)}})}function Ra(a){return la().then(c=>new Promise((f,e)=>{let k=c.transaction(["sessions","updates"],"readwrite"),d=k.objectStore("sessions"),n=k.objectStore("updates"),p={sessionId:-1,headUpdateId:-1};k.oncomplete=()=>{f(p)};k.onerror=
()=>{e(k.error||"db failure")};let M=d.add({saved:!0,headUpdateId:-1});M.onsuccess=()=>{let J=M.result;p.sessionId=J;let l=n.add({sessionId:J,parentUpdateId:-1,data:a,x:0,y:0,width:80,height:25});l.onsuccess=()=>{let r=l.result;p.headUpdateId=r;d.put({id:J,saved:!0,headUpdateId:r})}}}))}function Sa(a,c){return la().then(f=>new Promise((e,k)=>{let d=f.transaction(["sessions"],"readwrite");d.oncomplete=()=>{e()};d.onerror=()=>{k(d.error||"db failure")};let n=d.objectStore("sessions"),p=n.get(a);p.onsuccess=
()=>{let M=p.result;M&&!M.saved&&(M.saved=!0,M.headUpdateId=c,n.put(M))}}))}function Ta(a){let c=Infinity;var f=-Infinity;let e=Infinity;var k=-Infinity;for(var d=0;80>d;d++)for(var n=0;25>n;n++)a[80*n+d]&&(c=Math.min(c,d),f=Math.max(f,d),e=Math.min(e,n),k=Math.max(k,n));if(Infinity===c)return{width:0,height:0,x:0,y:0,data:new Uint16Array(0)};f=f+1-c;k=k+1-e;d=new Uint16Array(f*k);for(n=0;n<k;n++)d.set(a.subarray(80*(e+n)+c,80*(e+n)+c+f),n*f);return{width:f,height:k,x:c,y:e,data:d}}function X(a,c,
f,e){let k=new Uint16Array(2E3);for(let l=0;l<k.length;l++)k[l]=f[l]^e[l];let {x:d,y:n,width:p,height:M,data:J}=Ta(k);return la().then(l=>new Promise((r,V)=>{let F=l.transaction(["sessions","updates"],"readwrite"),t=F.objectStore("sessions"),O=F.objectStore("updates"),A=t.get(a),P=-1;F.oncomplete=()=>{r(P)};F.onerror=()=>{V(F.error||"db failure")};A.onsuccess=()=>{let B=A.result;if(B){let ea=O.add({sessionId:B.id,x:d,y:n,width:p,height:M,data:J,parentUpdateId:c});ea.onsuccess=()=>{P=ea.result;B.saved=
!1;B.headUpdateId=P;t.put(B)}}else V("session not found: "+a)}}))}function Ua(a,c,f){return la().then(e=>new Promise((k,d)=>{let n=e.transaction(["updates","sessions"],"readwrite"),p=n.objectStore("sessions"),M=n.objectStore("updates").get(c),J=-1;n.oncomplete=()=>{k({data:f,newUpdateId:J})};n.onerror=()=>{d(n.error||"db failure")};M.onsuccess=()=>{let l=M.result;if(!l)throw Error("update not found: "+c);if(l.sessionId!==a)throw Error("wrong session id");if(-1===l.parentUpdateId)J=c;else{J=l.parentUpdateId;
var r=p.get(a);Ca(f,l);r.onsuccess=()=>{let V=M.result;if(!V)throw Error("session not found: "+a);V.saved=!1;V.headUpdateId=l.parentUpdateId;p.put(V)}}}}))}function Va(a,c,f){return la().then(e=>new Promise((k,d)=>{let n=e.transaction(["updates","sessions"],"readwrite"),p=n.objectStore("sessions"),M=n.objectStore("updates").index("byParentUpdateId"),J=-1;n.oncomplete=()=>{k({data:f,newUpdateId:J})};n.onerror=()=>{d(n.error||"db failure")};let l=M.openCursor(c,"prev");l.onsuccess=()=>{var r=l.result;
if(r){r=r.value;if(r.sessionId!==a)throw Error("wrong session id");Ca(f,r);J=r.id;p.put({id:a,headUpdateId:r.id,saved:!1})}else J=c}}))}function*ma(a,c,f,e){let k=Math.abs(f-a),d=Math.abs(e-c),n=a<f?1:-1,p=c<e?1:-1,M=k-d;for(;;){yield[a,c];if(a===f&&c===e)break;let J=2*M;J>-d&&(M-=d,a+=n);J<k&&(M+=k,c+=p)}}function Da(a,c,f){a/=255;c/=255;f/=255;let e=Math.max(a,c,f),k=Math.min(a,c,f),d=e-k,n=0;e!==k&&(n=(e===a?(c-f)/d+(c<f?6:0):e===c?(f-a)/d+2:(a-c)/d+4)/6);return[Math.round(360*n),Math.round(100*
(0===e?0:d/e)),Math.round(100*e)]}function Ea(a,c,f){return 70>c?25>f?0:65>f?8:90>f?7:15:10>f?0:30>a||330<=a?70>f?4:12:90>a?70>f?6:14:150>a?70>f?2:10:210>a?70>f?3:11:270>a?70>f?1:9:70>f?5:13}function*Fa(a,c,f,e){let k=Math.sign(f-a),d=Math.sign(e-c);if(0===k)if(0===d)yield[a,c];else for(f=c;f!==e+d;f+=d)yield[a,f];else if(0===d)for(;a!==f+k;a+=k)yield[a,c];else for(;c!==e+d;c+=d)for(let n=a;n!==f+k;n+=k)yield[n,c]}function*Wa(a,c,f,e){let k=Math.sign(f-a),d=Math.sign(e-c);if(0===k)if(0===d)yield[a,
c];else for(f=c;f!==e+d;f+=d)yield[a,f];else if(0===d)for(e=a;e!==f+k;e+=k)yield[e,c];else{for(let n=a;n!==f+k;n+=k)yield[n,c];for(c+=d;c!==e;c+=d)yield[a,c],yield[f,c];for(;a!==f+k;a+=k)yield[a,e]}}function Xa(a){return new Promise((c,f)=>{let e=document.createElement("input");e.type="file";a&&(e.accept=a.join(","));e.onchange=k=>{var d;(null===(d=e.files)||void 0===d?0:d.length)?c(e.files[0]):c(null)};e.click()})}function Y(a,c){let f=0;for(;a&c;){var e=Math.clz32(c);e=32-Math.clz32(~c<<e>>>e);
e=c>>>e<<e;e&a&&(f|=e,a&=~e);c&=~e}return f}function Ya(a,c,f,e,k,d,n){if(!(0>a||0>c||80<=a||25<=c)){var p=Math.floor(a%1*8),M=Math.floor(c%1*8);a=Math.floor(a);c=Math.floor(c);var {charCode:J,bgColor:l,fgColor:r}=f(a,c);if(l===r||32===J||255===J)J=0;var V=!!(k[J][M]&128>>>p),F=V?r:l,t=[],O=V?0:255,A=V?0:65535,P=Y(128>>>p,k[J][M]^O),B=Y(32768>>>M,d[J][p]^A);a:if(0!==c){var ea=P;for(let H=M-1;0<=H;H--)if(ea=Y(ea,k[J][H]^O),0===ea)break a;t.push({x:a,y:c-1,side:"bottom",mask:ea})}a:if(24!==c){for(M+=
1;8>M;M++)if(P=Y(P,k[J][M]^O),0===P)break a;t.push({x:a,y:c+1,side:"top",mask:P})}a:if(0!==a){O=B;for(M=p-1;0<=M;M--)if(O=Y(O,d[J][M]^A),0===O)break a;t.push({x:a-1,y:c,side:"right",mask:O})}a:if(79!==a){for(p+=1;8>p;p++)if(B=Y(B,d[J][p]^A),0===B)break a;t.push({x:a+1,y:c,side:"left",mask:B})}V?e(a,c,J,n,l):e(a,c,J,r,n);for(a=new Set([`${a},${c}`]);0<t.length;){let {x:H,y:G,side:S,mask:E}=t.pop(),{charCode:R,bgColor:W,fgColor:U}=f(H,G);if(W!==F&&U!==F||177===R||176===R&&W!==F||178===R&&U!==F)a.add(`${H},${G}`);
else{if(U===W||32===R||255===R)R=0;c=W===F?255:0;V=W===F?65535:0;switch(S){case "top":for(A=B=p=0;16>A;A++){E=Y(E,k[R][A]^c);if(0===E)break;E&128&&(p|=Y(1<<A,d[R][0]^V));E&1&&(B|=Y(1<<A,d[R][7]^V))}0<A&&(E&&24!==G&&!a.has(`${H},${G+1}`)&&t.push({x:H,y:G+1,side:"top",mask:E}),p&&0!==H&&!a.has(`${H-1},${G}`)&&t.push({x:H-1,y:G,side:"right",mask:p}),B&&79!==H&&!a.has(`${H+1},${G}`)&&t.push({x:H+1,y:G,side:"left",mask:B}),W===F?e(H,G,R,U,n):e(H,G,R,n,W),a.add(`${H},${G}`));break;case "bottom":B=p=0;for(A=
15;0<=A;A--){E=Y(E,k[R][A]^c);if(0===E)break;E&128&&(p|=Y(1<<A,d[R][0]^V));E&1&&(B|=Y(1<<A,d[R][7]^V))}15>A&&(E&&0!==G&&!a.has(`${H},${G-1}`)&&t.push({x:H,y:G-1,side:"bottom",mask:E}),p&&0!==H&&!a.has(`${H-1},${G}`)&&t.push({x:H-1,y:G,side:"right",mask:p}),B&&79!==H&&!a.has(`${H+1},${G}`)&&t.push({x:H+1,y:G,side:"left",mask:B}),W===F?e(H,G,R,U,n):e(H,G,R,n,W),a.add(`${H},${G}`));break;case "left":for(A=B=p=0;8>A;A++){E=Y(E,d[R][A]^V);if(0===E)break;E&32768&&(B|=Y(128>>A,k[R][15]^c));E&1&&(p|=Y(128>>
A,k[R][0]^c))}0<A&&(E&&79!==H&&!a.has(`${H+1},${G}`)&&t.push({x:H+1,y:G,side:"left",mask:E}),p&&0!==G&&!a.has(`${H},${G-1}`)&&t.push({x:H,y:G-1,side:"bottom",mask:p}),B&&24!==G&&!a.has(`${H},${G+1}`)&&t.push({x:H,y:G+1,side:"top",mask:B}),W===F?e(H,G,R,U,n):e(H,G,R,n,W),a.add(`${H},${G}`));break;case "right":B=p=0;for(A=7;0<=A;A--){E=Y(E,d[R][A]^V);if(0===E)break;E&32768&&(B|=Y(128>>A,k[R][15]^c));E&1&&(p|=Y(128>>A,k[R][0]^c))}7>A&&(E&&0!==H&&!a.has(`${H-1},${G}`)&&t.push({x:H-1,y:G,side:"right",
mask:E}),p&&0!==G&&!a.has(`${H},${G-1}`)&&t.push({x:H,y:G-1,side:"bottom",mask:p}),B&&24!==G&&!a.has(`${H},${G+1}`)&&t.push({x:H,y:G+1,side:"top",mask:B}),W===F?e(H,G,R,U,n):e(H,G,R,n,W),a.add(`${H},${G}`))}}}}}let Ga=1===(new Uint8Array((new Uint16Array([1])).buffer))[0];var aa;(function(a){a[a.Tile=255]="Tile";a[a.ForegroundColor=3840]="ForegroundColor";a[a.BackgroundColor=61440]="BackgroundColor";a[a.All=65535]="All"})(aa||(aa={}));var qa;(function(a){a[a.Black=0]="Black";a[a.DarkBlue=1]="DarkBlue";
a[a.DarkGreen=2]="DarkGreen";a[a.DarkCyan=3]="DarkCyan";a[a.DarkRed=4]="DarkRed";a[a.DarkMagenta=5]="DarkMagenta";a[a.Brown=6]="Brown";a[a.LightGrey=7]="LightGrey";a[a.DarkGrey=8]="DarkGrey";a[a.Blue=9]="Blue";a[a.Green=10]="Green";a[a.Cyan=11]="Cyan";a[a.Red=12]="Red";a[a.Magenta=13]="Magenta";a[a.Yellow=14]="Yellow";a[a.White=15]="White"})(qa||(qa={}));let Ha="#000 #008 #080 #088 #800 #808 #880 #ccc #888 #00f #0f0 #0ff #f00 #f0f #ff0 #fff".split(" ");class Ia{constructor(a){this.drawChar=a;this.buffer=
new Uint16Array(2E3);this.buffer.fill(1792);this.canvas=document.createElement("canvas");this.canvas.width=640;this.canvas.height=400;this.ctx=this.canvas.getContext("2d");if(!this.ctx)throw Error("unable to get canvas context");}getBrush(a,c,f,e){if(!Number.isInteger(a)||!Number.isInteger(c))throw new TypeError("x and y must be integers");if(!Number.isInteger(f)||!Number.isInteger(c))throw new TypeError("width and height must be integers");if(0>a||0>c||0>f||0>e||80<a+f||25<c+e)throw new RangeError("edges exceed screen");
let k=new Uint16Array(f*e);for(let d=0;d<e;d++)k.set(this.buffer.subarray(80*(c+d)+a,80*(c+d)+a+f),d*f);return{data:k,width:f,height:e}}putBrush(a,c,f){let e,k,d=a.data;if(0>c){e=-c;if(e>=a.width)return;c=0}else e=0;k=Math.min(80-c,c+a.width);if(0>f){d=d.subarray(f*a.width);if(0===d.length)return;f=0}for(let n=0;n<a.height;n++)if(!(0>f+n)){if(25<=f+n)break;this.buffer.set(d.subarray((f+n)*a.width+e,(f+n)*a.width+k),80*f+c);for(let p=e;p<k;p++)this.updateCanvas(f+n,c+p)}}getRawChar(a,c){return this.buffer[80*
c+a]||0}setRawChar(a,c,f){0>a||0>c||80<=a||25<=c||(this.buffer[80*c+a]=f)}updateCanvas(a,c){if(!(0>a||0>c||80<=a||25<=c)){var f=this.getRawChar(a,c);this.drawChar(this.ctx,a,c,f&255,f>>8&15,f>>12&15)}}getCharInfo(a,c){a=this.getRawChar(a,c);return{charCode:a&255,fgColor:a>>8&15,bgColor:a>>12&15}}getChar(a,c){return this.getRawChar(a,c)&255}putChar(a,c,f,e,k){this.setRawChar(a,c,f|e<<8|k<<12);this.updateCanvas(a,c)}setChar(a,c,f,e,k,d=aa.All){this.setRawChar(a,c,this.buffer[80*c+a]&~d|(f|e<<8|k<<12)&
d);this.updateCanvas(a,c)}fill(a,c,f,e=aa.All){a=(a|c<<8|f<<12)&e;for(c=0;25>c;c++)for(f=0;80>f;f++)this.setRawChar(f,c,this.getRawChar(f,c)&~e|a),this.updateCanvas(f,c)}putVHalf(a,c,f){var e=this.getRawChar(a,c>>1);let k=e>>>8&15,d=e>>>12&15,n=c&1;switch(e&255){case 219:case 8:case 10:e=k;break;default:e=d;break;case 220:e=1===n?d:k;break;case 223:e=1===n?k:d}e===f?this.putChar(a,c>>1,219,f,d):0===n?this.putChar(a,c>>1,223,f,e):this.putChar(a,c>>1,220,f,e)}putHHalf(a,c,f){var e=this.getRawChar(a>>
1,c);let k=e>>>8&15,d=e>>>12&15,n=a&1;switch(e&255){case 219:case 8:case 10:e=k;break;default:e=d;break;case 222:e=1===n?d:k;break;case 221:e=1===n?k:d}e===f?this.putChar(a>>1,c,219,f,d):0===n?this.putChar(a>>1,c,221,f,e):this.putChar(a>>1,c,222,f,e)}saveBlob(){if(Ga)return new Blob([this.buffer]);let a=new Uint16Array(this.buffer);for(let c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;return new Blob([a],{type:"application/octet-stream"})}async loadBlob(a){a=await a.arrayBuffer();if(a.byteLength!==this.buffer.byteLength)throw Error("invalid file");
a=new Uint16Array(a);if(!Ga)for(var c=0;c<a.length;c++)a[c]=a[c]>>8|a[c]<<8;this.buffer.set(a);for(a=0;25>a;a++)for(c=0;80>c;c++)this.updateCanvas(c,a)}}class Za extends Ia{constructor(a){super(a.drawChar);this.baseScreen=a;this.mask=new Uint8Array(this.buffer.length)}reset(){this.mask.fill(0);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateCanvas(a,c){if(!(0>a||0>c||80<=a||25<=c))if(this.mask[80*c+a]){let f=this.buffer[80*c+a];this.drawChar(this.ctx,a,c,f&255,f>>8&15,f>>12&15)}else this.ctx.clearRect(8*
a,16*c,8,16)}getRawChar(a,c){return(this.mask[80*c+a]?this.buffer:this.baseScreen.buffer)[80*c+a]||0}setRawChar(a,c,f){0>a||0>c||80<=a||25<=c||(this.buffer[80*c+a]=f,this.mask[80*c+a]=255)}clearChar(a,c){0>a||0>c||80<=a||25<=c||(this.mask[80*c+a]=0,this.updateCanvas(a,c))}commit(){for(let a=0;a<this.buffer.length;a++)this.mask[a]&&(this.baseScreen.buffer[a]=this.buffer[a],this.baseScreen.updateCanvas(a%80,Math.floor(a/80)));this.reset()}shiftChars(a,c,f,e){let k=80*c+a,d=k+f;0>e?(this.buffer.copyWithin(k,
k-e,d),this.mask.copyWithin(k,k-e,d),this.mask.fill(0,d+e,d)):(this.buffer.copyWithin(k+e,k,d-e),this.mask.copyWithin(k+e,k,d-e),this.mask.fill(0,k,k+e));for(e=0;e<f;e++)this.updateCanvas(a+e,c)}isModified(a,c){return!!this.mask[80*c+a]}}let Qa=new Uint8Array([0,193,194,179,180,217,191,180,195,192,218,195,196,193,194,197,0,208,210,186,180,189,183,182,195,211,214,199,196,208,210,215,0,180,203,179,181,190,184,181,198,212,213,198,205,207,209,216,0,208,210,186,181,188,187,185,198,200,201,204,205,202,
203,206]),za=new Uint8Array([3,7,39,23,22,38,55,19,54,53,21,37,6,9,13,14,11,12,15,43,27,57,58,61,62,59,44,63,45,29,46,30,25,41,42,26,31,47,5,10]),Ca=(a,{x:c,y:f,width:e,height:k,data:d})=>{for(let n=0;n<k;n++)for(let p=0;p<e;p++)a[80*(f+n)+c+p]^=d[n*e+p]},Ba,$a=-1===(navigator.platform||"").toUpperCase().indexOf("MAC")?a=>a.ctrlKey:a=>a.metaKey,ab=fetch("./chardata.png"),bb=a=>{var c=document.createElement("canvas");c.width=a.width;c.height=a.height;c=c.getContext("2d",{willReadFrequently:!0});if(!c)throw Error("unable to create 2D canvas");
c.drawImage(a,0,0);var f=a.width/9;a=new Uint8Array(4096);for(let e=0;256>e;e++){const {data:k}=c.getImageData(e%f*9,16*Math.floor(e/f),8,16);for(let d=0;16>d;d++)a[16*e+d]=k[32*d+3]?128:0,a[16*e+d]|=k[4*(8*d+1)+3]?64:0,a[16*e+d]|=k[4*(8*d+2)+3]?32:0,a[16*e+d]|=k[4*(8*d+3)+3]?16:0,a[16*e+d]|=k[4*(8*d+4)+3]?8:0,a[16*e+d]|=k[4*(8*d+5)+3]?4:0,a[16*e+d]|=k[4*(8*d+5)+3]?2:0,a[16*e+d]|=k[4*(8*d+7)+3]?1:0}c=Array(256);for(f=0;256>f;f++)c[f]=a.subarray(16*f,16*(f+1));return c},cb=a=>{const c=new Uint16Array(2048);
for(var f=0;256>f;f++)for(let e=0;8>e;e++)for(let k=0;16>k;k++)c[8*f+e]|=(a[f][k]>>>7-e&1)<<k;a=Array(256);for(f=0;256>f;f++)a[f]=c.subarray(8*f,8*(f+1));return a},Ja={normal:a=>a.trim().replace(/\s+/g," "),nowrap:a=>a.trim().replace(/\s+/g," "),pre:a=>a,"pre-wrap":a=>a,"pre-line":a=>a.replace(/[ \t]*(\r?\n|\r)[ \t]*/g,"\n").trim().replace(/[ \t]+/g," "),"break-spaces":a=>a};qa=[0,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,
8595,8594,8592,8735,8596,9650,9660,...Array.from({length:95},(a,c)=>32+c),8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,
9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160];let ra=new Map(qa.map((a,c)=>[String.fromCodePoint(a),c])),ha=a=>a?a.replace(/;$/,"").split(/;/g).map(Number):[];window.addEventListener("DOMContentLoaded",async function(){var a=await (await ab).blob();let c=await createImageBitmap(a),f=c.width/9;a=(b,g,v,z,x,y)=>{b.save();b.globalCompositeOperation="source-over";b.fillStyle=Ha[y];b.fillRect(8*g,16*
v,8,16);b.globalCompositeOperation="destination-out";b.drawImage(c,z%f*9,16*Math.floor(z/f),8,16,8*g,16*v,8,16);b.globalCompositeOperation="destination-over";b.fillStyle=Ha[x];b.fillRect(8*g,16*v,8,16);b.restore()};let e=bb(c),k=cb(e),d=new Ia(a),{sessionId:n,headUpdateId:p}=await Ra(d.buffer),M=async()=>{var b=new Uint16Array(d.buffer);const {data:g,newUpdateId:v}=await Ua(n,p,b);d.buffer.set(g);for(b=0;25>b;b++)for(let z=0;80>z;z++)d.updateCanvas(z,b);F.globalCompositeOperation="copy";F.drawImage(d.canvas,
0,0);p=v},J=async()=>{var b=new Uint16Array(d.buffer);const {data:g,newUpdateId:v}=await Va(n,p,b);d.buffer.set(g);for(b=0;25>b;b++)for(let z=0;80>z;z++)d.updateCanvas(z,b);F.globalCompositeOperation="copy";F.drawImage(d.canvas,0,0);p=v};document.getElementById("undo").onclick=M;document.getElementById("redo").onclick=J;window.addEventListener("paste",async b=>{var g;b=Array.from((null===(g=b.clipboardData)||void 0===g?void 0:g.files)||[]);for(let v of b)if(await wa(v))break});document.addEventListener("keydown",
b=>{$a(b)&&("y"===b.key.toLowerCase()||"z"===b.key.toLowerCase()&&b.shiftKey?(J(),b.preventDefault()):"z"!==b.key.toLowerCase()||b.shiftKey||(M(),b.preventDefault()))});let l=new Za(d),r=document.getElementById("editor");var V=document.getElementById("editor-overlay");let F=r.getContext("2d"),t=V.getContext("2d"),O=new Uint16Array(2E3),A=new Uint16Array(2E3);if(!F||!t)throw Error("unable to create canvas context");let P=aa.All;document.getElementById("tile").onchange=b=>{P=b.target.checked?P|aa.Tile:
P&~aa.Tile};document.getElementById("fgcolor").onchange=b=>{P=b.target.checked?P|aa.ForegroundColor:P&~aa.ForegroundColor};document.getElementById("bgcolor").onchange=b=>{P=b.target.checked?P|aa.BackgroundColor:P&~aa.BackgroundColor};let B=[7,0,0],ea=document.querySelector(".palette"),H=(b,g)=>{const v=g?"background-selected":"foreground-selected";var z=ea.querySelectorAll(`.${v}`);for(let x=0;x<z.length;x++)z[x].classList.remove(v);(z=ea.querySelector(`.color-cell[data-value='${b}']`))&&z.classList.add(v);
B[g?2:0]=b};ea.onpointerdown=b=>{if("mouse"===b.pointerType&&(0===b.button||2===b.button)){var g=0===b.button?"foreground-selected":"background-selected";for(let v=b.target;v&&!v.classList.contains("palette");v=v.parentElement)if("value"in v.dataset){let z=ea.querySelectorAll(`.${g}`);for(let x=0;x<z.length;x++)z[x].classList.remove(g);v.classList.add(g);B[b.button]=+v.dataset.value;b.preventDefault();b.stopPropagation();break}}};ea.oncontextmenu=b=>{b.preventDefault()};let G=[219,0,0],S=0,E=0,R=
0,W=document.querySelector(".cursor"),U=(b,g)=>{W.style.left=`${8*b}px`;W.style.top=`${16*g}px`;W.style.animation="none";W.getBoundingClientRect();W.style.removeProperty("animation");S=b;E=g},ia=document.querySelector("#editor-block"),na="freehand",Na={freehand:()=>{na="freehand";r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:h}=b;if(0===y||2===y){async function w(u){u.pointerId===h&&u.button===y&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(m=>{p=m}),t.globalCompositeOperation=
"copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",q),r.removeEventListener("pointerup",w))}function q(u){if(u.pointerId===h){var m=Math.floor(80*(u.clientX-g.x)/g.width);u=Math.floor(25*(u.clientY-g.y)/g.height);for(const [C,D]of ma(z,x,m,u))l.setChar(C,D,G[y],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);z=m;x=u}}b.preventDefault();r.setPointerCapture(h);var g=r.getBoundingClientRect(),v=Math.floor(80*
(b.clientX-g.x)/g.width);b=Math.floor(25*(b.clientY-g.y)/g.height);l.setChar(v,b,G[y],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);var z=v,x=b;r.addEventListener("pointermove",q);r.addEventListener("pointerup",w)}}}},vbFreehand:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:h}=b;if(0===y||2===y){function w(u){u.pointerId===h&&u.button===y&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(m=>{p=m}),t.globalCompositeOperation="copy",
t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",q),r.removeEventListener("pointerup",w))}function q(u){if(u.pointerId===h){var m=Math.floor(80*(u.clientX-g.x)/g.width);u=Math.floor(50*(u.clientY-g.y)/g.height);for(const [C,D]of ma(z,x,m,u))l.putVHalf(C,D,B[y]);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);z=m;x=u}}b.preventDefault();r.setPointerCapture(h);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-
g.x)/g.width);b=Math.floor(50*(b.clientY-g.y)/g.height);l.putVHalf(v,b,B[y]);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);var z=v,x=b;r.addEventListener("pointermove",q);r.addEventListener("pointerup",w)}}}},hbFreehand:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:h}=b;if(0===y||2===y){function w(u){u.pointerId===h&&u.button===y&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(m=>{p=m}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,
0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",q),r.removeEventListener("pointerup",w))}function q(u){if(u.pointerId===h){var m=Math.floor(160*(u.clientX-g.x)/g.width);u=Math.floor(25*(u.clientY-g.y)/g.height);for(const [C,D]of ma(z,x,m,u))l.putHHalf(C,D,B[y]);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);z=m;x=u}}b.preventDefault();r.setPointerCapture(h);var g=r.getBoundingClientRect(),v=Math.floor(160*(b.clientX-g.x)/g.width);b=
Math.floor(25*(b.clientY-g.y)/g.height);l.putHHalf(v,b,B[y]);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);var z=v,x=b;r.addEventListener("pointermove",q);r.addEventListener("pointerup",w)}}}},lines:()=>{na="lines";r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:x,pointerId:y}=b;if(0===x||2===x){function h(q){q.pointerId===y&&q.button===x&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(u=>{p=u}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation=
"copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",w),r.removeEventListener("pointerup",h))}function w(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-g.x)/g.width);q=Math.floor(25*(q.clientY-g.y)/g.height);l.reset();for(const [m,C]of ma(v,z,u,q))l.setChar(m,C,G[x],B[0],B[2],P);t.drawImage(l.canvas,0,0)}}b.preventDefault();r.setPointerCapture(y);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-g.x)/g.width),z=Math.floor(25*(b.clientY-g.y)/g.height);l.setChar(v,z,
G[x],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);r.addEventListener("pointermove",w);r.addEventListener("pointerup",h)}}}},filledBox:()=>{na="filledBox";r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:x,pointerId:y}=b;if(0===x||2===x){function h(q){q.pointerId===y&&q.button===x&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(u=>{p=u}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,
0,0),r.removeEventListener("pointermove",w),r.removeEventListener("pointerup",h))}function w(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-g.x)/g.width);q=Math.floor(25*(q.clientY-g.y)/g.height);l.reset();for(const [m,C]of Fa(v,z,u,q))l.setChar(m,C,G[x],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0)}}b.preventDefault();r.setPointerCapture(y);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-g.x)/g.width),z=Math.floor(25*(b.clientY-g.y)/g.height);l.setChar(v,
z,G[x],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);r.addEventListener("pointermove",w);r.addEventListener("pointerup",h)}}}},emptyBox:()=>{na="emptyBox";r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:x,pointerId:y}=b;if(0===x||2===x){function h(q){q.pointerId===y&&q.button===x&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(u=>{p=u}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,
0,0),r.removeEventListener("pointermove",w),r.removeEventListener("pointerup",h))}function w(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-g.x)/g.width);q=Math.floor(25*(q.clientY-g.y)/g.height);l.reset();for(const [m,C]of Wa(v,z,u,q))l.setChar(m,C,G[x],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0)}}b.preventDefault();r.setPointerCapture(y);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-g.x)/g.width),z=Math.floor(25*(b.clientY-g.y)/g.height);l.setChar(v,
z,G[x],B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);r.addEventListener("pointermove",w);r.addEventListener("pointerup",h)}}}},singleBorder:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:x,pointerId:y}=b;if(0===x||2===x){function h(q){q.pointerId===y&&q.button===x&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(u=>{p=u}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),
r.removeEventListener("pointermove",w),r.removeEventListener("pointerup",h))}function w(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-g.x)/g.width);q=Math.floor(25*(q.clientY-g.y)/g.height);l.reset();Aa(v,z,u,q,(m,C)=>d.getChar(m,C),(m,C,D)=>l.setChar(m,C,D,B[0],B[2],P),!1);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0)}}b.preventDefault();r.setPointerCapture(y);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-g.x)/g.width),z=Math.floor(25*(b.clientY-g.y)/g.height);
l.setChar(v,z,Z(15),B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);r.addEventListener("pointermove",w);r.addEventListener("pointerup",h)}}}},doubleBorder:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:x,pointerId:y}=b;if(0===x||2===x){function h(q){q.pointerId===y&&q.button===x&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(u=>{p=u}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,
0,0),r.removeEventListener("pointermove",w),r.removeEventListener("pointerup",h))}function w(q){if(q.pointerId===y){var u=Math.floor(80*(q.clientX-g.x)/g.width);q=Math.floor(25*(q.clientY-g.y)/g.height);l.reset();Aa(v,z,u,q,(m,C)=>d.getChar(m,C),(m,C,D)=>l.setChar(m,C,D,B[0],B[2],P),!0);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0)}}b.preventDefault();r.setPointerCapture(y);var g=r.getBoundingClientRect(),v=Math.floor(80*(b.clientX-g.x)/g.width),z=Math.floor(25*(b.clientY-g.y)/g.height);
l.setChar(v,z,Z(15),B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);r.addEventListener("pointermove",w);r.addEventListener("pointerup",h)}}}},colorFloodFill:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:z}=b;if(0===z||2===z){b.preventDefault();var g=r.getBoundingClientRect(),v=80*(b.clientX-g.x)/g.width;b=25*(b.clientY-g.y)/g.height;O.set(d.buffer);Ya(v,b,(x,y)=>d.getCharInfo(x,y),(x,y,h,w,q)=>d.putChar(x,y,h,w,q),e,k,B[z]);A.set(d.buffer);X(n,p,O,A).then(x=>
{p=x});F.globalCompositeOperation="copy";F.drawImage(d.canvas,0,0)}}}},pick:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:y,pointerId:h}=b;if(0===y||2===y){function w(u){u.pointerId===h&&u.button===y&&(r.removeEventListener("pointermove",q),r.removeEventListener("pointerup",w),ja.value=na,ja.dispatchEvent(new Event("change")))}function q(u){if(u.pointerId===h){var m=r.getBoundingClientRect(),{charCode:C,fgColor:D,bgColor:Q}=d.getCharInfo(Math.floor(80*(u.clientX-m.x)/m.width),
Math.floor(25*(u.clientY-m.y)/m.height));P&aa.Tile&&xa(C,2===y);P&aa.ForegroundColor&&H(D,!1);P&aa.BackgroundColor&&H(Q,!0)}}b.preventDefault();r.setPointerCapture(h);var g=r.getBoundingClientRect(),{charCode:v,fgColor:z,bgColor:x}=d.getCharInfo(Math.floor(80*(b.clientX-g.x)/g.width),Math.floor(25*(b.clientY-g.y)/g.height));P&aa.Tile&&xa(v,2===y);P&aa.ForegroundColor&&H(z,!1);P&aa.BackgroundColor&&H(x,!0);r.addEventListener("pointermove",q);r.addEventListener("pointerup",w)}}}},text:()=>{function b(h){if("AltLeft"===
h.code||"AltRight"===h.code)h.preventDefault(),h.stopPropagation();else{switch(h.key){case "Tab":return;case "ArrowDown":if(h.altKey||h.ctrlKey||h.metaKey)return;U(S,Math.min(E+1,24));h.preventDefault();h.stopPropagation();return;case "ArrowUp":if(h.altKey||h.ctrlKey||h.metaKey)return;U(S,Math.max(E-1,0));h.preventDefault();h.stopPropagation();return;case "ArrowLeft":if(h.altKey||h.ctrlKey||h.metaKey)return;0===S?0!==E&&U(79,E-1):(S-1<R&&(R=S-1),U(S-1,E));h.preventDefault();h.stopPropagation();return;
case "ArrowRight":if(h.altKey||h.ctrlKey||h.metaKey)return;79===S?24!==E&&U(0,E+1):U(S+1,E);h.preventDefault();h.stopPropagation();return;case "Enter":if(h.altKey||h.ctrlKey||h.metaKey)return;U(R,Math.min(24,E+1));h.preventDefault();h.stopPropagation();return;case "End":case "PageDown":if(h.altKey||h.ctrlKey||h.metaKey)return;U(S,24);h.preventDefault();h.stopPropagation();return;case "Home":case "PageUp":if(h.altKey||h.ctrlKey||h.metaKey)return;U(S,0);h.preventDefault();h.stopPropagation();return;
case "Backspace":if(h.altKey||h.ctrlKey||h.metaKey)return;0===S?0!==E&&U(79,E-1):(S-1<R&&(R=S-1),U(S-1,E));l.shiftChars(S,E,80-S,-1);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);return;case "Delete":if(h.altKey||h.ctrlKey||h.metaKey)return;l.shiftChars(S,E,80-S,-1);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);return}if(h.altKey&&!h.ctrlKey&&3===h.location&&"0"<=h.key&&"9">=h.key)y.push(h.key),h.preventDefault(),h.stopPropagation();else if(!h.ctrlKey&&!h.altKey){const w=
ra.get(h.key);"number"===typeof w&&(x(w),h.preventDefault(),h.stopPropagation())}}}function g(h){if("Alt"===h.key||"AltLeft"===h.code||"AltRight"===h.code){if(0<y.length){const w=Number.parseInt(y.slice(-3).join(""))&255;y.length=0;x(w)}h.preventDefault();h.stopPropagation()}}function v(h){var w,q;const u=null===(w=h.clipboardData)||void 0===w?void 0:w.getData("text/html");if(u){console.log(u);h=(new DOMParser).parseFromString(u,"text/html");var m=document.createElement("canvas");m.width=m.height=
1;const C=m.getContext("2d");if(!C)throw Error("unable to get canvas context");C.globalCompositeOperation="copy";const D=I=>{C.fillStyle=I;C.fillRect(0,0,1,1);({data:I}=C.getImageData(0,0,1,1));return[I[0],I[1],I[2],I[3]]},Q=(I,N={},K=!1)=>{var L,T;if(!/^(?:script|style|noscript|template|head)$/i.test(I.nodeName)&&"none"!==I.style.display)if(/^br$/i.test(I.nodeName))U(R,Math.min(24,E+1));else{var fa=!!N.hidden||"hidden"===I.style.visibility||0>=parseFloat(I.style.opacity),ca=I.style.color.replace(/^(inherit|currentcolor|initial|revert|revert-layer|unset|transparent)$/i,
""),ba=I.style.backgroundColor.replace(/^(inherit|currentcolor|initial|revert|revert-layer|unset|transparent)$/i,""),db=B[0],eb=B[2];ca&&(ca=D(ca),0===ca[3]&&(fa=!0),ca=Da(ca[0],ca[1],ca[2]),B[0]=Ea(ca[0],ca[1],ca[2]));ba&&(ba=D(ba),ba=Da(ba[0],ba[1],ba[2]),B[2]=Ea(ba[0],ba[1],ba[2]));ba=I.style.whiteSpace.replace(/^(inherit|initial|revert|revert-layer|unset)$/i,"")||N.whitespaceMode||"";fa=!!N.hidden!==fa||ba!==(N.whitespaceMode||"")?{hidden:fa,whitespaceMode:ba}:N;ca=Ja[ba||N.whitespaceMode||"normal"]||
Ja.normal;N=[];ba=/^(?:a|abbr|acronym|b|bdo|big|button|cite|code|dfn|em|i|kbd|label|map|object|output|q|samp|small|span|strong|sub|textarea|time|tt|var|ins|del|mark|ruby|rt|rp|html|body)$/i.test(I.nodeName);var ka=!K&&!ba;K=S;var Ka=E;for(I=I.firstChild;I;I=I.nextSibling)switch(I.nodeType){case Node.ELEMENT_NODE:if(0<N.length){const oa=ca((ka?"":"X")+N.join("")+"X").slice(ka?0:1,-1);N.length=0;if(0<oa.length)for(const La of oa)"\n"===La?U(R,Math.min(24,E+1)):x(null!==(L=ra.get(La))&&void 0!==L?L:
63)}Q(I,fa,!ka)?(K=S,Ka=E,ka=!0):ka=!1;break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.ENTITY_NODE:N.push(I.nodeValue||"")}if(0<N.length){L=ca((ka?"":"X")+N.join("")).slice(ka?0:1);N.length=0;for(const oa of L)"\n"===oa?U(R,Math.min(24,E+1)):x(null!==(T=ra.get(oa))&&void 0!==T?T:63)}B[0]=db;B[2]=eb;if(K===S&&Ka===E||ba)return!1;U(R,Math.min(24,E+1));return!0}};Q(h.documentElement)}else if(w=null===(m=h.clipboardData)||void 0===m?void 0:m.getData("text")){h.preventDefault();for(const C of w.replace(/\r\n?|\n\r/g,
"\n"))"\n"===C?U(R,Math.min(24,E+1)):x(null!==(q=ra.get(C))&&void 0!==q?q:63)}}ia.focus();let z=!1;r.onpointerdown=h=>{if("mouse"===h.pointerType){var {button:w}=h;if(0===w){h.preventDefault();w=r.getBoundingClientRect();var q=Math.floor(80*(h.clientX-w.x)/w.width);U(q,Math.floor(25*(h.clientY-w.y)/w.height));R=q;ia.focus()}}};const x=h=>{z=!0;let w=S;for(;l.isModified(w,E);)if(80===++w){w--;break}w>S&&l.shiftChars(S,E,w+1-S,1);l.setChar(S,E,h,B[0],B[2],P);t.globalCompositeOperation="copy";t.drawImage(l.canvas,
0,0);79===S?24!==E&&U(0,E+1):U(S+1,E)};ia.onblur=function(){z&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(h=>{p=h}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),z=!1)};let y=[];ia.addEventListener("keydown",b);ia.addEventListener("keyup",g);document.addEventListener("paste",v);return()=>{ia.onblur=null;z&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(h=>{p=h}),t.globalCompositeOperation="copy",
t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0));ia.removeEventListener("keydown",b);ia.removeEventListener("keyup",g);document.removeEventListener("paste",v)}},gradientBox:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:h,pointerId:w}=b;if(0===h||2===h){function q(m){m.pointerId===w&&m.button===h&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(C=>{p=C}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation=
"copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",u),r.removeEventListener("pointerup",q))}function u(m){if(m.pointerId===w){var C=Math.floor(80*(m.clientX-v.x)/v.width);m=Math.floor(25*(m.clientY-v.y)/v.height);l.reset();var [D,Q]=z<C?[z,C]:[C,z],[I,N]=x<m?[x,m]:[m,x];for(const [K,L]of Fa(z,x,C,m)){if(0>K||0>L||80<=K||25<=L)continue;C=y(K,L,D,Q,I,N);const {charCode:T,fgColor:fa,bgColor:ca}=Ma(g,C);l.setChar(K,L,T,fa,ca)}t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,
0)}}var g=ya();if(0!==g.length){b.preventDefault();r.setPointerCapture(w);var v=r.getBoundingClientRect(),z=Math.floor(80*(b.clientX-v.x)/v.width),x=Math.floor(25*(b.clientY-v.y)/v.height);l.setChar(z,x,219,g[0],0);t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);b=document.getElementById("gradient-direction-selector");var y="up"===b.value?(m,C,D,Q,I,N)=>(C-N)/(I-N):"right"===b.value?(m,C,D,Q,I,N)=>(m-D)/(Q-D):"left"===b.value?(m,C,D,Q,I,N)=>(m-Q)/(D-Q):(m,C,D,Q,I,N)=>(C-I)/(N-I);r.addEventListener("pointermove",
u);r.addEventListener("pointerup",q)}}}}},rainbowBrush:()=>{r.onpointerdown=b=>{if("mouse"===b.pointerType){const {button:q,pointerId:u}=b;if(0===q){function m(D){D.pointerId===u&&D.button===q&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(Q=>{p=Q}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",C),r.removeEventListener("pointerup",m))}function C(D){if(D.pointerId===u){var Q=
Math.floor(80*(D.clientX-z.x)/z.width);D=Math.floor(25*(D.clientY-z.y)/z.height);if(Q!==h||D!==w){let I=!0;for(const [N,K]of ma(h,w,Q,D)){if(I){I=!1;continue}y=(y+.25)%v;const {charCode:L,fgColor:T,bgColor:fa}=Ma(g,y/v);l.setChar(N,K,L,T,fa)}}t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);h=Q;w=D}}b.preventDefault();var g=ya(),v=g.length;if(0!==v){g.push(g[0]);r.setPointerCapture(u);var z=r.getBoundingClientRect(),x=Math.floor(80*(b.clientX-z.x)/z.width);b=Math.floor(25*(b.clientY-z.y)/
z.height);l.setChar(x,b,219,g[0],g[0]);var y=0;t.globalCompositeOperation="copy";t.drawImage(l.canvas,0,0);var h=x,w=b;r.addEventListener("pointermove",C);r.addEventListener("pointerup",m)}}}}},spraypaint:()=>{r.onpointerdown=b=>{const {pointerId:g,pointerType:v,button:z}=b;if("mouse"===v&&0===z){const w=ya();if(0!==w.length){function q(m){m.pointerId===g&&m.button===z&&(O.set(d.buffer),l.commit(),A.set(d.buffer),X(n,p,O,A).then(C=>{p=C}),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0),
F.globalCompositeOperation="copy",F.drawImage(d.canvas,0,0),r.removeEventListener("pointermove",u),r.removeEventListener("pointerup",q))}function u(m){if(m.pointerId===g){var C=performance.now(),D=C-h;h=C;C=Math.floor(80*(m.clientX-y.x)/y.width);m=Math.floor(25*(m.clientY-y.y)/y.height);var {charCode:Q,fgColor:I,bgColor:N}=d.getCharInfo(C,m),K=80*m+C;if(-1===x[K])if(I===N){var L=w.indexOf(N);x[K]=-1===L?0:L}else switch(Q){case 0:case 32:case 255:L=w.indexOf(N);x[K]=-1===L?0:L;break;case 8:case 10:case 219:L=
w.indexOf(I);x[K]=-1===L?0:L;break;case 176:L=w.indexOf(N);var T=w.indexOf(I);x[K]=-1===L?-1===T?0:Math.max(0,T-.5):-1===T?Math.max(0,L-.5):L===T-1?L+.25:T===L-1?T+.75:Math.max(0,Math.min(T,L)+.25);break;case 177:L=w.indexOf(N);T=w.indexOf(I);x[K]=-1===L?-1===T?0:Math.max(0,T-.5):-1===T?Math.max(0,L-.5):L===T-1?L+.5:T===L-1?T+.5:Math.max(0,Math.min(T,L)+.5);break;case 178:L=w.indexOf(N);T=w.indexOf(I);x[K]=-1===L?-1===T?0:Math.max(0,T-.5):-1===T?Math.max(0,L-.5):L===T-1?L+.75:T===L-1?T+.25:Math.max(0,
Math.min(T,L)+.5);break;default:L=w.indexOf(N),-1===L&&(L=w.indexOf(I)),x[K]=L+.5}x[K]+=Math.min(.25,D/100);x[K]>=w.length-1?(K=219,L=w[w.length-1],D=0):(D=Math.floor(x[K]),K=x[K]-D,.125>K?(K=219,L=w[D],D=0):(K=.375>K?176:.625>K?177:.875>K?178:219,L=w[D+1],D=w[D]));if(K!==Q||L!==I||D!==N)l.putChar(C,m,K,L,D),t.globalCompositeOperation="copy",t.drawImage(l.canvas,0,0)}}var x=new Float32Array(2E3);x.fill(-1);var y=r.getBoundingClientRect(),h=performance.now();r.addEventListener("pointermove",u);r.addEventListener("pointerup",
q)}}}}},Oa=document.getElementById("add-gradient-slot"),fb=document.getElementById("gradient-slot-template").content.querySelector(".gradient-slot"),Pa=document.querySelector(".gradient-slots"),pa=b=>{const g=fb.cloneNode(!0);g.dataset.value=String(b);g.querySelector(".remove-gradient-slot").onclick=()=>{Pa.removeChild(g)};Pa.insertBefore(g,Oa)};Oa.onclick=()=>{pa(B[0])};pa(0);pa(8);pa(7);pa(15);let ya=()=>{const b=document.querySelectorAll(".gradient-slots .gradient-slot"),g=[];for(let v=0;v<b.length;v++)g.push(Number(b[v].dataset.value));
return g},Ma=(b,g)=>{if(2>b.length)return{charCode:219,fgColor:b[0]||0,bgColor:0};g=Math.max(0,Math.min(1,Number(g)||0));g*=b.length-1;const v=Math.floor(g);if(v>=b.length-1)return{charCode:219,fgColor:b[b.length-1],bgColor:0};g-=v;return.125>g?{charCode:0,fgColor:b[v+1],bgColor:b[v]}:.375>g?{charCode:176,fgColor:b[v+1],bgColor:b[v]}:.625>g?{charCode:177,fgColor:b[v+1],bgColor:b[v]}:.875>g?{charCode:178,fgColor:b[v+1],bgColor:b[v]}:{charCode:219,fgColor:b[v+1],bgColor:0}},sa;sa=Na.freehand();let ja=
document.getElementById("tool-selector"),ta=ja.value;document.body.classList.add("tool-"+ta);ja.onchange=b=>{sa&&sa();sa=Na[ja.value]();document.body.classList.remove("tool-"+ta);ta=ja.value;document.body.classList.add("tool-"+ta)};ja.dispatchEvent(new Event("change"));r.oncontextmenu=b=>{b.preventDefault()};let ua=document.getElementById("char-picker"),gb=document.querySelector(".left-pick"),hb=document.querySelector(".right-pick"),xa=(b,g)=>{const v=Math.floor(b/64),z=g?hb:gb;z.style.left=`${b%
64*8}px`;z.style.top=`${16*v}px`;G[g?2:0]=b};V=ua.getContext("2d");if(!V)throw Error("unable to create canvas context");for(let b=0;256>b;b++)a(V,b%64,Math.floor(b/64),b,7,0);ua.onpointerdown=b=>{if("mouse"===b.pointerType&&(0===b.button||2===b.button)){var g=ua.getBoundingClientRect();xa(64*Math.floor(4*(b.clientY-g.y)/g.height)+Math.floor(64*(b.clientX-g.x)/g.width),2===b.button)}};ua.oncontextmenu=b=>{b.preventDefault()};document.getElementById("save-image").onclick=b=>{b=d.saveBlob();b=URL.createObjectURL(b);
let g=document.createElement("a");g.download="dosimage.dat";g.href=b;g.click();Sa(n,p)};let wa=async b=>{var g,v,z,x;if((b.type||"").startsWith("image/")||/\.(?:jpe?g|jfif|pjpeg|pjp|a?png|gif|bmp|ico|cur|tiff?|svg|webp|avif)$/i.test(b.name||"")){let m;try{m=await createImageBitmap(b)}catch(D){return!1}if(0===m.width||0===m.height)return console.warn("empty image"),!1;if(640!==m.width||400!==m.height)m=await createImageBitmap(m,{resizeWidth:640,resizeHeight:400,resizeQuality:640<m.width||400<m.height?
"high":"pixelated"});var y=document.createElement("canvas");y.width=m.width;y.height=m.height;var h=y.getContext("2d");if(!h)throw Error("unable to create canvas context");h.globalCompositeOperation="copy";h.drawImage(m,0,0);const C=h.getImageData(0,0,y.width,y.height).data;return await new Promise((D,Q)=>{Q=new Worker("./convert-image-worker.js");Q.onmessage=({data:{type:I,data:N}})=>{if("image-done"===I){O.set(d.buffer);d.buffer.set(N);for(I=0;25>I;I++)for(N=0;80>N;N++)d.updateCanvas(N,I);A.set(d.buffer);
X(n,p,O,A).then(K=>{p=K});F.globalCompositeOperation="copy";F.drawImage(d.canvas,0,0);D(!0)}};Q.postMessage({type:"init",bitPatterns:e});Q.postMessage({type:"image",rgba:C,width:m.width,height:m.height},[C.buffer])})}if(/\.ans$/i.test(b.name||"")){var w=await b.arrayBuffer();b=7;let m=0,C=!1,D=!1,Q=0;var q=0;let I=0;w=new Uint8Array(w);const N=new Uint16Array(2E3);a:for(;Q<w.length;)if(27===w[Q]){for(var u=[];++Q<w.length;){const K=String.fromCharCode(w[Q]);u.push(K);if(1===u.length){if("["!==u[0]){Q++;
break}}else if(/[@A-Z\[\]\^_a-z\{\|\}~]/.test(K)){Q++;break}}u=u.join("");if("["===u[0])switch(u.slice(-1)){case "m":if(/^\[(?:\d+(?:;\d+)*)?m$/.test(u))for(const K of ha(u.slice(1,-1)))switch(K){case 30:b=0;break;case 34:b=1;break;case 32:b=2;break;case 36:b=3;break;case 31:b=4;break;case 35:b=5;break;case 33:b=6;break;case 37:b=7;break;case 90:b=8;break;case 94:b=9;break;case 92:b=10;break;case 96:b=11;break;case 91:b=12;break;case 95:b=13;break;case 93:b=14;break;case 97:b=15;break;case 40:m=0;
break;case 44:m=1;break;case 42:m=2;break;case 46:m=3;break;case 41:m=4;break;case 45:m=5;break;case 43:m=6;break;case 47:m=7;break;case 100:m=8;break;case 104:m=9;break;case 102:m=10;break;case 106:m=11;break;case 101:m=12;break;case 105:m=13;break;case 103:m=14;break;case 107:m=15;break;case 0:b=7;m=0;D=C=!1;break;case 1:D=!0;break;case 4:break;case 5:break;case 7:C=!0;break;case 22:D=!1;break;case 27:C=!1;break;case 39:b=7;break;case 49:m=0;break;default:console.log("["+K+"m")}break;case "A":q-=
80*(null!==(y=ha(u.slice(1,-1))[0])&&void 0!==y?y:1);break;case "B":q+=80*(null!==(h=ha(u.slice(1,-1))[0])&&void 0!==h?h:1);break;case "C":q+=null!==(g=ha(u.slice(1,-1))[0])&&void 0!==g?g:1;break;case "D":q-=null!==(v=ha(u.slice(1,-1))[0])&&void 0!==v?v:1;break;case "H":case "f":q=ha(u.slice(1,-1));q=80*((null!==(z=q[0])&&void 0!==z?z:1)-1)+((null!==(x=q[1])&&void 0!==x?x:1)-1);break;case "s":I=q;break;case "u":q=I;break;case "J":u=ha(u.slice(1,-1));if(0===u.length)2E3>q&&N.fill(b<<8|m<<12|(D?2048:
0),Math.max(0,q-q%80));else for(const K of u)switch(K){case 1:0<q&&N.fill(b<<8|m<<12|(D?2048:0),0,Math.min(2E3,q-q%80+80));break;case 2:N.fill(b<<8|m<<12|(D?2048:0));q=0;break;default:console.log("["+K+"J")}break;case "K":if(0>q||2E3<=q)break;u=ha(u.slice(1,-1));if(0===u.length)N.fill(b<<8|m<<12|(D?2048:0),q,q-q%80+80);else for(const K of u)switch(K){case 1:N.fill(b<<8|m<<12|(D?2048:0),q-q%80,q+1);break;case 2:N.fill(b<<8|m<<12|(D?2048:0),q-q%80,q-q%80+80);break;default:console.log("["+K+"J")}break;
default:console.log(u)}else console.log(u)}else switch(w[Q]){case 13:q-=q%80;Q++;break;case 10:q+=80;Q++;break;case 26:break a;default:0<=q&&2E3>q?N[q++]=w[Q++]|(C?m<<8|b<<12|(D?32768:0):b<<8|m<<12|(D?2048:0)):(q++,Q++)}O.set(d.buffer);d.buffer.set(N);for(y=0;25>y;y++)for(h=0;80>h;h++)d.updateCanvas(h,y);A.set(d.buffer);X(n,p,O,A).then(K=>{p=K});F.globalCompositeOperation="copy";F.drawImage(d.canvas,0,0);return!0}if("application/octet-stream"===(b.type||"application/octet-stream")&&4E3===b.size){y=
new Uint16Array(d.buffer);try{await d.loadBlob(b)}catch(m){return alert(m),!1}A.set(d.buffer);X(n,p,y,A).then(m=>{p=m});F.drawImage(d.canvas,0,0);return!0}return!1};document.getElementById("load-image").onclick=async b=>{(b=await Xa([".dat","image/*",".ans"]))&&wa(b)};document.getElementById("clear-image").onclick=b=>{O.set(d.buffer);d.fill(G[2],B[0],B[2],P);A.set(d.buffer);X(n,p,O,A).then(g=>{p=g});F.drawImage(d.canvas,0,0)};let va=0;document.body.addEventListener("dragenter",b=>{b.preventDefault();
va++;document.body.classList.add("dropping")});document.body.addEventListener("dragleave",b=>{b.preventDefault();va--;0===va&&document.body.classList.remove("dropping")});document.body.addEventListener("dragover",b=>{b.preventDefault()});document.body.addEventListener("drop",async b=>{var g;b.preventDefault();b.stopPropagation();va=0;document.body.classList.remove("dropping");for(let v of(null===(g=b.dataTransfer)||void 0===g?void 0:g.files)||[])if(await wa(v))break})},{once:!0})})()
